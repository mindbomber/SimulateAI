<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom Integration Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-section {
        background: white;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px;
        font-size: 16px;
      }
      .test-button:hover {
        background: #5a6fd8;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      #test-results {
        white-space: pre-line;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #6c757d;
      }
    </style>
  </head>
  <body>
    <h1>🧪 Classroom Integration Test</h1>

    <div class="test-section">
      <h2>Integration Status</h2>
      <div id="integration-status" class="status info">
        Checking integration status...
      </div>
      <button class="test-button" onclick="checkIntegrationStatus()">
        🔍 Check Status
      </button>
    </div>

    <div class="test-section">
      <h2>Button Tests</h2>
      <p>
        Test the classroom buttons to ensure they trigger the correct modals:
      </p>
      <button class="test-button" onclick="testCreateClassroom()">
        👨‍🏫 Test Create Classroom
      </button>
      <button class="test-button" onclick="testJoinClassroom()">
        🎓 Test Join Classroom
      </button>
      <button class="test-button" onclick="testWithClassroomCode()">
        🔗 Test with Code (ABC-123)
      </button>
    </div>

    <div class="test-section">
      <h2>URL Testing</h2>
      <p>Test URL-based classroom joining:</p>
      <button class="test-button" onclick="testURLJoin()">
        🌐 Test URL Join (?classroom=XYZ-789)
      </button>
      <button class="test-button" onclick="testURLJoinAlternate()">
        🌐 Test URL Join (?code=DEF-456)
      </button>
    </div>

    <div class="test-section">
      <h2>Authentication Test</h2>
      <button class="test-button" onclick="testAuthentication()">
        🔐 Test Auth Status
      </button>
      <button class="test-button" onclick="testUnauthenticatedFlow()">
        🚫 Test Unauthenticated Flow
      </button>
    </div>

    <div class="test-section">
      <h2>Test Results</h2>
      <div id="test-results">Click any test button above to see results...</div>
    </div>

    <script type="module">
      // Import the integration manager if available
      let integrationManager = null;

      window.checkIntegrationStatus = async function () {
        const status = document.getElementById("integration-status");
        const results = document.getElementById("test-results");

        try {
          // Check if integration manager is available
          integrationManager = window.classroomIntegrationManager;

          if (integrationManager) {
            status.className = "status success";
            status.textContent =
              "✅ Classroom Integration Manager found and initialized!";

            const isAvailable = integrationManager.isClassroomAvailable();
            const currentRole = integrationManager.getCurrentUserRole();

            results.textContent = `Integration Status: ✅ ACTIVE
Available: ${isAvailable ? "Yes" : "No"}
User Role: ${currentRole}
Teacher Modals: ${integrationManager.teacherModals ? "Loaded" : "Not Loaded"}
Student Modals: ${integrationManager.studentModals ? "Loaded" : "Not Loaded"}
Firebase Service: ${integrationManager.firebaseService ? "Available" : "Not Available"}
DataHandler: ${integrationManager.dataHandler ? "Available" : "Not Available"}`;
          } else {
            status.className = "status error";
            status.textContent =
              "❌ Classroom Integration Manager not found. Check if app.js initialized properly.";
            results.textContent =
              "Integration Status: ❌ NOT FOUND\n\nPossible issues:\n- app.js not fully loaded\n- Integration manager not initialized\n- Import/export errors";
          }
        } catch (error) {
          status.className = "status error";
          status.textContent = "❌ Error checking integration status";
          results.textContent = `Error: ${error.message}\n\nStack: ${error.stack}`;
        }
      };

      window.testCreateClassroom = function () {
        const results = document.getElementById("test-results");

        try {
          if (integrationManager) {
            integrationManager.handleCreateClassroom();
            results.textContent =
              "✅ Create Classroom button clicked successfully!\nModal should open if user is authenticated.";
          } else {
            results.textContent =
              '❌ Integration manager not available. Run "Check Status" first.';
          }
        } catch (error) {
          results.textContent = `❌ Error testing create classroom: ${error.message}`;
        }
      };

      window.testJoinClassroom = function () {
        const results = document.getElementById("test-results");

        try {
          if (integrationManager) {
            integrationManager.handleJoinClassroom();
            results.textContent =
              "✅ Join Classroom button clicked successfully!\nModal should open if user is authenticated.";
          } else {
            results.textContent =
              '❌ Integration manager not available. Run "Check Status" first.';
          }
        } catch (error) {
          results.textContent = `❌ Error testing join classroom: ${error.message}`;
        }
      };

      window.testWithClassroomCode = function () {
        const results = document.getElementById("test-results");

        try {
          // Simulate URL with classroom code
          window.history.replaceState({}, "", "?classroom=ABC-123");

          if (integrationManager) {
            integrationManager.handleJoinClassroom();
            results.textContent =
              "✅ Join with prefilled code (ABC-123) tested!\nModal should open with code pre-filled.";
          } else {
            results.textContent =
              '❌ Integration manager not available. Run "Check Status" first.';
          }
        } catch (error) {
          results.textContent = `❌ Error testing with classroom code: ${error.message}`;
        }
      };

      window.testURLJoin = function () {
        const results = document.getElementById("test-results");

        try {
          // Simulate URL join
          window.history.replaceState({}, "", "?classroom=XYZ-789");

          if (integrationManager) {
            integrationManager.handleURLClassroomJoin();
            results.textContent =
              "✅ URL-based join tested (XYZ-789)!\nCheck if join modal opened automatically.";
          } else {
            results.textContent =
              '❌ Integration manager not available. Run "Check Status" first.';
          }
        } catch (error) {
          results.textContent = `❌ Error testing URL join: ${error.message}`;
        }
      };

      window.testURLJoinAlternate = function () {
        const results = document.getElementById("test-results");

        try {
          // Test alternate URL parameter
          window.history.replaceState({}, "", "?code=DEF-456");

          if (integrationManager) {
            integrationManager.handleURLClassroomJoin();
            results.textContent =
              '✅ URL-based join tested with "code" parameter (DEF-456)!\nCheck if join modal opened automatically.';
          } else {
            results.textContent =
              '❌ Integration manager not available. Run "Check Status" first.';
          }
        } catch (error) {
          results.textContent = `❌ Error testing alternate URL join: ${error.message}`;
        }
      };

      window.testAuthentication = function () {
        const results = document.getElementById("test-results");

        try {
          if (integrationManager && integrationManager.firebaseService) {
            const currentUser = integrationManager.currentUser;
            results.textContent = `Authentication Status:
Current User: ${currentUser ? `✅ ${currentUser.displayName || currentUser.email || currentUser.uid}` : "❌ Not signed in"}
Firebase Service: ${integrationManager.firebaseService ? "✅ Available" : "❌ Not available"}

${!currentUser ? 'Try clicking "Create Classroom" or "Join Classroom" to test authentication flow.' : ""}`;
          } else {
            results.textContent =
              "❌ Authentication service not available. Check integration status.";
          }
        } catch (error) {
          results.textContent = `❌ Error checking authentication: ${error.message}`;
        }
      };

      window.testUnauthenticatedFlow = function () {
        const results = document.getElementById("test-results");

        try {
          // Temporarily clear current user to test unauthenticated flow
          if (integrationManager) {
            const originalUser = integrationManager.currentUser;
            integrationManager.currentUser = null;

            integrationManager.handleCreateClassroom();

            // Restore user
            integrationManager.currentUser = originalUser;

            results.textContent =
              "✅ Unauthenticated flow tested!\nShould prompt for sign-in before allowing classroom creation.";
          } else {
            results.textContent =
              '❌ Integration manager not available. Run "Check Status" first.';
          }
        } catch (error) {
          results.textContent = `❌ Error testing unauthenticated flow: ${error.message}`;
        }
      };

      // Auto-check status when page loads
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(checkIntegrationStatus, 1000);
      });
    </script>
  </body>
</html>
