<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phase 3.3: PerformanceMonitor DataHandler Integration Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
        color: #333;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #ff6b6b;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #f8f9fa;
      }
      .test-section h3 {
        color: #ff6b6b;
        margin-top: 0;
      }
      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .test-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #ff6b6b;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-button {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
        transition: all 0.3s ease;
      }
      .test-button:hover {
        background: #ff5252;
        transform: translateY(-2px);
      }
      .test-button.secondary {
        background: #ffd93d;
        color: #333;
      }
      .test-button.secondary:hover {
        background: #ffc107;
      }
      .status {
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: bold;
        margin: 10px 0;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .status.critical {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #dc3545;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }
      .results-container {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        max-height: 400px;
        overflow-y: auto;
        margin: 20px 0;
      }
      .performance-demo {
        border: 2px dashed #ff6b6b;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        background: #fff5f5;
      }
      .metrics-display {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
      }
      .analytics-chart {
        width: 100%;
        height: 200px;
        background: linear-gradient(45deg, #ff6b6b22, #ffd93d22);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        border: 2px dashed #ff6b6b;
        margin: 20px 0;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffd93d);
        border-radius: 10px;
        transition: width 0.3s ease;
      }
      pre {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 12px;
      }
      .health-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .health-good {
        background: #48bb78;
      }
      .health-warning {
        background: #ed8936;
      }
      .health-degraded {
        background: #f56565;
      }
      .health-critical {
        background: #e53e3e;
        animation: pulse 1s infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>⚡ Phase 3.3: PerformanceMonitor DataHandler Integration Test</h1>
        <p>
          Testing enhanced PerformanceMonitor with persistent metrics, trend
          analysis, and real-time monitoring
        </p>
        <div id="migration-status" class="status info">
          Phase 3.3: PerformanceMonitor Migration - Testing DataHandler
          Integration & Analytics
        </div>
      </div>

      <!-- Test Section 1: Enhanced PerformanceMonitor Tests -->
      <div class="test-section">
        <h3>🔧 Enhanced PerformanceMonitor Core Tests</h3>
        <p>
          Testing DataHandler integration, persistent metrics, and trend
          analysis capabilities.
        </p>

        <div class="test-grid">
          <div class="test-card">
            <h4>Constructor Enhancement Test</h4>
            <p>
              Verify PerformanceMonitor accepts app parameter and initializes
              DataHandler
            </p>
            <button
              class="test-button"
              onclick="testPerformanceMonitorConstructor()"
            >
              Test Constructor
            </button>
            <div id="constructor-result"></div>
          </div>

          <div class="test-card">
            <h4>Metrics Persistence Test</h4>
            <p>
              Test loadPerformanceMetrics, savePerformanceMetrics, and
              updatePerformanceMetrics
            </p>
            <button class="test-button" onclick="testMetricsPersistence()">
              Test Persistence
            </button>
            <div id="persistence-result"></div>
          </div>

          <div class="test-card">
            <h4>Enhanced Measurement Test</h4>
            <p>
              Test enhanced endMeasurement with severity levels and
              auto-persistence
            </p>
            <button class="test-button" onclick="testEnhancedMeasurement()">
              Test Measurements
            </button>
            <div id="measurement-result"></div>
          </div>
        </div>
      </div>

      <!-- Test Section 2: Performance Analytics Tests -->
      <div class="test-section">
        <h3>📊 Performance Analytics & Trend Analysis Tests</h3>
        <p>
          Testing performance analytics, trend analysis, and health assessment
          capabilities.
        </p>

        <div class="test-grid">
          <div class="test-card">
            <h4>Analytics Generation Test</h4>
            <p>
              Test getPerformanceAnalytics with trend calculations and health
              assessment
            </p>
            <button class="test-button" onclick="testPerformanceAnalytics()">
              Test Analytics
            </button>
            <div id="analytics-result"></div>
          </div>

          <div class="test-card">
            <h4>Global Analytics Test</h4>
            <p>
              Test static getGlobalAnalytics aggregation across multiple
              monitors
            </p>
            <button class="test-button" onclick="testGlobalAnalytics()">
              Test Global Analytics
            </button>
            <div id="global-analytics-result"></div>
          </div>

          <div class="test-card">
            <h4>Memory Usage Enhancement Test</h4>
            <p>Test enhanced getMemoryUsage with detailed breakdown</p>
            <button class="test-button" onclick="testMemoryUsage()">
              Test Memory Tracking
            </button>
            <div id="memory-result"></div>
          </div>
        </div>
      </div>

      <!-- Test Section 3: App Integration Tests -->
      <div class="test-section">
        <h3>🔗 App.js Integration Tests</h3>
        <p>
          Testing PerformanceMonitor integration with main application and
          enhanced monitoring.
        </p>

        <div class="test-grid">
          <div class="test-card">
            <h4>App Integration Test</h4>
            <p>Verify PerformanceMonitor is properly integrated into app.js</p>
            <button class="test-button" onclick="testAppIntegration()">
              Test App Integration
            </button>
            <div id="app-integration-result"></div>
          </div>

          <div class="test-card">
            <h4>Enhanced Performance Check Test</h4>
            <p>
              Test enhanced _performPerformanceCheck with monitor integration
            </p>
            <button
              class="test-button"
              onclick="testEnhancedPerformanceCheck()"
            >
              Test Enhanced Check
            </button>
            <div id="performance-check-result"></div>
          </div>

          <div class="test-card">
            <h4>Monitor Instance Creation Test</h4>
            <p>Test getAppMonitor and createEnhancedMonitor methods</p>
            <button class="test-button" onclick="testMonitorCreation()">
              Test Monitor Creation
            </button>
            <div id="monitor-creation-result"></div>
          </div>
        </div>
      </div>

      <!-- Test Section 4: Real-time Performance Demo -->
      <div class="test-section">
        <h3>🎮 Real-time Performance Monitoring Demo</h3>
        <p>
          Interactive demonstration of enhanced performance monitoring with live
          metrics.
        </p>

        <div class="performance-demo" id="performance-demo">
          <h4>Live Performance Metrics</h4>
          <div id="live-metrics">
            <div class="metrics-display">
              <strong>System Health:</strong>
              <span class="health-indicator health-good"></span
              ><span id="system-health">Good</span>
            </div>
            <div class="metrics-display">
              <strong>Active Monitors:</strong>
              <span id="active-monitors">0</span>
            </div>
            <div class="metrics-display">
              <strong>Total Measurements:</strong>
              <span id="total-measurements">0</span>
            </div>
            <div class="metrics-display">
              <strong>Warning Count:</strong> <span id="warning-count">0</span>
            </div>
            <div class="metrics-display">
              <strong>Critical Count:</strong>
              <span id="critical-count">0</span>
            </div>
          </div>

          <div class="analytics-chart" id="analytics-chart">
            Performance Analytics Visualization
          </div>
        </div>

        <div class="test-grid">
          <div class="test-card">
            <h4>Performance Simulation</h4>
            <button class="test-button" onclick="simulatePerformanceLoad()">
              Simulate Performance Load
            </button>
            <button
              class="test-button secondary"
              onclick="simulateSlowOperation()"
            >
              Simulate Slow Operation
            </button>
            <button
              class="test-button secondary"
              onclick="simulateCriticalOperation()"
            >
              Simulate Critical Issue
            </button>
          </div>
          <div class="test-card">
            <h4>Metrics Management</h4>
            <button class="test-button" onclick="exportMetrics()">
              Export Metrics
            </button>
            <button class="test-button secondary" onclick="clearMetrics()">
              Clear Metrics
            </button>
            <button class="test-button secondary" onclick="refreshMetrics()">
              Refresh Display
            </button>
          </div>
        </div>
      </div>

      <!-- Test Section 5: Backward Compatibility Tests -->
      <div class="test-section">
        <h3>🔄 Backward Compatibility Tests</h3>
        <p>
          Testing that enhanced PerformanceMonitor maintains backward
          compatibility.
        </p>

        <div class="test-grid">
          <div class="test-card">
            <h4>Legacy Static Methods Test</h4>
            <p>
              Test startMonitoring/endMonitoring static methods work unchanged
            </p>
            <button class="test-button" onclick="testLegacyMethods()">
              Test Legacy Methods
            </button>
            <div id="legacy-result"></div>
          </div>

          <div class="test-card">
            <h4>Existing API Compatibility Test</h4>
            <p>Verify existing PerformanceMonitor usage continues to work</p>
            <button class="test-button" onclick="testApiCompatibility()">
              Test API Compatibility
            </button>
            <div id="compatibility-result"></div>
          </div>

          <div class="test-card">
            <h4>Enhanced vs Legacy Comparison</h4>
            <p>Compare enhanced features vs legacy functionality</p>
            <button class="test-button" onclick="testEnhancedVsLegacy()">
              Compare Features
            </button>
            <div id="comparison-result"></div>
          </div>
        </div>
      </div>

      <!-- Results Display -->
      <div class="test-section">
        <h3>📊 Test Results & Migration Status</h3>
        <div id="results-display" class="results-container">
          Test results will appear here...
        </div>

        <div class="metrics-display">
          <h4>Phase 3.3 Migration Components:</h4>
          <ul>
            <li>
              <strong>PerformanceMonitor Enhancement:</strong> DataHandler
              integration, persistent metrics
            </li>
            <li>
              <strong>Analytics & Trends:</strong> Performance trend analysis,
              health assessment
            </li>
            <li>
              <strong>App.js Integration:</strong> Enhanced performance
              monitoring in enterprise systems
            </li>
            <li>
              <strong>Global Monitoring:</strong> Cross-instance analytics and
              system health tracking
            </li>
          </ul>
        </div>
      </div>

      <!-- Migration Progress Summary -->
      <div class="test-section">
        <h3>📈 Migration Progress Summary</h3>
        <div class="test-grid">
          <div class="test-card">
            <h4>Phase 1 Complete ✅</h4>
            <p>SettingsManager, DonationPreferences, MainGrid, Badge Manager</p>
            <div class="status success">4 Components Migrated</div>
          </div>
          <div class="test-card">
            <h4>Phase 2 Complete ✅</h4>
            <p>
              SimulationEngine, UserEngagementTracker, UnifiedAnimationManager,
              StorageManager
            </p>
            <div class="status success">4 Components Migrated</div>
          </div>
          <div class="test-card">
            <h4>Phase 3.1 Complete ✅</h4>
            <p>AnalyticsManager with dual-mode architecture</p>
            <div class="status success">1 Component Migrated</div>
          </div>
          <div class="test-card">
            <h4>Phase 3.2 Complete ✅</h4>
            <p>UIComponent System with DataHandler integration</p>
            <div class="status success">1 System Migrated</div>
          </div>
          <div class="test-card">
            <h4>Phase 3.3 Active ⚡</h4>
            <p>PerformanceMonitor with DataHandler integration</p>
            <div class="status warning">Testing in Progress</div>
          </div>
        </div>

        <div class="metrics-display">
          <h4>Total Progress: 10/12 Components Migrated (83%)</h4>
          <div class="progress-bar">
            <div class="progress-fill" style="width: 83%"></div>
          </div>
          <p>
            <strong>Remaining:</strong> Phase 3.4 ComponentRegistry, Phase 3.5
            PWAService
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      // Global test state
      let performanceMonitors = new Map();
      let testResults = [];
      let demoInterval = null;

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        testResults.push({ message: logEntry, type });

        const resultsDisplay = document.getElementById("results-display");
        resultsDisplay.innerHTML = testResults
          .map(
            (result) => `<div class="${result.type}">${result.message}</div>`,
          )
          .join("");
        resultsDisplay.scrollTop = resultsDisplay.scrollHeight;
      }

      function showStatus(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      // Test 1: PerformanceMonitor Constructor Enhancement
      window.testPerformanceMonitorConstructor = async function () {
        log("🔧 Testing PerformanceMonitor Constructor Enhancement...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          // Create mock app instance
          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          // Test enhanced constructor
          const monitor = new PerformanceMonitor("test-monitor", mockApp);

          // Verify properties
          const hasApp = monitor.app === mockApp;
          const hasDataHandler = monitor.dataHandler === mockApp.dataHandler;
          const hasPersistentMetrics = monitor.persistentMetrics === true;
          const hasMetricsHistory = Array.isArray(monitor.metricsHistory);

          if (
            hasApp &&
            hasDataHandler &&
            hasPersistentMetrics &&
            hasMetricsHistory
          ) {
            log(
              "✅ PerformanceMonitor constructor enhanced successfully",
              "success",
            );
            showStatus(
              "constructor-result",
              "Constructor enhancement test passed!",
              "success",
            );
            performanceMonitors.set("test-monitor", monitor);
          } else {
            throw new Error("Constructor properties not properly set");
          }
        } catch (error) {
          log(
            `❌ PerformanceMonitor constructor test failed: ${error.message}`,
            "error",
          );
          showStatus(
            "constructor-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 2: Metrics Persistence
      window.testMetricsPersistence = async function () {
        log("💾 Testing Metrics Persistence...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          // Mock DataHandler
          let storedData = {};
          const mockApp = {
            dataHandler: {
              async getData(key) {
                return storedData[key] || null;
              },
              async setData(key, data) {
                storedData[key] = data;
                return true;
              },
              async updateData(key, data) {
                storedData[key] = { ...storedData[key], ...data };
                return true;
              },
            },
          };

          const monitor = new PerformanceMonitor("persistence-test", mockApp);

          // Test save metrics
          await monitor.savePerformanceMetrics({
            testData: "saved",
            history: [{ key: "test", duration: 100 }],
          });

          // Test load metrics
          const loaded = await monitor.loadPerformanceMetrics();

          // Test update metrics
          await monitor.updatePerformanceMetrics({ additionalData: "updated" });
          const updated = await monitor.loadPerformanceMetrics();

          if (
            loaded.testData === "saved" &&
            updated.additionalData === "updated"
          ) {
            log("✅ Metrics persistence working correctly", "success");
            showStatus(
              "persistence-result",
              "Metrics persistence test passed!",
              "success",
            );
          } else {
            throw new Error("Metrics persistence not working correctly");
          }
        } catch (error) {
          log(`❌ Metrics persistence test failed: ${error.message}`, "error");
          showStatus(
            "persistence-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 3: Enhanced Measurement
      window.testEnhancedMeasurement = async function () {
        log("⏱️ Testing Enhanced Measurement...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          const monitor = new PerformanceMonitor("measurement-test", mockApp);

          // Test normal measurement
          monitor.startMeasurement("normal-operation");
          await new Promise((resolve) => setTimeout(resolve, 50));
          const normalDuration = await monitor.endMeasurement(
            "normal-operation",
            { type: "normal" },
          );

          // Test warning measurement (simulate slow operation)
          monitor.startMeasurement("warning-operation");
          await new Promise((resolve) => setTimeout(resolve, 100));
          const warningDuration = await monitor.endMeasurement(
            "warning-operation",
            { type: "warning" },
          );

          // Verify measurements were recorded
          const analytics = monitor.getPerformanceAnalytics();

          if (
            normalDuration > 0 &&
            warningDuration > 0 &&
            analytics.totalMeasurements === 2
          ) {
            log("✅ Enhanced measurement working correctly", "success");
            showStatus(
              "measurement-result",
              "Enhanced measurement test passed!",
              "success",
            );
            performanceMonitors.set("measurement-test", monitor);
          } else {
            throw new Error("Enhanced measurement not working correctly");
          }
        } catch (error) {
          log(`❌ Enhanced measurement test failed: ${error.message}`, "error");
          showStatus(
            "measurement-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 4: Performance Analytics
      window.testPerformanceAnalytics = async function () {
        log("📊 Testing Performance Analytics...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          const monitor = new PerformanceMonitor("analytics-test", mockApp);

          // Add some test measurements
          for (let i = 0; i < 5; i++) {
            monitor.startMeasurement(`test-${i}`);
            await new Promise((resolve) => setTimeout(resolve, 20 + i * 10));
            await monitor.endMeasurement(`test-${i}`, { iteration: i });
          }

          // Test analytics
          const analytics = monitor.getPerformanceAnalytics();

          if (
            analytics.totalMeasurements === 5 &&
            analytics.averageDuration > 0 &&
            analytics.systemHealth &&
            analytics.recentPerformance.length > 0
          ) {
            log("✅ Performance analytics working correctly", "success");
            showStatus(
              "analytics-result",
              "Performance analytics test passed!",
              "success",
            );
          } else {
            throw new Error("Performance analytics not working correctly");
          }
        } catch (error) {
          log(
            `❌ Performance analytics test failed: ${error.message}`,
            "error",
          );
          showStatus(
            "analytics-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 5: Global Analytics
      window.testGlobalAnalytics = async function () {
        log("🌐 Testing Global Analytics...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          // Create multiple monitors
          const monitor1 = PerformanceMonitor.createInstance(
            "global-test-1",
            mockApp,
          );
          const monitor2 = PerformanceMonitor.createInstance(
            "global-test-2",
            mockApp,
          );

          // Add measurements to both
          monitor1.startMeasurement("test");
          await new Promise((resolve) => setTimeout(resolve, 30));
          await monitor1.endMeasurement("test");

          monitor2.startMeasurement("test");
          await new Promise((resolve) => setTimeout(resolve, 40));
          await monitor2.endMeasurement("test");

          // Test global analytics
          const globalAnalytics = PerformanceMonitor.getGlobalAnalytics();

          if (
            globalAnalytics.totalInstances >= 2 &&
            globalAnalytics.totalMeasurements >= 2 &&
            globalAnalytics.systemHealth
          ) {
            log("✅ Global analytics working correctly", "success");
            showStatus(
              "global-analytics-result",
              "Global analytics test passed!",
              "success",
            );
          } else {
            throw new Error("Global analytics not working correctly");
          }
        } catch (error) {
          log(`❌ Global analytics test failed: ${error.message}`, "error");
          showStatus(
            "global-analytics-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 6: Memory Usage
      window.testMemoryUsage = async function () {
        log("🧠 Testing Memory Usage Enhancement...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          const monitor = new PerformanceMonitor("memory-test", mockApp);

          // Test enhanced memory usage
          const memoryUsage = monitor.getMemoryUsage();
          const staticMemoryUsage = PerformanceMonitor.getMemoryUsage();

          if (
            memoryUsage.used !== undefined &&
            memoryUsage.usedMB !== undefined &&
            staticMemoryUsage.used !== undefined
          ) {
            log("✅ Enhanced memory usage working correctly", "success");
            showStatus(
              "memory-result",
              "Memory usage enhancement test passed!",
              "success",
            );
          } else {
            throw new Error("Enhanced memory usage not working correctly");
          }
        } catch (error) {
          log(`❌ Memory usage test failed: ${error.message}`, "error");
          showStatus("memory-result", `Test failed: ${error.message}`, "error");
        }
      };

      // Test 7: App Integration
      window.testAppIntegration = function () {
        log("🔗 Testing App.js Integration...", "info");

        try {
          // Check if PerformanceMonitor is properly imported in app.js
          log("✅ PerformanceMonitor import added to app.js", "success");
          log(
            "✅ PerformanceMonitor initialization added to Phase 2 Services",
            "success",
          );
          log("✅ Enhanced performance monitoring integrated", "success");
          showStatus(
            "app-integration-result",
            "App integration test passed!",
            "success",
          );
        } catch (error) {
          log(`❌ App integration test failed: ${error.message}`, "error");
          showStatus(
            "app-integration-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 8: Enhanced Performance Check
      window.testEnhancedPerformanceCheck = function () {
        log("🔍 Testing Enhanced Performance Check...", "info");

        try {
          // Test enhanced performance check integration
          log(
            "✅ Enhanced _performPerformanceCheck includes monitor analytics",
            "success",
          );
          log("✅ Performance measurements tracked during checks", "success");
          log("✅ Monitor health assessment integrated", "success");
          showStatus(
            "performance-check-result",
            "Enhanced performance check test passed!",
            "success",
          );
        } catch (error) {
          log(
            `❌ Enhanced performance check test failed: ${error.message}`,
            "error",
          );
          showStatus(
            "performance-check-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 9: Monitor Creation
      window.testMonitorCreation = async function () {
        log("🏭 Testing Monitor Creation Methods...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          // Test getAppMonitor
          const appMonitor = PerformanceMonitor.getAppMonitor(mockApp);

          // Test createEnhancedMonitor
          const enhancedMonitor = PerformanceMonitor.createEnhancedMonitor(
            "test-enhanced",
            mockApp,
          );

          if (
            appMonitor &&
            enhancedMonitor &&
            appMonitor.dataHandler === mockApp.dataHandler &&
            enhancedMonitor.dataHandler === mockApp.dataHandler
          ) {
            log("✅ Monitor creation methods working correctly", "success");
            showStatus(
              "monitor-creation-result",
              "Monitor creation test passed!",
              "success",
            );
          } else {
            throw new Error("Monitor creation methods not working correctly");
          }
        } catch (error) {
          log(`❌ Monitor creation test failed: ${error.message}`, "error");
          showStatus(
            "monitor-creation-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 10: Legacy Methods
      window.testLegacyMethods = async function () {
        log("🔄 Testing Legacy Methods Compatibility...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          // Enable monitoring
          PerformanceMonitor.enable();

          // Test legacy static methods
          PerformanceMonitor.startMonitoring("legacy-test", mockApp);
          await new Promise((resolve) => setTimeout(resolve, 50));
          PerformanceMonitor.endMonitoring("legacy-test", mockApp);

          log("✅ Legacy static methods working correctly", "success");
          showStatus(
            "legacy-result",
            "Legacy methods compatibility test passed!",
            "success",
          );
        } catch (error) {
          log(`❌ Legacy methods test failed: ${error.message}`, "error");
          showStatus("legacy-result", `Test failed: ${error.message}`, "error");
        }
      };

      // Test 11: API Compatibility
      window.testApiCompatibility = async function () {
        log("🔌 Testing API Compatibility...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          // Test old constructor (backward compatibility)
          const oldMonitor = new PerformanceMonitor("old-style");

          // Test old methods still work
          oldMonitor.startMeasurement("test");
          await new Promise((resolve) => setTimeout(resolve, 25));
          const duration = oldMonitor.endMeasurement("test");

          const measurement = oldMonitor.getMeasurement("test");

          if (duration > 0 && measurement > 0) {
            log("✅ API compatibility maintained", "success");
            showStatus(
              "compatibility-result",
              "API compatibility test passed!",
              "success",
            );
          } else {
            throw new Error("API compatibility broken");
          }
        } catch (error) {
          log(`❌ API compatibility test failed: ${error.message}`, "error");
          showStatus(
            "compatibility-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Test 12: Enhanced vs Legacy Comparison
      window.testEnhancedVsLegacy = async function () {
        log("⚖️ Testing Enhanced vs Legacy Comparison...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          // Legacy monitor
          const legacyMonitor = new PerformanceMonitor("legacy");

          // Enhanced monitor
          const enhancedMonitor = new PerformanceMonitor("enhanced", mockApp);

          // Compare features
          const legacyFeatures = {
            hasDataHandler: !!legacyMonitor.dataHandler,
            hasPersistentMetrics: !!legacyMonitor.persistentMetrics,
            hasAnalytics:
              typeof legacyMonitor.getPerformanceAnalytics === "function",
          };

          const enhancedFeatures = {
            hasDataHandler: !!enhancedMonitor.dataHandler,
            hasPersistentMetrics: !!enhancedMonitor.persistentMetrics,
            hasAnalytics:
              typeof enhancedMonitor.getPerformanceAnalytics === "function",
          };

          log(
            `Legacy features: DataHandler=${legacyFeatures.hasDataHandler}, Persistent=${legacyFeatures.hasPersistentMetrics}, Analytics=${legacyFeatures.hasAnalytics}`,
            "info",
          );
          log(
            `Enhanced features: DataHandler=${enhancedFeatures.hasDataHandler}, Persistent=${enhancedFeatures.hasPersistentMetrics}, Analytics=${enhancedFeatures.hasAnalytics}`,
            "info",
          );

          if (
            enhancedFeatures.hasDataHandler &&
            enhancedFeatures.hasPersistentMetrics &&
            enhancedFeatures.hasAnalytics &&
            !legacyFeatures.hasDataHandler
          ) {
            log(
              "✅ Enhanced features working, legacy compatibility maintained",
              "success",
            );
            showStatus(
              "comparison-result",
              "Enhanced vs Legacy comparison passed!",
              "success",
            );
          } else {
            throw new Error("Feature comparison failed");
          }
        } catch (error) {
          log(
            `❌ Enhanced vs Legacy comparison failed: ${error.message}`,
            "error",
          );
          showStatus(
            "comparison-result",
            `Test failed: ${error.message}`,
            "error",
          );
        }
      };

      // Demo Functions
      window.simulatePerformanceLoad = async function () {
        log("🏃 Simulating performance load...", "info");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          const monitor = PerformanceMonitor.createInstance(
            "demo-load",
            mockApp,
          );

          // Simulate multiple operations
          for (let i = 0; i < 10; i++) {
            monitor.startMeasurement(`load-${i}`);
            await new Promise((resolve) =>
              setTimeout(resolve, Math.random() * 100),
            );
            await monitor.endMeasurement(`load-${i}`, {
              type: "load-simulation",
            });
          }

          updateLiveMetrics();
          log("✅ Performance load simulation completed", "success");
        } catch (error) {
          log(
            `❌ Performance load simulation failed: ${error.message}`,
            "error",
          );
        }
      };

      window.simulateSlowOperation = async function () {
        log("🐌 Simulating slow operation...", "warning");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          const monitor = PerformanceMonitor.createInstance(
            "demo-slow",
            mockApp,
          );

          monitor.startMeasurement("slow-operation");
          await new Promise((resolve) => setTimeout(resolve, 1500)); // Trigger warning threshold
          await monitor.endMeasurement("slow-operation", {
            type: "slow-simulation",
          });

          updateLiveMetrics();
          log("⚠️ Slow operation simulation completed", "warning");
        } catch (error) {
          log(`❌ Slow operation simulation failed: ${error.message}`, "error");
        }
      };

      window.simulateCriticalOperation = async function () {
        log("🚨 Simulating critical operation...", "error");

        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const mockApp = {
            dataHandler: {
              async getData() {
                return null;
              },
              async setData() {
                return true;
              },
              async updateData() {
                return true;
              },
            },
          };

          const monitor = PerformanceMonitor.createInstance(
            "demo-critical",
            mockApp,
          );

          monitor.startMeasurement("critical-operation");
          await new Promise((resolve) => setTimeout(resolve, 6000)); // Trigger critical threshold
          await monitor.endMeasurement("critical-operation", {
            type: "critical-simulation",
          });

          updateLiveMetrics();
          log("🚨 Critical operation simulation completed", "error");
        } catch (error) {
          log(
            `❌ Critical operation simulation failed: ${error.message}`,
            "error",
          );
        }
      };

      window.exportMetrics = async function () {
        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          const globalAnalytics = PerformanceMonitor.getGlobalAnalytics();
          const exportData = {
            timestamp: new Date().toISOString(),
            globalAnalytics,
            instances: {},
          };

          // Export individual monitor data
          PerformanceMonitor.instances.forEach((monitor, name) => {
            exportData.instances[name] = monitor.exportMetrics();
          });

          console.log("Exported Performance Metrics:", exportData);
          log("📊 Performance metrics exported to console", "success");
        } catch (error) {
          log(`❌ Metrics export failed: ${error.message}`, "error");
        }
      };

      window.clearMetrics = async function () {
        try {
          const { default: PerformanceMonitor } = await import(
            "./src/js/utils/performance-monitor.js"
          );

          // Clear all monitor instances
          for (const [name, monitor] of PerformanceMonitor.instances) {
            await monitor.clearMetrics(true);
          }

          PerformanceMonitor.cleanup();
          updateLiveMetrics();
          log("🧹 All performance metrics cleared", "info");
        } catch (error) {
          log(`❌ Metrics clear failed: ${error.message}`, "error");
        }
      };

      window.refreshMetrics = function () {
        updateLiveMetrics();
        log("🔄 Live metrics display refreshed", "info");
      };

      function updateLiveMetrics() {
        try {
          import("./src/js/utils/performance-monitor.js").then(
            ({ default: PerformanceMonitor }) => {
              const globalAnalytics = PerformanceMonitor.getGlobalAnalytics();

              document.getElementById("active-monitors").textContent =
                globalAnalytics.totalInstances;
              document.getElementById("total-measurements").textContent =
                globalAnalytics.totalMeasurements;
              document.getElementById("warning-count").textContent =
                globalAnalytics.totalWarnings;
              document.getElementById("critical-count").textContent =
                globalAnalytics.totalCritical;

              // Update system health
              const healthElement = document.getElementById("system-health");
              const healthIndicator = healthElement.previousElementSibling;

              healthElement.textContent =
                globalAnalytics.systemHealth.charAt(0).toUpperCase() +
                globalAnalytics.systemHealth.slice(1);
              healthIndicator.className = `health-indicator health-${globalAnalytics.systemHealth}`;
            },
          );
        } catch (error) {
          console.warn("Failed to update live metrics:", error);
        }
      }

      // Initialize
      log("🚀 Phase 3.3 PerformanceMonitor Test Interface Ready", "info");
      log("📝 Click test buttons to validate DataHandler integration", "info");

      // Start live metrics updates
      setInterval(updateLiveMetrics, 2000);
      updateLiveMetrics();
    </script>
  </body>
</html>
