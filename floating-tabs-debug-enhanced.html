<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Floating Tabs Debug</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f8fafc;
      }
      .debug-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow:
          0 4px 6px rgba(0, 0, 0, 0.05),
          0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }
      .status-card {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #e2e8f0;
      }
      .status-card.success {
        border-left-color: #10b981;
      }
      .status-card.error {
        border-left-color: #ef4444;
      }
      .status-card.warning {
        border-left-color: #f59e0b;
      }
      .debug-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        transition: all 0.2s ease;
      }
      .debug-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      .clear-button {
        background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
      }
      .log-output {
        background: #1a202c;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 13px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin: 10px 0;
      }
      .toggle-demo {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
        padding: 10px;
        background: #f1f5f9;
        border-radius: 6px;
      }
      .toggle-slider-demo {
        position: relative;
        width: 44px;
        height: 24px;
        background: #e0e0e0;
        border-radius: 24px;
        transition: background-color 0.3s ease;
        cursor: pointer;
      }
      .toggle-slider-demo::before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .toggle-slider-demo.checked {
        background: #1a73e8;
      }
      .toggle-slider-demo.checked::before {
        transform: translateX(20px);
      }
    </style>
  </head>
  <body>
    <div class="debug-container">
      <h1>üîß Enhanced Floating Tabs Debug Tool</h1>
      <p>
        This tool helps diagnose floating tabs toggle issues, especially after
        clearing browser data.
      </p>

      <div class="status-grid">
        <div class="status-card" id="settings-status">
          <h3>‚öôÔ∏è Settings Manager</h3>
          <div id="settings-info">Checking...</div>
        </div>
        <div class="status-card" id="tabs-status">
          <h3>üì± Floating Tabs</h3>
          <div id="tabs-info">Checking...</div>
        </div>
        <div class="status-card" id="donor-status">
          <h3>üíé Donor Status</h3>
          <div id="donor-info">Checking...</div>
        </div>
      </div>

      <div class="debug-container">
        <h3>üéØ Test Scenarios</h3>
        <button class="debug-button" onclick="testFreshBrowserScenario()">
          üßπ Test Fresh Browser (Clear All)
        </button>
        <button class="debug-button" onclick="testToggleAllOff()">
          ‚¨ÖÔ∏è Toggle All Tabs Off
        </button>
        <button class="debug-button" onclick="testToggleAllOn()">
          ‚û°Ô∏è Toggle All Tabs On
        </button>
        <button class="debug-button" onclick="testDonorScenario()">
          üíé Test Donor Scenario
        </button>
        <button class="debug-button clear-button" onclick="clearAllData()">
          üóëÔ∏è Clear All Data
        </button>
      </div>

      <div class="debug-container">
        <h3>üìä Current Settings Values</h3>
        <div id="settings-values">Loading...</div>
      </div>

      <div class="debug-container">
        <h3>üëÅÔ∏è Visual Toggle States</h3>
        <div class="toggle-demo">
          <span>Surprise Tab:</span>
          <div class="toggle-slider-demo" id="surprise-demo"></div>
          <span id="surprise-state">OFF</span>
        </div>
        <div class="toggle-demo">
          <span>Tour Tab:</span>
          <div class="toggle-slider-demo" id="tour-demo"></div>
          <span id="tour-state">OFF</span>
        </div>
        <div class="toggle-demo">
          <span>Donation Tab:</span>
          <div class="toggle-slider-demo" id="donate-demo"></div>
          <span id="donate-state">OFF</span>
        </div>
      </div>

      <div class="debug-container">
        <h3>üìù Debug Log</h3>
        <button class="debug-button" onclick="clearLog()">Clear Log</button>
        <div class="log-output" id="debug-log"></div>
      </div>
    </div>

    <!-- Load all required components -->
    <script type="module" src="src/js/components/settings-manager.js"></script>
    <script type="module" src="src/js/utils/donation-tracker.js"></script>
    <script
      type="module"
      src="src/js/components/floating-action-tab.js"
    ></script>
    <script
      type="module"
      src="src/js/components/floating-surprise-tab.js"
    ></script>
    <script type="module" src="src/js/components/floating-tour-tab.js"></script>

    <script>
      let debugLog = [];

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
        debugLog.push(logEntry);
        updateLogDisplay();
        console.log(logEntry);
      }

      function updateLogDisplay() {
        document.getElementById("debug-log").textContent = debugLog
          .slice(-50)
          .join("\n");
      }

      function clearLog() {
        debugLog = [];
        updateLogDisplay();
      }

      // Monitor settings changes
      window.addEventListener("settingsChanged", (e) => {
        log("Settings changed event received");
        log(`Settings: ${JSON.stringify(e.detail.settings, null, 2)}`);
        updateStatus();
      });

      window.addEventListener("settingsManagerReady", (e) => {
        log("Settings manager ready event received");
        log(`Settings: ${JSON.stringify(e.detail.settings, null, 2)}`);
        updateStatus();
      });

      function updateStatus() {
        updateSettingsStatus();
        updateTabsStatus();
        updateDonorStatus();
        updateSettingsValues();
        updateToggleStates();
      }

      function updateSettingsStatus() {
        const statusCard = document.getElementById("settings-status");
        const infoDiv = document.getElementById("settings-info");

        if (window.settingsManager) {
          statusCard.className = "status-card success";
          infoDiv.innerHTML = `
                    ‚úÖ Loaded<br>
                    Initialized: ${window.settingsManager.isInitialized}<br>
                    Has Schema: ${!!window.settingsManager.settingsSchema}
                `;
        } else {
          statusCard.className = "status-card error";
          infoDiv.innerHTML = "‚ùå Not loaded";
        }
      }

      function updateTabsStatus() {
        const statusCard = document.getElementById("tabs-status");
        const infoDiv = document.getElementById("tabs-info");

        const donateTab = document.querySelector(
          ".floating-tab-link, .floating-action-tab-link",
        );
        const surpriseTab = document.querySelector(
          ".floating-surprise-tab-link",
        );
        const tourTab = document.querySelector(".floating-tour-tab-link");

        const tabsFound = [donateTab, surpriseTab, tourTab].filter(
          Boolean,
        ).length;

        if (tabsFound === 3) {
          statusCard.className = "status-card success";
          infoDiv.innerHTML = `
                    ‚úÖ All 3 tabs found<br>
                    Donate: ${donateTab && donateTab.style.display !== "none" ? "Visible" : "Hidden"}<br>
                    Surprise: ${surpriseTab && surpriseTab.style.display !== "none" ? "Visible" : "Hidden"}<br>
                    Tour: ${tourTab && tourTab.style.display !== "none" ? "Visible" : "Hidden"}
                `;
        } else {
          statusCard.className = "status-card error";
          infoDiv.innerHTML = `‚ùå Only ${tabsFound}/3 tabs found`;
        }
      }

      function updateDonorStatus() {
        const statusCard = document.getElementById("donor-status");
        const infoDiv = document.getElementById("donor-info");

        if (window.settingsManager) {
          const isDonor = window.settingsManager.isDonor;
          statusCard.className = `status-card ${isDonor ? "success" : "warning"}`;
          infoDiv.innerHTML = `
                    ${isDonor ? "üíé Donor" : "üë§ Non-Donor"}<br>
                    Can disable donation tab: ${isDonor ? "Yes" : "No"}
                `;
        } else {
          statusCard.className = "status-card error";
          infoDiv.innerHTML = "‚ùå Unknown";
        }
      }

      function updateSettingsValues() {
        const div = document.getElementById("settings-values");

        if (window.settingsManager) {
          const surprise =
            window.settingsManager.getSetting("surpriseTabEnabled");
          const tour = window.settingsManager.getSetting("tourTabEnabled");
          const donate = window.settingsManager.getSetting("donateTabEnabled");

          div.innerHTML = `
                    <strong>Resolved Settings (using getSetting):</strong><br>
                    surpriseTabEnabled: ${surprise}<br>
                    tourTabEnabled: ${tour}<br>
                    donateTabEnabled: ${donate}<br><br>
                    <strong>Raw Settings Object:</strong><br>
                    surpriseTabEnabled: ${window.settingsManager.settings.surpriseTabEnabled}<br>
                    tourTabEnabled: ${window.settingsManager.settings.tourTabEnabled}<br>
                    donateTabEnabled: ${window.settingsManager.settings.donateTabEnabled}
                `;
        } else {
          div.innerHTML = "Settings manager not available";
        }
      }

      function updateToggleStates() {
        if (!window.settingsManager) return;

        const surprise =
          window.settingsManager.getSetting("surpriseTabEnabled");
        const tour = window.settingsManager.getSetting("tourTabEnabled");
        const donate = window.settingsManager.getSetting("donateTabEnabled");

        updateToggleDemo("surprise", surprise);
        updateToggleDemo("tour", tour);
        updateToggleDemo("donate", donate);
      }

      function updateToggleDemo(type, enabled) {
        const demo = document.getElementById(`${type}-demo`);
        const state = document.getElementById(`${type}-state`);

        if (enabled) {
          demo.classList.add("checked");
          state.textContent = "ON";
          state.style.color = "#10b981";
        } else {
          demo.classList.remove("checked");
          state.textContent = "OFF";
          state.style.color = "#ef4444";
        }
      }

      // Test functions
      function testFreshBrowserScenario() {
        log("=== TESTING FRESH BROWSER SCENARIO ===");

        // Clear all localStorage
        localStorage.clear();
        log("Cleared localStorage");

        // Reload settings manager
        if (window.settingsManager) {
          log("Reloading settings manager...");
          window.location.reload();
        } else {
          log("Settings manager not available for reload test");
        }
      }

      function testToggleAllOff() {
        log("=== TESTING TOGGLE ALL OFF ===");
        if (window.settingsManager) {
          window.settingsManager.setSetting("surpriseTabEnabled", false);
          window.settingsManager.setSetting("tourTabEnabled", false);
          // Note: donation tab should not allow toggling off for non-donors
          if (window.settingsManager.isDonor) {
            window.settingsManager.setSetting("donateTabEnabled", false);
            log("Toggled all tabs off (including donation tab - donor mode)");
          } else {
            log(
              "Toggled surprise and tour tabs off (donation tab restricted for non-donors)",
            );
          }
        }
      }

      function testToggleAllOn() {
        log("=== TESTING TOGGLE ALL ON ===");
        if (window.settingsManager) {
          window.settingsManager.setSetting("surpriseTabEnabled", true);
          window.settingsManager.setSetting("tourTabEnabled", true);
          window.settingsManager.setSetting("donateTabEnabled", true);
          log("Toggled all tabs on");
        }
      }

      function testDonorScenario() {
        log("=== TESTING DONOR SCENARIO ===");
        if (window.DonationTracker) {
          window.DonationTracker.simulateDonation();
          log(
            "Simulated donation - user should now be able to toggle donation tab",
          );
          setTimeout(updateStatus, 1000);
        }
      }

      function clearAllData() {
        log("=== CLEARING ALL DATA ===");
        localStorage.clear();
        sessionStorage.clear();

        // Clear IndexedDB if available
        if (window.indexedDB) {
          log("Clearing IndexedDB...");
        }

        log("All data cleared - page will reload");
        setTimeout(() => window.location.reload(), 1000);
      }

      // Initialize after a short delay
      setTimeout(() => {
        log("Debug tool initialized");
        updateStatus();

        // Set up periodic status updates
        setInterval(updateStatus, 2000);
      }, 1000);
    </script>
  </body>
</html>
