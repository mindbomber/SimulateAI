<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Fallback Mode Test - SimulateAI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      .info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .console-output {
        background: #1a1a1a;
        color: #00ff00;
        font-family: "Courier New", monospace;
        padding: 15px;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1>Firebase Fallback Mode Test</h1>
      <p class="text-muted">
        Testing the fixed Firebase Realtime Database fallback functionality
      </p>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Test Controls</h5>
            </div>
            <div class="card-body">
              <button id="test-service-init" class="btn btn-primary mb-2">
                Test Service Initialization
              </button>
              <button id="test-classroom-creation" class="btn btn-success mb-2">
                Test Classroom Creation
              </button>
              <button id="test-fallback-mode" class="btn btn-warning mb-2">
                Force Fallback Mode Test
              </button>
              <button id="clear-console" class="btn btn-secondary mb-2">
                Clear Console
              </button>

              <hr />

              <h6>Quick Classroom Creation Test:</h6>
              <div class="mb-3">
                <label for="classroom-name" class="form-label"
                  >Classroom Name:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="classroom-name"
                  value="Test Classroom"
                />
              </div>
              <button id="quick-create" class="btn btn-info">
                Quick Create Classroom
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Test Results</h5>
            </div>
            <div class="card-body">
              <div id="test-results">
                <!-- Test results will appear here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Console Output</h5>
            </div>
            <div class="card-body">
              <div id="console-output" class="console-output">
                === Firebase Fallback Test Console === Waiting for test
                execution...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
      import DataHandler from "./src/js/core/data-handler.js";
      import { FirebaseService } from "./src/js/services/firebase-service.js";
      import RealtimeClassroomService from "./src/js/services/realtime-classroom-service.js";
      import logger from "./src/js/utils/logger.js";

      let services = {
        firebaseService: null,
        dataHandler: null,
        classroomService: null,
      };

      // Console output management
      function addConsoleOutput(message, type = "info") {
        const console = document.getElementById("console-output");
        const timestamp = new Date().toLocaleTimeString();
        const line = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
        console.textContent += "\n" + line;
        console.scrollTop = console.scrollHeight;
      }

      function addTestResult(message, type) {
        const resultsDiv = document.getElementById("test-results");
        const result = document.createElement("div");
        result.className = `test-result ${type}`;
        result.textContent = message;
        resultsDiv.appendChild(result);
      }

      // Test 1: Service Initialization
      async function testServiceInitialization() {
        addConsoleOutput("Starting service initialization test...");
        addTestResult("Testing service initialization...", "info");

        try {
          // Initialize Firebase service
          addConsoleOutput("Initializing Firebase service...");
          services.firebaseService = new FirebaseService();
          await services.firebaseService.initialize({
            enableOffline: true,
            enablePersistence: false,
          });

          addConsoleOutput("Firebase service initialized");

          // Initialize DataHandler
          addConsoleOutput("Initializing DataHandler...");
          services.dataHandler = new DataHandler({
            appName: "SimulateAI",
            version: "1.80",
            firebaseService: services.firebaseService,
            enableCaching: true,
          });

          await services.dataHandler.initialize();
          addConsoleOutput("DataHandler initialized");

          // Initialize RealtimeClassroomService
          addConsoleOutput("Initializing RealtimeClassroomService...");
          services.classroomService = new RealtimeClassroomService(
            services.firebaseService,
          );

          // Wait a moment for database initialization
          await new Promise((resolve) => setTimeout(resolve, 1000));

          addConsoleOutput(
            `Classroom service initialized - Fallback mode: ${services.classroomService.fallbackMode}`,
          );
          addConsoleOutput(
            `Database connected: ${services.classroomService.isConnected}`,
          );

          addTestResult("âœ… Service initialization successful", "success");
          addTestResult(
            `Fallback mode: ${services.classroomService.fallbackMode}`,
            services.classroomService.fallbackMode ? "warning" : "success",
          );

          return true;
        } catch (error) {
          addConsoleOutput(
            `Service initialization failed: ${error.message}`,
            "error",
          );
          addTestResult(
            `âŒ Service initialization failed: ${error.message}`,
            "error",
          );
          return false;
        }
      }

      // Test 2: Classroom Creation
      async function testClassroomCreation() {
        if (!services.classroomService) {
          addTestResult("âŒ Classroom service not initialized", "error");
          return false;
        }

        addConsoleOutput("Starting classroom creation test...");
        addTestResult("Testing classroom creation...", "info");

        try {
          const classroomData = {
            classroomName: "Fallback Test Classroom",
            instructorId: "test_instructor_" + Date.now(),
            instructorName: "Test Instructor",
            selectedScenarios: [
              { id: "scenario1", title: "Test Scenario 1" },
              { id: "scenario2", title: "Test Scenario 2" },
            ],
          };

          addConsoleOutput("Creating classroom with data:", "info");
          addConsoleOutput(JSON.stringify(classroomData, null, 2));

          const result =
            await services.classroomService.createClassroom(classroomData);

          addConsoleOutput("Classroom creation successful!");
          addConsoleOutput(`Classroom code: ${result.classroomCode}`);
          addConsoleOutput(`Classroom ID: ${result.classroomId}`);

          addTestResult(
            `âœ… Classroom created successfully - Code: ${result.classroomCode}`,
            "success",
          );

          return result;
        } catch (error) {
          addConsoleOutput(
            `Classroom creation failed: ${error.message}`,
            "error",
          );
          addTestResult(
            `âŒ Classroom creation failed: ${error.message}`,
            "error",
          );
          return false;
        }
      }

      // Test 3: Force Fallback Mode
      async function testFallbackMode() {
        addConsoleOutput("Testing fallback mode enforcement...");
        addTestResult("Testing fallback mode...", "info");

        try {
          // Create a new classroom service with no Firebase
          const fallbackService = new RealtimeClassroomService(null);

          // Wait for initialization
          await new Promise((resolve) => setTimeout(resolve, 500));

          addConsoleOutput(
            `Forced fallback mode: ${fallbackService.fallbackMode}`,
          );
          addConsoleOutput(`Service connected: ${fallbackService.isConnected}`);

          if (fallbackService.fallbackMode) {
            addTestResult("âœ… Fallback mode correctly enforced", "success");

            // Try to create a classroom in fallback mode
            const classroomData = {
              classroomName: "Fallback Only Test",
              instructorId: "fallback_instructor",
              instructorName: "Fallback Instructor",
              selectedScenarios: [],
            };

            const result = await fallbackService.createClassroom(classroomData);
            addTestResult(
              `âœ… Fallback classroom created - Code: ${result.classroomCode}`,
              "success",
            );
            addConsoleOutput(
              `Fallback classroom created: ${result.classroomCode}`,
            );
          } else {
            addTestResult("âŒ Fallback mode not properly enforced", "error");
          }

          return true;
        } catch (error) {
          addConsoleOutput(`Fallback test failed: ${error.message}`, "error");
          addTestResult(`âŒ Fallback test failed: ${error.message}`, "error");
          return false;
        }
      }

      // Quick classroom creation
      async function quickCreateClassroom() {
        const classroomName =
          document.getElementById("classroom-name").value || "Test Classroom";

        if (!services.classroomService) {
          const success = await testServiceInitialization();
          if (!success) {
            addTestResult(
              "âŒ Cannot create classroom - service initialization failed",
              "error",
            );
            return;
          }
        }

        addConsoleOutput(`Creating classroom: ${classroomName}`);

        const classroomData = {
          classroomName: classroomName,
          instructorId: "guest_instructor_" + Date.now(),
          instructorName: "Guest Instructor",
          selectedScenarios: [
            { id: "ethics-101", title: "Ethics 101", category: "ethics" },
            {
              id: "privacy-basics",
              title: "Privacy Basics",
              category: "privacy",
            },
          ],
        };

        try {
          const result =
            await services.classroomService.createClassroom(classroomData);
          addTestResult(
            `ðŸŽ‰ Classroom "${classroomName}" created - Code: ${result.classroomCode}`,
            "success",
          );
          addConsoleOutput(`Success! Classroom code: ${result.classroomCode}`);

          // Show storage info
          if (services.classroomService.fallbackMode) {
            addConsoleOutput("Stored in localStorage (fallback mode)");
          } else {
            addConsoleOutput("Stored in Firebase Realtime Database");
          }
        } catch (error) {
          addTestResult(
            `âŒ Failed to create classroom: ${error.message}`,
            "error",
          );
          addConsoleOutput(`Error: ${error.message}`, "error");
        }
      }

      // Event listeners
      document
        .getElementById("test-service-init")
        .addEventListener("click", testServiceInitialization);
      document
        .getElementById("test-classroom-creation")
        .addEventListener("click", testClassroomCreation);
      document
        .getElementById("test-fallback-mode")
        .addEventListener("click", testFallbackMode);
      document
        .getElementById("quick-create")
        .addEventListener("click", quickCreateClassroom);

      document.getElementById("clear-console").addEventListener("click", () => {
        document.getElementById("console-output").textContent =
          "=== Firebase Fallback Test Console ===\nConsole cleared...";
        document.getElementById("test-results").innerHTML = "";
      });

      // Auto-initialize on page load
      addConsoleOutput("Page loaded - ready for testing");
      addTestResult('Click "Test Service Initialization" to begin', "info");
    </script>
  </body>
</html>
