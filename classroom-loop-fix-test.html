<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom Loop Fix Test - SimulateAI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .debug-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        z-index: 10000;
        max-width: 400px;
      }
      .log-entry {
        margin: 2px 0;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .log-entry.info {
        background: rgba(0, 100, 255, 0.3);
      }
      .log-entry.warning {
        background: rgba(255, 150, 0, 0.3);
      }
      .log-entry.error {
        background: rgba(255, 0, 0, 0.3);
      }
      .log-entry.success {
        background: rgba(0, 255, 0, 0.3);
      }

      .test-controls {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container-fluid">
      <h1 class="mt-4">Classroom Infinite Loop Fix Test</h1>
      <p class="text-muted">
        Testing the fix for infinite DOM update loops in classroom modals
      </p>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Test Controls</h5>
            </div>
            <div class="card-body">
              <button id="start-test" class="btn btn-primary me-2">
                Start Loop Fix Test
              </button>
              <button id="trigger-classroom" class="btn btn-success me-2">
                Open Classroom Modal
              </button>
              <button id="stress-test" class="btn btn-warning">
                Stress Test (Rapid Clicks)
              </button>

              <hr />

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="monitor-mutations"
                  checked
                />
                <label class="form-check-label" for="monitor-mutations">
                  Monitor DOM Mutations
                </label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="track-events"
                  checked
                />
                <label class="form-check-label" for="track-events">
                  Track Event Listeners
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Test Results</h5>
            </div>
            <div class="card-body">
              <div id="test-results">
                <p class="text-muted">
                  Click "Start Loop Fix Test" to begin testing...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel">
      <div class="fw-bold mb-2">ðŸ”§ Debug Monitor</div>
      <div>
        <span class="text-info">DOM Mutations:</span>
        <span id="mutation-count">0</span>
      </div>
      <div>
        <span class="text-warning">Event Attachments:</span>
        <span id="event-count">0</span>
      </div>
      <div>
        <span class="text-danger">Loop Warnings:</span>
        <span id="loop-count">0</span>
      </div>
      <div class="mt-2">
        <div id="debug-log" style="max-height: 200px; overflow-y: auto"></div>
      </div>
    </div>

    <!-- Test Controls -->
    <div class="test-controls">
      <div class="fw-bold mb-2">ðŸš€ Quick Actions</div>
      <button id="clear-log" class="btn btn-sm btn-secondary me-1">
        Clear Log
      </button>
      <button id="export-results" class="btn btn-sm btn-info me-1">
        Export Results
      </button>
      <button id="reset-test" class="btn btn-sm btn-danger">Reset Test</button>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SimulateAI Core -->
    <script type="module">
      import DataHandler from "./src/js/core/data-handler.js";
      import { FirebaseService } from "./src/js/services/firebase-service.js";
      import TeacherClassroomModals from "./src/js/components/teacher-classroom-modals.js";
      import logger from "./src/js/utils/logger.js";

      // Global test state
      let testState = {
        mutationCount: 0,
        eventCount: 0,
        loopCount: 0,
        testStartTime: null,
        mutations: [],
        events: [],
        loopWarnings: [],
      };

      let teacherModals = null;
      let mutationObserver = null;

      // DOM monitoring
      function setupDOMMonitoring() {
        const mutationTarget = document.body;

        mutationObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            testState.mutationCount++;
            testState.mutations.push({
              type: mutation.type,
              target: mutation.target.tagName || "Unknown",
              time: Date.now(),
            });

            // Check for potential infinite loops
            if (
              mutation.type === "attributes" &&
              mutation.target.classList?.contains("btn-primary")
            ) {
              testState.loopCount++;
              testState.loopWarnings.push({
                element: mutation.target.className,
                attribute: mutation.attributeName,
                time: Date.now(),
              });

              addDebugLog(
                "warning",
                `Potential loop: ${mutation.attributeName} on ${mutation.target.className}`,
              );
            }

            updateDebugCounters();
          });
        });

        mutationObserver.observe(mutationTarget, {
          attributes: true,
          childList: true,
          subtree: true,
          attributeOldValue: true,
        });
      }

      // Debug logging
      function addDebugLog(type, message) {
        const debugLog = document.getElementById("debug-log");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        debugLog.appendChild(entry);
        debugLog.scrollTop = debugLog.scrollHeight;

        // Keep only last 50 entries
        while (debugLog.children.length > 50) {
          debugLog.removeChild(debugLog.firstChild);
        }
      }

      function updateDebugCounters() {
        document.getElementById("mutation-count").textContent =
          testState.mutationCount;
        document.getElementById("event-count").textContent =
          testState.eventCount;
        document.getElementById("loop-count").textContent = testState.loopCount;
      }

      // Initialize services
      async function initializeServices() {
        addDebugLog("info", "Initializing services...");

        try {
          // Initialize Firebase service
          const firebaseService = new FirebaseService();
          await firebaseService.initialize({
            enableOffline: true,
            enablePersistence: false,
          });

          // Initialize DataHandler
          const dataHandler = new DataHandler({
            appName: "SimulateAI",
            version: "1.80",
            firebaseService: firebaseService,
            enableCaching: true,
          });

          await dataHandler.initialize();

          // Initialize TeacherClassroomModals with BOTH required parameters
          teacherModals = new TeacherClassroomModals(
            dataHandler,
            firebaseService,
          );
          await teacherModals.initialize(true); // Guest mode

          addDebugLog("success", "All services initialized successfully");
          return true;
        } catch (error) {
          addDebugLog(
            "error",
            `Service initialization failed: ${error.message}`,
          );
          logger.error("LoopFixTest", "Service initialization failed", error);
          return false;
        }
      }

      // Start the loop fix test
      async function startLoopFixTest() {
        addDebugLog("info", "Starting loop fix test...");
        testState.testStartTime = Date.now();

        if (!teacherModals) {
          const success = await initializeServices();
          if (!success) {
            addDebugLog(
              "error",
              "Cannot start test - service initialization failed",
            );
            return;
          }
        }

        setupDOMMonitoring();
        addDebugLog("success", "Loop fix test started - DOM monitoring active");

        // Update test results
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>Test Status:</strong> Loop fix test is running<br>
                    <strong>Start Time:</strong> ${new Date().toLocaleTimeString()}<br>
                    <strong>Monitoring:</strong> DOM mutations and event listeners
                </div>
                <div class="mt-3">
                    <h6>Test Instructions:</h6>
                    <ol>
                        <li>Click "Open Classroom Modal" to trigger the modal</li>
                        <li>Try adding scenarios to the classroom</li>
                        <li>Watch the debug panel for infinite loop warnings</li>
                        <li>Run stress test to simulate rapid user interactions</li>
                    </ol>
                </div>
            `;
      }

      // Trigger classroom modal
      async function triggerClassroomModal() {
        if (!teacherModals) {
          addDebugLog("error", "Services not initialized");
          return;
        }

        addDebugLog("info", "Opening classroom creation modal...");

        try {
          // Reset counters before test
          const beforeMutations = testState.mutationCount;
          const beforeEvents = testState.eventCount;
          const beforeLoops = testState.loopCount;

          // Open the modal
          await teacherModals.showCreateClassroomModal();

          // Give it a moment to settle
          setTimeout(() => {
            const mutationDelta = testState.mutationCount - beforeMutations;
            const eventDelta = testState.eventCount - beforeEvents;
            const loopDelta = testState.loopCount - beforeLoops;

            addDebugLog(
              "info",
              `Modal opened - Mutations: +${mutationDelta}, Events: +${eventDelta}, Loops: +${loopDelta}`,
            );

            if (loopDelta > 0) {
              addDebugLog(
                "warning",
                `âš ï¸ Detected ${loopDelta} potential infinite loops!`,
              );
            } else {
              addDebugLog(
                "success",
                "âœ… No infinite loops detected in modal opening",
              );
            }
          }, 1000);
        } catch (error) {
          addDebugLog("error", `Failed to open modal: ${error.message}`);
        }
      }

      // Stress test - rapid interactions
      async function runStressTest() {
        if (!teacherModals) {
          addDebugLog("error", "Services not initialized");
          return;
        }

        addDebugLog(
          "info",
          "Starting stress test - rapid scenario additions...",
        );

        // Reset counters
        const beforeMutations = testState.mutationCount;
        const beforeLoops = testState.loopCount;

        // Simulate rapid scenario additions
        const modal = document.querySelector(".modal.show");
        if (!modal) {
          addDebugLog("warning", "No open modal found - opening modal first");
          await triggerClassroomModal();
          await new Promise((resolve) => setTimeout(resolve, 1000));
        }

        // Find scenario add buttons
        const addButtons = document.querySelectorAll(".add-scenario");
        addDebugLog("info", `Found ${addButtons.length} scenario add buttons`);

        if (addButtons.length > 0) {
          // Rapidly click the first few buttons
          for (let i = 0; i < Math.min(3, addButtons.length); i++) {
            setTimeout(() => {
              if (addButtons[i] && !addButtons[i].disabled) {
                addButtons[i].click();
                addDebugLog("info", `Stress test click ${i + 1}`);
              }
            }, i * 200); // 200ms intervals
          }

          // Check results after stress test
          setTimeout(() => {
            const mutationDelta = testState.mutationCount - beforeMutations;
            const loopDelta = testState.loopCount - beforeLoops;

            addDebugLog(
              "info",
              `Stress test complete - Mutations: +${mutationDelta}, Loops: +${loopDelta}`,
            );

            if (loopDelta > 5) {
              addDebugLog(
                "error",
                `âŒ Stress test failed - ${loopDelta} potential infinite loops detected`,
              );
            } else if (loopDelta > 0) {
              addDebugLog(
                "warning",
                `âš ï¸ Minor loop activity detected: ${loopDelta} instances`,
              );
            } else {
              addDebugLog(
                "success",
                "âœ… Stress test passed - no infinite loops detected",
              );
            }
          }, 2000);
        } else {
          addDebugLog("warning", "No scenario buttons found for stress test");
        }
      }

      // Event listeners
      document
        .getElementById("start-test")
        .addEventListener("click", startLoopFixTest);
      document
        .getElementById("trigger-classroom")
        .addEventListener("click", triggerClassroomModal);
      document
        .getElementById("stress-test")
        .addEventListener("click", runStressTest);

      document.getElementById("clear-log").addEventListener("click", () => {
        document.getElementById("debug-log").innerHTML = "";
        addDebugLog("info", "Debug log cleared");
      });

      document.getElementById("reset-test").addEventListener("click", () => {
        testState = {
          mutationCount: 0,
          eventCount: 0,
          loopCount: 0,
          testStartTime: null,
          mutations: [],
          events: [],
          loopWarnings: [],
        };
        updateDebugCounters();
        document.getElementById("debug-log").innerHTML = "";
        addDebugLog("info", "Test state reset");
      });

      document
        .getElementById("export-results")
        .addEventListener("click", () => {
          const results = {
            testDuration: testState.testStartTime
              ? Date.now() - testState.testStartTime
              : 0,
            ...testState,
            timestamp: new Date().toISOString(),
          };

          const blob = new Blob([JSON.stringify(results, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `classroom-loop-test-${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);

          addDebugLog("success", "Test results exported");
        });

      // Initialize on page load
      addDebugLog("info", "Loop fix test page loaded");
    </script>
  </body>
</html>
