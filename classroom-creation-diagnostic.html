<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom Creation Diagnostic - SimulateAI</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .diagnostic-output {
        background: #1a1a1a;
        color: #00ff00;
        font-family: "Courier New", monospace;
        padding: 15px;
        border-radius: 5px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .status-card {
        margin: 10px 0;
      }
      .status-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1>Classroom Creation Diagnostic</h1>
      <p class="text-muted">Diagnosing the "Database not connected" error</p>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Service Status</h5>
            </div>
            <div class="card-body">
              <div id="service-status">
                <div class="status-card">
                  <strong>Firebase Service:</strong>
                  <span
                    id="firebase-status"
                    class="badge status-badge bg-secondary"
                    >Unknown</span
                  >
                </div>
                <div class="status-card">
                  <strong>Database Connected:</strong>
                  <span
                    id="database-status"
                    class="badge status-badge bg-secondary"
                    >Unknown</span
                  >
                </div>
                <div class="status-card">
                  <strong>Fallback Mode:</strong>
                  <span
                    id="fallback-status"
                    class="badge status-badge bg-secondary"
                    >Unknown</span
                  >
                </div>
                <div class="status-card">
                  <strong>Classroom Service:</strong>
                  <span
                    id="classroom-status"
                    class="badge status-badge bg-secondary"
                    >Unknown</span
                  >
                </div>
              </div>

              <hr />

              <button id="diagnose-btn" class="btn btn-primary">
                Run Diagnostic
              </button>
              <button id="force-creation-btn" class="btn btn-warning">
                Force Creation Test
              </button>
              <button id="clear-output-btn" class="btn btn-secondary">
                Clear Output
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="test-classroom-name" class="form-label"
                  >Test Classroom Name:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="test-classroom-name"
                  value="Diagnostic Test Classroom"
                />
              </div>
              <button id="test-creation" class="btn btn-success mb-2">
                Test Classroom Creation
              </button>
              <button id="check-localStorage" class="btn btn-info mb-2">
                Check localStorage
              </button>
              <button id="reset-services" class="btn btn-danger mb-2">
                Reset Services
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Diagnostic Output</h5>
            </div>
            <div class="card-body">
              <div id="diagnostic-output" class="diagnostic-output">
                === Classroom Creation Diagnostic Tool === Click "Run
                Diagnostic" to start analysis...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
      import DataHandler from "./src/js/core/data-handler.js";
      import { FirebaseService } from "./src/js/services/firebase-service.js";
      import RealtimeClassroomService from "./src/js/services/realtime-classroom-service.js";
      import TeacherClassroomModals from "./src/js/components/teacher-classroom-modals.js";
      import logger from "./src/js/utils/logger.js";

      let services = {
        firebaseService: null,
        dataHandler: null,
        classroomService: null,
        teacherModals: null,
      };

      // Output management
      function addOutput(message, type = "info") {
        const output = document.getElementById("diagnostic-output");
        const timestamp = new Date().toLocaleTimeString();
        const line = `[${timestamp}] ${message}`;
        output.textContent += "\n" + line;
        output.scrollTop = output.scrollHeight;
      }

      function updateStatus(elementId, status, type) {
        const element = document.getElementById(elementId);
        element.textContent = status;
        element.className = `badge status-badge bg-${type}`;
      }

      // Comprehensive diagnostic
      async function runDiagnostic() {
        addOutput("=== STARTING COMPREHENSIVE DIAGNOSTIC ===");

        try {
          // Step 1: Initialize Firebase Service
          addOutput("Step 1: Initializing Firebase Service...");
          services.firebaseService = new FirebaseService();

          // Check if Firebase service has an app
          addOutput(
            `Firebase service created. App exists: ${!!services.firebaseService.app}`,
          );

          await services.firebaseService.initialize({
            enableOffline: true,
            enablePersistence: false,
          });

          updateStatus("firebase-status", "Initialized", "success");
          addOutput("✅ Firebase service initialized");

          // Step 2: Initialize DataHandler
          addOutput("Step 2: Initializing DataHandler...");
          services.dataHandler = new DataHandler({
            appName: "SimulateAI",
            version: "1.80",
            firebaseService: services.firebaseService,
            enableCaching: true,
          });

          await services.dataHandler.initialize();
          addOutput("✅ DataHandler initialized");

          // Step 3: Initialize RealtimeClassroomService (the problematic one)
          addOutput("Step 3: Initializing RealtimeClassroomService...");
          addOutput(
            `Passing firebaseService to RealtimeClassroomService: ${!!services.firebaseService}`,
          );

          services.classroomService = new RealtimeClassroomService(
            services.firebaseService,
          );
          addOutput("RealtimeClassroomService constructor completed");

          // Wait for database initialization to complete
          addOutput("Waiting for database initialization to complete...");
          await new Promise((resolve) => setTimeout(resolve, 2000));

          // Check service state
          addOutput(
            `Database initialized: ${services.classroomService.database !== null}`,
          );
          addOutput(`Is connected: ${services.classroomService.isConnected}`);
          addOutput(`Fallback mode: ${services.classroomService.fallbackMode}`);

          updateStatus(
            "database-status",
            services.classroomService.isConnected
              ? "Connected"
              : "Disconnected",
            services.classroomService.isConnected ? "success" : "danger",
          );
          updateStatus(
            "fallback-status",
            services.classroomService.fallbackMode ? "Enabled" : "Disabled",
            services.classroomService.fallbackMode ? "warning" : "success",
          );
          updateStatus("classroom-status", "Ready", "success");

          // Step 4: Test classroom creation directly
          addOutput("Step 4: Testing direct classroom creation...");

          const testClassroomData = {
            classroomName: "Diagnostic Test",
            instructorId: "diagnostic_instructor_" + Date.now(),
            instructorName: "Diagnostic Instructor",
            selectedScenarios: [{ id: "test1", title: "Test Scenario 1" }],
          };

          addOutput("Calling createClassroom directly...");
          const result =
            await services.classroomService.createClassroom(testClassroomData);

          addOutput(`✅ SUCCESS! Classroom created: ${result.classroomCode}`);
          addOutput(`Classroom ID: ${result.classroomId}`);
          addOutput(
            `Storage mode: ${services.classroomService.fallbackMode ? "localStorage" : "Firebase"}`,
          );

          return true;
        } catch (error) {
          addOutput(`❌ DIAGNOSTIC FAILED: ${error.message}`);
          addOutput(`Error stack: ${error.stack}`);
          updateStatus("classroom-status", "Failed", "danger");

          // Additional debugging
          if (services.classroomService) {
            addOutput(`--- Service State Debug ---`);
            addOutput(`isConnected: ${services.classroomService.isConnected}`);
            addOutput(
              `fallbackMode: ${services.classroomService.fallbackMode}`,
            );
            addOutput(
              `database: ${services.classroomService.database !== null ? "exists" : "null"}`,
            );
            addOutput(
              `firebaseService: ${services.classroomService.firebaseService !== null ? "exists" : "null"}`,
            );
          }

          return false;
        }
      }

      // Force creation test (bypass normal initialization)
      async function forceCreationTest() {
        addOutput("=== FORCE CREATION TEST ===");

        try {
          // Create a minimal classroom service with forced fallback
          addOutput("Creating classroom service with forced fallback...");

          const forcedService = new RealtimeClassroomService(null); // No Firebase service
          await new Promise((resolve) => setTimeout(resolve, 1000)); // Wait for initialization

          addOutput(
            `Forced service fallback mode: ${forcedService.fallbackMode}`,
          );
          addOutput(`Forced service connected: ${forcedService.isConnected}`);

          const testData = {
            classroomName: "Force Test Classroom",
            instructorId: "force_test_instructor",
            instructorName: "Force Test Instructor",
            selectedScenarios: [],
          };

          const result = await forcedService.createClassroom(testData);
          addOutput(`✅ FORCE TEST SUCCESS: ${result.classroomCode}`);
        } catch (error) {
          addOutput(`❌ FORCE TEST FAILED: ${error.message}`);
        }
      }

      // Test with TeacherClassroomModals (full integration)
      async function testWithModals() {
        addOutput("=== TESTING WITH TEACHER MODALS ===");

        if (!services.firebaseService || !services.dataHandler) {
          addOutput("Services not initialized. Running diagnostic first...");
          const success = await runDiagnostic();
          if (!success) {
            addOutput("❌ Cannot test modals - diagnostic failed");
            return;
          }
        }

        try {
          addOutput("Initializing TeacherClassroomModals...");
          services.teacherModals = new TeacherClassroomModals(
            services.dataHandler,
            services.firebaseService,
          );
          await services.teacherModals.initialize(true); // Guest mode

          addOutput("✅ TeacherClassroomModals initialized");

          // Check the classroom service within the modals
          const modalClassroomService = services.teacherModals.classroomService;
          addOutput(
            `Modal classroom service fallback: ${modalClassroomService.fallbackMode}`,
          );
          addOutput(
            `Modal classroom service connected: ${modalClassroomService.isConnected}`,
          );
        } catch (error) {
          addOutput(`❌ Modal test failed: ${error.message}`);
        }
      }

      // Check localStorage data
      function checkLocalStorage() {
        addOutput("=== CHECKING LOCALSTORAGE ===");

        const classrooms = localStorage.getItem("simulateai_classrooms");
        if (classrooms) {
          addOutput("Found existing classrooms in localStorage:");
          addOutput(classrooms);
        } else {
          addOutput("No classrooms found in localStorage");
        }

        // Check for other SimulateAI data
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.includes("simulateai") || key.includes("SimulateAI")) {
            addOutput(`Found localStorage key: ${key}`);
          }
        }
      }

      // Event listeners
      document
        .getElementById("diagnose-btn")
        .addEventListener("click", runDiagnostic);
      document
        .getElementById("force-creation-btn")
        .addEventListener("click", forceCreationTest);
      document
        .getElementById("test-creation")
        .addEventListener("click", testWithModals);
      document
        .getElementById("check-localStorage")
        .addEventListener("click", checkLocalStorage);

      document
        .getElementById("clear-output-btn")
        .addEventListener("click", () => {
          document.getElementById("diagnostic-output").textContent =
            "=== Classroom Creation Diagnostic Tool ===\nOutput cleared...";
        });

      document
        .getElementById("reset-services")
        .addEventListener("click", () => {
          services = {
            firebaseService: null,
            dataHandler: null,
            classroomService: null,
            teacherModals: null,
          };
          updateStatus("firebase-status", "Unknown", "secondary");
          updateStatus("database-status", "Unknown", "secondary");
          updateStatus("fallback-status", "Unknown", "secondary");
          updateStatus("classroom-status", "Unknown", "secondary");
          addOutput("Services reset");
        });

      // Auto-run diagnostic on page load
      addOutput('Diagnostic tool loaded. Click "Run Diagnostic" to begin...');
    </script>
  </body>
</html>
