<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom Emulator Harness</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          sans-serif;
        margin: 0;
      }
      .layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 12px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .card h2 {
        margin: 0;
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
      }
      .card .content {
        padding: 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        margin: 8px 0;
        align-items: center;
      }
      input,
      button {
        padding: 8px 10px;
        font-size: 14px;
      }
      .log {
        background: #0b1220;
        color: #8bd5ff;
        height: 220px;
        overflow: auto;
        padding: 10px;
        border-radius: 6px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .pill {
        display: inline-block;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef;
        color: #223;
        margin-left: 6px;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div class="card">
        <h2>Teacher<span id="teacher-auth" class="pill">signed-out</span></h2>
        <div class="content">
          <div class="row">
            <input
              id="teacher-email"
              placeholder="teacher@example.com"
              value="teacher@example.com"
            />
            <input
              id="teacher-pass"
              placeholder="password"
              value="Test1234!"
              type="password"
            />
            <button id="teacher-signin">Sign in (Emulator)</button>
          </div>
          <div class="row">
            <input
              id="classroom-name"
              placeholder="Classroom name"
              value="Emulator Test Class"
            />
            <button id="create-classroom">Create</button>
            <span>Code: <strong id="classroom-code">â€”</strong></span>
          </div>
          <div class="row">
            <button id="start-session">Start Session</button>
          </div>
          <div class="log" id="teacher-log"></div>
        </div>
      </div>
      <div class="card">
        <h2>Student<span id="student-auth" class="pill">signed-out</span></h2>
        <div class="content">
          <div class="row">
            <input
              id="student-email"
              placeholder="student@example.com"
              value="student@example.com"
            />
            <input
              id="student-pass"
              placeholder="password"
              value="Test1234!"
              type="password"
            />
            <button id="student-signin">Sign in (Emulator)</button>
          </div>
          <div class="row">
            <input id="join-code" placeholder="Class code" />
            <input id="nickname" placeholder="Nickname" value="Alex" />
            <button id="join-classroom">Join</button>
          </div>
          <div class="log" id="student-log"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import { FirebaseService } from "./src/js/services/firebase-service.js";
      import RealtimeClassroomService from "./src/js/services/realtime-classroom-service.js";

      const teacherLog = (m) => {
        const el = document.getElementById("teacher-log");
        el.textContent += (el.textContent ? "\n" : "") + m;
        el.scrollTop = el.scrollHeight;
      };
      const studentLog = (m) => {
        const el = document.getElementById("student-log");
        el.textContent += (el.textContent ? "\n" : "") + m;
        el.scrollTop = el.scrollHeight;
      };

      const tAuthBadge = document.getElementById("teacher-auth");
      const sAuthBadge = document.getElementById("student-auth");

      // Single Firebase app per page. For two distinct users, open this page in two separate browser profiles (e.g., Chrome + Edge or normal + incognito)
      const firebase = new FirebaseService();
      await firebase.initialize();

      const teacherSvc = new RealtimeClassroomService(firebase);
      const studentSvc = new RealtimeClassroomService(firebase);

      const updateBadges = () => {
        tAuthBadge.textContent = firebase.getCurrentUser()
          ? "signed-in"
          : "signed-out";
        sAuthBadge.textContent = firebase.getCurrentUser()
          ? "signed-in"
          : "signed-out";
      };
      updateBadges();

      // Simple sign-in using emulator email/password seeding helper
      async function signInEmu(service, email, pass) {
        try {
          const seeded = await service.devSeedEmailUser(
            email,
            pass,
            email.split("@")[0],
          );
          if (!seeded.success) throw new Error(seeded.error || "seed failed");
          return seeded.user || service.getCurrentUser();
        } catch (e) {
          throw e;
        }
      }

      document
        .getElementById("teacher-signin")
        .addEventListener("click", async () => {
          try {
            const email = document.getElementById("teacher-email").value;
            const pass = document.getElementById("teacher-pass").value;
            await signInEmu(firebase, email, pass);
            updateBadges();
            teacherLog("ðŸ‘©â€ðŸ« Teacher signed in");
          } catch (e) {
            teacherLog("Sign-in error: " + e.message);
          }
        });

      document
        .getElementById("student-signin")
        .addEventListener("click", async () => {
          try {
            const email = document.getElementById("student-email").value;
            const pass = document.getElementById("student-pass").value;
            await signInEmu(firebase, email, pass);
            updateBadges();
            studentLog("ðŸ§‘â€ðŸŽ“ Student signed in");
          } catch (e) {
            studentLog("Sign-in error: " + e.message);
          }
        });

      let currentCode = null;
      document
        .getElementById("create-classroom")
        .addEventListener("click", async () => {
          try {
            const name = document.getElementById("classroom-name").value;
            const instructorId =
              firebase.getCurrentUser()?.uid || "local-teacher";
            const instructorName =
              firebase.getCurrentUser()?.displayName || "Teacher";
            const res = await teacherSvc.createClassroom({
              classroomName: name,
              instructorId,
              instructorName,
              selectedScenarios: [],
            });
            currentCode = res.classroomCode;
            document.getElementById("classroom-code").textContent = currentCode;
            document.getElementById("join-code").value = currentCode;
            teacherLog(`âœ… Created classroom ${currentCode}`);
          } catch (e) {
            teacherLog("Create error: " + e.message);
          }
        });

      document
        .getElementById("start-session")
        .addEventListener("click", async () => {
          if (!currentCode) return teacherLog("Create a classroom first");
          try {
            await teacherSvc.startLiveSession(
              currentCode,
              firebase.getCurrentUser()?.uid || "local-teacher",
            );
            teacherLog("â–¶ï¸ Session started");
          } catch (e) {
            teacherLog("Start error: " + e.message);
          }
        });

      document
        .getElementById("join-classroom")
        .addEventListener("click", async () => {
          const code = document.getElementById("join-code").value.trim();
          const nickname =
            document.getElementById("nickname").value.trim() || "Student";
          try {
            const uid = firebase.getCurrentUser()?.uid || "local-student";
            const res = await studentSvc.joinClassroom(code, uid, nickname);
            studentLog(
              `âœ… Joined ${code} as ${nickname} (${res.studentInfo?.nickname || "n/a"})`,
            );
          } catch (e) {
            studentLog("Join error: " + e.message);
          }
        });

      // Optional: roster live view in logs
      const stopRoster = () => {};
      // You could hook: teacherSvc.listenToRoster(code, r => teacherLog('Roster: ' + JSON.stringify(r)))
    </script>
  </body>
</html>
