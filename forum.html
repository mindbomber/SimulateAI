<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="theme-color" content="#1a73e8" />
    <meta name="color-scheme" content="light" />
    <title>Forum - SimulateAI</title>
    <meta
      name="description"
      content="Join discussions about AI ethics, education, and simulation-based learning"
    />

    <!-- Same CSS includes as main app -->
    <link rel="stylesheet" href="src/styles/main.css" />
    <link rel="stylesheet" href="src/styles/accessibility.css" />
    <link rel="stylesheet" href="src/styles/simulations.css" />
    <link rel="stylesheet" href="src/styles/layout-components.css" />
    <link rel="stylesheet" href="src/styles/advanced-ui-components.css" />
    <link rel="stylesheet" href="src/styles/enhanced-objects.css" />
    <link rel="stylesheet" href="src/styles/input-utility-components.css" />
    <link rel="stylesheet" href="src/styles/form-input-components.css" />
    <link rel="stylesheet" href="src/styles/notification-toast.css" />
    <link rel="stylesheet" href="src/styles/onboarding-tour.css" />
    <link rel="stylesheet" href="src/styles/radar-chart.css" />
    <link rel="stylesheet" href="src/styles/scenario-modal.css" />
    <link rel="stylesheet" href="src/styles/card-component.css" />
    <link rel="stylesheet" href="src/styles/loader-spinner.css" />
    <link rel="stylesheet" href="src/styles/hero-demo.css" />
    <link rel="stylesheet" href="src/styles/bias-fairness.css" />
    <link rel="stylesheet" href="src/styles/category-grid.css" />
    <link rel="stylesheet" href="src/styles/ethics-analysis.css" />
    <link rel="stylesheet" href="src/styles/layout-fixes.css" />
    <link rel="stylesheet" href="src/styles/ethics-explorer.css" />
    <link rel="stylesheet" href="src/styles/badge-modal.css" />
    <link rel="stylesheet" href="src/styles/community-features.css" />
    <link
      rel="stylesheet"
      href="src/styles/simulation-modal-consolidated.css"
    />

    <!-- Icons and Favicons -->
    <link rel="icon" type="image/svg+xml" href="src/assets/icons/favicon.svg" />
  </head>
  <body>
    <!-- Skip to content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- ARIA live regions for announcements -->
    <div
      id="aria-live-polite"
      aria-live="polite"
      aria-atomic="true"
      class="sr-only"
    ></div>
    <div
      id="aria-live-assertive"
      aria-live="assertive"
      aria-atomic="true"
      class="sr-only"
    ></div>

    <!-- Header (same as main app) -->
    <header class="header" role="banner">
      <div class="header-container">
        <div class="logo">
          <a href="index.html">
            <img
              src="src/assets/icons/logo.svg"
              alt="SimulateAI Educational Platform"
              class="logo-image"
            />
            <h1 class="site-title">SimulateAI</h1>
          </a>
        </div>

        <!-- Mobile hamburger button -->
        <button
          class="nav-toggle"
          aria-label="Toggle navigation menu"
          aria-expanded="false"
          aria-controls="main-navigation"
        >
          <span></span>
          <span></span>
          <span></span>
        </button>

        <nav
          class="main-nav"
          role="navigation"
          aria-label="Main navigation"
          id="main-navigation"
        >
          <ul class="nav-list">
            <li><a href="index.html" class="nav-link">Home</a></li>
            <li>
              <a href="index.html#categories" class="nav-link">Categories</a>
            </li>
            <li><a href="blog.html" class="nav-link">Blog</a></li>
            <li>
              <a href="#forum" class="nav-link active" aria-current="page"
                >Forum</a
              >
            </li>
            <li><a href="profile.html" class="nav-link">Profile</a></li>
            <!-- User auth buttons will be added by JavaScript -->
          </ul>
        </nav>
      </div>
      <div class="nav-backdrop" aria-hidden="true"></div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="main-content" role="main">
      <!-- Forum Header -->
      <section class="forum-header">
        <div class="container">
          <div class="forum-header-content">
            <h1>üí¨ Community Forum</h1>
            <p>
              Join discussions about AI ethics, education, and simulation-based
              learning with fellow learners and experts.
            </p>

            <!-- Forum Actions -->
            <div class="forum-actions">
              <button
                id="start-discussion-btn"
                class="btn btn-primary"
                style="display: none"
              >
                üí¨ Start Discussion
              </button>
              <div class="forum-search">
                <input
                  type="search"
                  id="forum-search"
                  placeholder="Search discussions..."
                  aria-label="Search forum discussions"
                />
                <button class="search-btn" aria-label="Search">üîç</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Forum Categories -->
      <section class="forum-categories">
        <div class="container">
          <h2>üìÅ Discussion Categories</h2>
          <div class="categories-grid">
            <div class="category-card" data-category="general">
              <div class="category-header">
                <span class="category-icon">üí≠</span>
                <h3>General Discussion</h3>
              </div>
              <p>Open discussions about AI ethics and education</p>
              <div class="category-stats">
                <span class="discussion-count">12 discussions</span>
                <span class="recent-activity">Last activity: 2 hours ago</span>
              </div>
            </div>

            <div class="category-card" data-category="scenarios">
              <div class="category-header">
                <span class="category-icon">üé≠</span>
                <h3>Scenario Discussions</h3>
              </div>
              <p>Share insights about specific simulation scenarios</p>
              <div class="category-stats">
                <span class="discussion-count">8 discussions</span>
                <span class="recent-activity">Last activity: 1 day ago</span>
              </div>
            </div>

            <div class="category-card" data-category="research">
              <div class="category-header">
                <span class="category-icon">üî¨</span>
                <h3>Research & Methodology</h3>
              </div>
              <p>Academic discussions and research insights</p>
              <div class="category-stats">
                <span class="discussion-count">5 discussions</span>
                <span class="recent-activity">Last activity: 3 days ago</span>
              </div>
            </div>

            <div class="category-card" data-category="feedback">
              <div class="category-header">
                <span class="category-icon">üí°</span>
                <h3>Feature Feedback</h3>
              </div>
              <p>Suggestions and feedback for platform improvements</p>
              <div class="category-stats">
                <span class="discussion-count">15 discussions</span>
                <span class="recent-activity">Last activity: 5 hours ago</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Recent Discussions -->
      <section class="recent-discussions">
        <div class="container">
          <div class="discussions-header">
            <h2>üî• Recent Discussions</h2>
            <div class="discussion-filters">
              <select id="category-filter" aria-label="Filter by category">
                <option value="">All Categories</option>
                <option value="general">üí≠ General</option>
                <option value="scenarios">üé≠ Scenarios</option>
                <option value="research">üî¨ Research</option>
                <option value="feedback">üí° Feedback</option>
              </select>
              <select id="sort-filter" aria-label="Sort discussions">
                <option value="recent">Most Recent</option>
                <option value="popular">Most Popular</option>
                <option value="active">Most Active</option>
              </select>
            </div>
          </div>

          <div id="discussions-container" class="discussions-container">
            <!-- Discussions will be populated by JavaScript -->
          </div>

          <!-- Load More Button -->
          <div class="load-more-container">
            <button id="load-more-btn" class="btn btn-outline">
              Load More Discussions
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer (same as main app) -->
    <footer class="footer" role="contentinfo">
      <div class="footer-content">
        <div class="footer-sections">
          <div class="footer-section">
            <h3>Community Guidelines</h3>
            <p>
              Please be respectful, constructive, and evidence-based in your
              discussions. Personal attacks and off-topic content are not
              allowed.
            </p>
          </div>
          <div class="footer-section">
            <h3>Moderation</h3>
            <p>
              Community supporters and education patrons help moderate
              discussions. Report inappropriate content for review.
            </p>
          </div>
        </div>
        <div class="footer-bottom">
          <p>
            &copy; 2025 SimulateAI Educational Platform. Open source AI ethics
            education.
          </p>
        </div>
      </div>
    </footer>

    <!-- Start Discussion Modal -->
    <div
      id="start-discussion-modal"
      class="modal-overlay"
      style="display: none"
      role="dialog"
      aria-labelledby="start-discussion-title"
      aria-modal="true"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="start-discussion-title">üí¨ Start a Discussion</h2>
          <button class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="start-discussion-form">
            <div class="form-group">
              <label for="discussion-category">Category *</label>
              <select id="discussion-category" required>
                <option value="">Select a category...</option>
                <option value="general">üí≠ General Discussion</option>
                <option value="scenarios">üé≠ Scenario Discussions</option>
                <option value="research">üî¨ Research & Methodology</option>
                <option value="feedback">üí° Feature Feedback</option>
              </select>
            </div>

            <div class="form-group">
              <label for="discussion-title">Title *</label>
              <input
                type="text"
                id="discussion-title"
                required
                maxlength="200"
                placeholder="What's your discussion about?"
              />
            </div>

            <div class="form-group">
              <label for="discussion-content">Content *</label>
              <textarea
                id="discussion-content"
                rows="8"
                required
                placeholder="Share your thoughts, questions, or insights... Basic Markdown formatting is supported."
              ></textarea>
              <small class="form-help"
                >Supports basic Markdown: **bold**, *italic*, [links](url),
                `code`, etc.</small
              >
            </div>

            <div class="form-group">
              <label for="discussion-tags">Tags</label>
              <input
                type="text"
                id="discussion-tags"
                placeholder="ai-ethics, bias, privacy (comma-separated)"
              />
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-outline" id="save-draft-btn">
                üíæ Save Draft
              </button>
              <button type="submit" class="btn btn-primary">
                üí¨ Start Discussion
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="loading" aria-hidden="true" role="status">
      <div class="loading-spinner" aria-hidden="true"></div>
      <p class="loading-text">Loading discussions...</p>
    </div>

    <!-- Scripts -->
    <script type="module" src="src/js/services/firebase-service.js"></script>
    <script type="module" src="src/js/services/auth-service.js"></script>
    <script
      type="module"
      src="src/js/components/notification-toast.js"
    ></script>
    <script type="module" src="src/js/components/modal-utility.js"></script>

    <!-- Forum Page Script -->
    <script type="module">
      import AuthService from './src/js/services/auth-service.js';
      import FirebaseService from './src/js/services/firebase-service.js';

      class ForumPage {
        constructor() {
          this.authService = new AuthService();
          this.firebaseService = new FirebaseService();
          this.currentUser = null;
          this.discussions = [];
          this.filteredDiscussions = [];
          this.discussionsPerPage = 10;
          this.currentPage = 0;
          this.selectedCategory = '';
        }

        async init() {
          await this.authService.initialize();
          await this.firebaseService.initialize();

          // Set up auth state listener
          this.authService.firebaseService.addAuthStateListener(user => {
            this.currentUser = user;
            this.updateUIForAuth();
          });

          this.setupEventHandlers();
          await this.loadDiscussions();
        }

        updateUIForAuth() {
          const startDiscussionBtn = document.getElementById(
            'start-discussion-btn'
          );

          if (this.currentUser) {
            startDiscussionBtn.style.display = 'inline-block';
          } else {
            startDiscussionBtn.style.display = 'none';
          }
        }

        async loadDiscussions() {
          try {
            this.showLoading(true);

            // For now, create some sample discussions since Firebase collection is empty
            this.discussions = await this.getSampleDiscussions();
            this.filteredDiscussions = [...this.discussions];

            this.renderDiscussions();
          } catch (error) {
            console.error('Error loading discussions:', error);
            this.showError('Failed to load discussions');
          } finally {
            this.showLoading(false);
          }
        }

        async getSampleDiscussions() {
          // Sample discussions for demonstration
          return [
            {
              id: 'disc1',
              title:
                'How to better detect algorithmic bias in hiring scenarios?',
              content:
                'I have been working through the hiring simulation and I am curious about best practices for detecting bias...',
              category: 'scenarios',
              author: {
                name: 'Sarah M.',
                tier: 1,
                avatar: '/assets/user1-avatar.png',
              },
              tags: ['bias-detection', 'hiring', 'algorithms'],
              createdAt: new Date('2025-01-14T10:30:00'),
              lastActivity: new Date('2025-01-15T14:20:00'),
              replies: 8,
              views: 156,
              likes: 12,
              pinned: false,
            },
            {
              id: 'disc2',
              title:
                'Research methodology for simulation-based learning effectiveness',
              content:
                'I am interested in the research methodology behind measuring learning outcomes...',
              category: 'research',
              author: {
                name: 'Dr. Alex Chen',
                tier: 3,
                avatar: '/assets/researcher2-avatar.png',
              },
              tags: ['research', 'methodology', 'learning-outcomes'],
              createdAt: new Date('2025-01-13T16:45:00'),
              lastActivity: new Date('2025-01-15T09:15:00'),
              replies: 15,
              views: 289,
              likes: 23,
              pinned: true,
            },
            {
              id: 'disc3',
              title: 'Feature Request: More diverse scenario contexts',
              content:
                'It would be great to see scenarios from different cultural and industry contexts...',
              category: 'feedback',
              author: {
                name: 'Maria Rodriguez',
                tier: 2,
                avatar: '/assets/user3-avatar.png',
              },
              tags: ['feature-request', 'diversity', 'scenarios'],
              createdAt: new Date('2025-01-12T09:20:00'),
              lastActivity: new Date('2025-01-14T18:30:00'),
              replies: 6,
              views: 234,
              likes: 18,
              pinned: false,
            },
            {
              id: 'disc4',
              title: 'Privacy considerations in educational AI tools',
              content:
                'Let us discuss the privacy implications of using AI in educational settings...',
              category: 'general',
              author: {
                name: 'James Wilson',
                tier: 1,
                avatar: '/assets/user4-avatar.png',
              },
              tags: ['privacy', 'education', 'ai-tools'],
              createdAt: new Date('2025-01-11T14:15:00'),
              lastActivity: new Date('2025-01-14T11:45:00'),
              replies: 11,
              views: 178,
              likes: 9,
              pinned: false,
            },
          ];
        }

        renderDiscussions() {
          const container = document.getElementById('discussions-container');
          const startIndex = this.currentPage * this.discussionsPerPage;
          const endIndex = startIndex + this.discussionsPerPage;
          const discussionsToShow = this.filteredDiscussions.slice(
            startIndex,
            endIndex
          );

          if (this.currentPage === 0) {
            container.innerHTML = '';
          }

          container.innerHTML += discussionsToShow
            .map(
              discussion => `
                    <article class="discussion-card ${discussion.pinned ? 'pinned' : ''}">
                        ${discussion.pinned ? '<div class="pinned-badge">üìå Pinned</div>' : ''}
                        <div class="discussion-header">
                            <div class="discussion-category">${this.getCategoryEmoji(discussion.category)} ${this.getCategoryName(discussion.category)}</div>
                            <time class="discussion-date">${this.formatDate(discussion.createdAt)}</time>
                        </div>
                        <h2><a href="#" onclick="window.forumPage.openDiscussion('${discussion.id}')">${discussion.title}</a></h2>
                        <p class="discussion-preview">${discussion.content.substring(0, 200)}${discussion.content.length > 200 ? '...' : ''}</p>
                        <div class="discussion-tags">
                            ${discussion.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                        </div>
                        <div class="discussion-footer">
                            <div class="discussion-author">
                                <img src="${discussion.author.avatar}" alt="${discussion.author.name}" class="author-avatar">
                                <span class="author-name">${discussion.author.name} ${this.getTierBadge(discussion.author.tier)}</span>
                            </div>
                            <div class="discussion-stats">
                                <span class="stat-item">üí¨ ${discussion.replies} replies</span>
                                <span class="stat-item">üëÅÔ∏è ${discussion.views} views</span>
                                <span class="stat-item">‚ù§Ô∏è ${discussion.likes} likes</span>
                                <span class="last-activity">Last: ${this.formatRelativeTime(discussion.lastActivity)}</span>
                            </div>
                        </div>
                    </article>
                `
            )
            .join('');

          // Update load more button
          const loadMoreBtn = document.getElementById('load-more-btn');
          if (endIndex >= this.filteredDiscussions.length) {
            loadMoreBtn.style.display = 'none';
          } else {
            loadMoreBtn.style.display = 'block';
          }
        }

        getCategoryEmoji(category) {
          const emojis = {
            general: 'üí≠',
            scenarios: 'üé≠',
            research: 'üî¨',
            feedback: 'üí°',
          };
          return emojis[category] || 'üí¨';
        }

        getCategoryName(category) {
          const names = {
            general: 'General Discussion',
            scenarios: 'Scenario Discussions',
            research: 'Research & Methodology',
            feedback: 'Feature Feedback',
          };
          return names[category] || 'Discussion';
        }

        getTierBadge(tier) {
          const badges = {
            0: '',
            1: 'üî¨',
            2: '‚≠ê',
            3: 'üëë',
          };
          return badges[tier] || '';
        }

        formatDate(date) {
          return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          });
        }

        formatRelativeTime(date) {
          const now = new Date();
          const diff = now - date;
          const minutes = Math.floor(diff / 60000);
          const hours = Math.floor(minutes / 60);
          const days = Math.floor(hours / 24);

          if (days > 0) return `${days}d ago`;
          if (hours > 0) return `${hours}h ago`;
          if (minutes > 0) return `${minutes}m ago`;
          return 'Just now';
        }

        openDiscussion(discussionId) {
          // TODO: Navigate to individual discussion page
          alert(`Opening discussion: ${discussionId}`);
        }

        setupEventHandlers() {
          // Start discussion button
          document
            .getElementById('start-discussion-btn')
            ?.addEventListener('click', () => {
              this.showStartDiscussionModal();
            });

          // Category cards
          document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', e => {
              const category = e.currentTarget.dataset.category;
              this.filterByCategory(category);
            });
          });

          // Filters
          document
            .getElementById('category-filter')
            .addEventListener('change', e => {
              this.filterDiscussions();
            });

          document
            .getElementById('sort-filter')
            .addEventListener('change', e => {
              this.sortDiscussions();
            });

          // Search
          document
            .getElementById('forum-search')
            .addEventListener('input', e => {
              this.searchDiscussions(e.target.value);
            });

          // Load more button
          document
            .getElementById('load-more-btn')
            .addEventListener('click', () => {
              this.currentPage++;
              this.renderDiscussions();
            });

          // Start discussion form
          document
            .getElementById('start-discussion-form')
            .addEventListener('submit', e => {
              e.preventDefault();
              this.handleDiscussionSubmission();
            });

          // Modal close
          document
            .querySelector('#start-discussion-modal .modal-close')
            .addEventListener('click', () => {
              this.hideStartDiscussionModal();
            });
        }

        filterByCategory(category) {
          this.selectedCategory = category;
          document.getElementById('category-filter').value = category;
          this.filterDiscussions();
        }

        filterDiscussions() {
          const categoryFilter =
            document.getElementById('category-filter').value;

          this.filteredDiscussions = this.discussions.filter(discussion => {
            return !categoryFilter || discussion.category === categoryFilter;
          });

          this.currentPage = 0;
          this.sortDiscussions();
        }

        sortDiscussions() {
          const sortBy = document.getElementById('sort-filter').value;

          switch (sortBy) {
            case 'recent':
              this.filteredDiscussions.sort(
                (a, b) => b.lastActivity - a.lastActivity
              );
              break;
            case 'popular':
              this.filteredDiscussions.sort((a, b) => b.likes - a.likes);
              break;
            case 'active':
              this.filteredDiscussions.sort((a, b) => b.replies - a.replies);
              break;
          }

          // Always keep pinned posts at the top
          this.filteredDiscussions.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return 0;
          });

          this.renderDiscussions();
        }

        searchDiscussions(query) {
          if (!query.trim()) {
            this.filterDiscussions();
            return;
          }

          const lowercaseQuery = query.toLowerCase();
          this.filteredDiscussions = this.discussions.filter(discussion => {
            return (
              discussion.title.toLowerCase().includes(lowercaseQuery) ||
              discussion.content.toLowerCase().includes(lowercaseQuery) ||
              discussion.tags.some(tag =>
                tag.toLowerCase().includes(lowercaseQuery)
              )
            );
          });

          this.currentPage = 0;
          this.renderDiscussions();
        }

        showStartDiscussionModal() {
          if (!this.currentUser) {
            this.authService.showLoginModal();
            return;
          }

          document.getElementById('start-discussion-modal').style.display =
            'block';
          document.body.style.overflow = 'hidden';
        }

        hideStartDiscussionModal() {
          document.getElementById('start-discussion-modal').style.display =
            'none';
          document.body.style.overflow = 'auto';
        }

        async handleDiscussionSubmission() {
          // TODO: Implement discussion submission to Firebase
          alert('Discussion submission - Firebase integration coming soon!');
          this.hideStartDiscussionModal();
        }

        showLoading(show) {
          document.getElementById('loading').style.display = show
            ? 'flex'
            : 'none';
        }

        showError(message) {
          // TODO: Use notification toast
          console.error(message);
        }
      }

      // Initialize forum page and make it globally available
      window.forumPage = new ForumPage();
      window.forumPage.init();
    </script>
  </body>
</html>
