<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom Preview Test</title>
    <link rel="stylesheet" href="src/styles/css-layers.css" />
    <style>
      body {
        font-family: system-ui;
        margin: 20px;
        background: var(--color-background);
        color: var(--color-text);
      }
      .test-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-btn {
        padding: 15px 30px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }
      .test-btn:hover {
        background: #5a67d8;
      }
      .test-btn.secondary {
        background: #4a5568;
      }
      .test-btn.secondary:hover {
        background: #2d3748;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        background: #e8f5e8;
        border: 1px solid #c8e6c9;
      }
      .error {
        background: #ffebee;
        border: 1px solid #ffcdd2;
        color: #c62828;
      }
      .instructions {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .step-list {
        list-style: none;
        padding: 0;
      }
      .step-list li {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .step-list li:last-child {
        border-bottom: none;
      }
      .debug-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        margin: 15px 0;
        border: 1px solid #dee2e6;
      }
      h1 {
        color: #333;
      }
      h2 {
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>🧪 Classroom Preview Functionality Test</h1>

      <div class="status" id="status">
        <strong>🔧 Status:</strong>
        <span id="status-text">Initializing...</span>
      </div>

      <div class="instructions">
        <h2>📋 Test Instructions</h2>
        <ol class="step-list">
          <li>
            <strong>Step 1:</strong> Click "Open Classroom Modal" to launch the
            creation modal
          </li>
          <li>
            <strong>Step 2:</strong> Expand any category to see available
            scenarios
          </li>
          <li>
            <strong>Step 3:</strong> Click the "👁️ Preview" button next to any
            scenario
          </li>
          <li>
            <strong>Step 4:</strong> Verify that the scenario launches in the
            same way as other scenario launches
          </li>
          <li>
            <strong>Step 5:</strong> Check that the preview doesn't interfere
            with the classroom creation flow
          </li>
        </ol>
      </div>

      <div class="debug-info" id="debug-info">
        <strong>🔍 Debug Information:</strong><br />
        Loading system information...
      </div>

      <button id="open-classroom-modal" class="test-btn">
        🏫 Open Classroom Modal
      </button>

      <button id="initialize-app" class="test-btn secondary">
        🔄 Initialize App (if needed)
      </button>

      <button id="check-app-status" class="test-btn secondary">
        📊 Check App Status
      </button>

      <div id="modal-container"></div>
    </div>

    <script type="module">
      import ClassroomIntegrationManager from "./src/js/services/classroom-integration-manager.js";

      class PreviewTest {
        constructor() {
          this.classroomManager = null;
          this.init();
        }

        async init() {
          try {
            this.updateStatus("Initializing test environment...", false);

            // Mock services for testing
            const mockDataHandler = {
              getUserProfile: () =>
                Promise.resolve({
                  displayName: "Test Teacher",
                  role: "teacher",
                  uid: "test-preview-123",
                }),
            };

            const mockFirebaseService = {
              getCurrentUser: () => ({
                uid: "test-preview-123",
                displayName: "Test Teacher",
              }),
            };

            // Initialize classroom manager
            this.classroomManager = new ClassroomIntegrationManager(
              mockDataHandler,
              mockFirebaseService,
            );
            await this.classroomManager.initialize();

            this.updateStatus("✅ Ready for testing!", false);
            this.updateDebugInfo();
            this.setupEventListeners();
          } catch (error) {
            console.error("Initialization failed:", error);
            this.updateStatus(
              "❌ Initialization failed: " + error.message,
              true,
            );
          }
        }

        updateStatus(message, isError = false) {
          const statusElement = document.getElementById("status-text");
          const statusContainer = document.getElementById("status");

          statusElement.textContent = message;

          if (isError) {
            statusContainer.className = "status error";
          } else {
            statusContainer.className = "status";
          }
        }

        updateDebugInfo() {
          const debugElement = document.getElementById("debug-info");

          const appAvailable = typeof window.app !== "undefined";
          const categoryGridAvailable = appAvailable && window.app.categoryGrid;
          const launchMethodAvailable =
            categoryGridAvailable &&
            typeof window.app.categoryGrid.launchCoordinatedScenario ===
              "function";
          const openScenarioAvailable =
            categoryGridAvailable &&
            typeof window.app.categoryGrid.openScenario === "function";

          const debugInfo = `
<strong>🔍 Debug Information:</strong><br>
• App Available: ${appAvailable ? "✅" : "❌"}<br>
• CategoryGrid Available: ${categoryGridAvailable ? "✅" : "❌"}<br>
• launchCoordinatedScenario Available: ${launchMethodAvailable ? "✅" : "❌"}<br>
• openScenario Available: ${openScenarioAvailable ? "✅" : "❌"}<br>
• Classroom Manager: ${this.classroomManager ? "✅" : "❌"}<br>
• Teacher Modals: ${this.classroomManager?.teacherModals ? "✅" : "❌"}<br>
<br>
<strong>📊 Expected Preview Behavior:</strong><br>
${
  launchMethodAvailable
    ? "• Will use launchCoordinatedScenario (preferred)"
    : openScenarioAvailable
      ? "• Will use openScenario (fallback)"
      : "• Will show alert fallback (app not available)"
}
                `;

          debugElement.innerHTML = debugInfo;
        }

        setupEventListeners() {
          // Open classroom modal
          document
            .getElementById("open-classroom-modal")
            .addEventListener("click", async () => {
              try {
                if (this.classroomManager?.teacherModals) {
                  await this.classroomManager.teacherModals.showCreateClassroomModal(
                    false,
                  );
                  this.updateStatus(
                    "🏫 Classroom modal opened - try previewing scenarios!",
                    false,
                  );
                } else {
                  this.updateStatus("❌ Classroom manager not available", true);
                }
              } catch (error) {
                console.error("Error opening modal:", error);
                this.updateStatus(
                  "❌ Error opening modal: " + error.message,
                  true,
                );
              }
            });

          // Initialize app (if needed)
          document
            .getElementById("initialize-app")
            .addEventListener("click", async () => {
              try {
                this.updateStatus(
                  "🔄 Attempting to initialize main app...",
                  false,
                );

                // Try to load and initialize the main app
                if (typeof window.app === "undefined") {
                  // Dynamically import and initialize app
                  const { default: App } = await import("./src/js/app.js");
                  window.app = new App();
                  await window.app.initialize();
                  this.updateStatus(
                    "✅ Main app initialized successfully!",
                    false,
                  );
                } else {
                  this.updateStatus("ℹ️ Main app already available", false);
                }

                this.updateDebugInfo();
              } catch (error) {
                console.error("App initialization failed:", error);
                this.updateStatus(
                  "❌ App initialization failed: " + error.message,
                  true,
                );
              }
            });

          // Check app status
          document
            .getElementById("check-app-status")
            .addEventListener("click", () => {
              this.updateDebugInfo();
              this.updateStatus("📊 Debug information updated", false);
            });

          // Listen for scenario preview events
          document.addEventListener("click", (event) => {
            if (event.target.classList.contains("preview-scenario")) {
              const scenarioId = event.target.dataset.scenarioId;
              console.log(
                "👁️ Preview button clicked for scenario:",
                scenarioId,
              );

              // Update status to show preview action
              this.updateStatus(`👁️ Previewing scenario: ${scenarioId}`, false);

              // The preview will be handled by the TeacherClassroomModals handlePreviewScenario method
            }
          });
        }
      }

      // Start the test
      window.addEventListener("DOMContentLoaded", () => {
        new PreviewTest();
      });

      // Global error handling
      window.addEventListener("error", (e) => {
        console.error("Global error:", e.error);
        const statusElement = document.getElementById("status-text");
        if (statusElement) {
          statusElement.textContent = "❌ Error: " + e.error.message;
          document.getElementById("status").className = "status error";
        }
      });
    </script>
  </body>
</html>
