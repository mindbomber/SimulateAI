<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Floating Surprise Tab Fix Verification</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #27ae60;
        border-bottom: 3px solid #27ae60;
        padding-bottom: 10px;
      }

      .fix-summary {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        border: 1px solid #27ae60;
        color: #1b5e20;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .fix-summary h3 {
        margin-top: 0;
        color: #1b5e20;
        font-size: 18px;
      }

      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-radius: 8px;
        border-left: 4px solid #f39c12;
      }

      .test-button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .test-button:hover {
        background: linear-gradient(135deg, #2980b9, #1f639a);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .surprise-button {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        font-size: 16px;
        padding: 15px 30px;
      }

      .surprise-button:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
      }

      .logs {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
        margin: 10px 0;
        border: 1px solid #34495e;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-good {
        background-color: #27ae60;
      }

      .status-warning {
        background-color: #f39c12;
      }

      .status-error {
        background-color: #e74c3c;
      }

      .test-step {
        background: #ecf0f1;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
      }

      .test-step h4 {
        margin-top: 0;
        color: #2c3e50;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚úÖ Floating Surprise Tab - Fix Verification</h1>

      <div class="fix-summary">
        <h3>üîß Applied Fixes</h3>
        <ul>
          <li>
            <strong>Fix 1:</strong> Reduced cooldown from 2000ms to 500ms
            (prevents blocking consecutive uses)
          </li>
          <li>
            <strong>Fix 2:</strong> Added cooldown reset after scenario
            completion
          </li>
          <li>
            <strong>Fix 3:</strong> Added cooldown reset after reflection
            completion
          </li>
          <li>
            <strong>Fix 4:</strong> Ensured badge system is properly integrated
            with reflection modal
          </li>
        </ul>
      </div>

      <div class="test-section">
        <h3>üß™ Testing Instructions</h3>

        <div class="test-step">
          <h4>Step 1: Initial Test</h4>
          <p>
            Click the "Test Surprise Tab" button to trigger a random scenario.
          </p>
          <button
            class="test-button surprise-button"
            onclick="testSurpriseTab()"
          >
            üé≤ Test Surprise Tab
          </button>
        </div>

        <div class="test-step">
          <h4>Step 2: Complete Scenario</h4>
          <p>
            Complete the scenario that opens and go through the reflection
            modal.
          </p>
          <p>
            <strong>Expected:</strong> Badge modal should appear after
            reflection completion.
          </p>
        </div>

        <div class="test-step">
          <h4>Step 3: Test Multiple Clicks</h4>
          <p>
            After completing the scenario, try clicking the surprise tab
            multiple times quickly.
          </p>
          <p>
            <strong>Expected:</strong> Should show new scenarios (not be blocked
            by cooldown).
          </p>
          <button
            class="test-button surprise-button"
            onclick="testMultipleClicks()"
          >
            üéØ Test Multiple Clicks
          </button>
        </div>

        <div class="test-step">
          <h4>Step 4: Verify Badge System</h4>
          <p>Check that badges appear after reflection completion.</p>
          <button class="test-button" onclick="checkBadgeSystem()">
            üèÜ Check Badge System
          </button>
        </div>
      </div>

      <div class="test-section">
        <h3>üìä Debug Controls</h3>
        <button class="test-button" onclick="checkCooldownState()">
          ‚è±Ô∏è Check Cooldown State
        </button>
        <button class="test-button" onclick="resetCooldown()">
          üîÑ Reset Cooldown
        </button>
        <button class="test-button" onclick="checkProgressState()">
          üìà Check Progress
        </button>
        <button class="test-button" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
      </div>

      <div class="fix-summary">
        <h3>üìã Test Results</h3>
        <div id="testResults">
          <p>Complete the test steps above to see results...</p>
        </div>
      </div>

      <div class="test-section">
        <h3>üìù Debug Logs</h3>
        <div id="debugLogs" class="logs">
          Fix verification logs will appear here...
        </div>
      </div>
    </div>

    <!-- Load the main SimulateAI application -->
    <script type="module" src="src/js/app.js"></script>

    <script>
      let testResults = [];

      // Debug logging function
      function logDebug(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("debugLogs");
        const logLine = `[${timestamp}] ${message}${data ? "\n" + JSON.stringify(data, null, 2) : ""}`;

        console.log(message, data);
        logElement.textContent += logLine + "\n";
        logElement.scrollTop = logElement.scrollHeight;
      }

      // Update test results
      function updateTestResults(step, status, details) {
        testResults.push({
          step,
          status,
          details,
          timestamp: new Date().toLocaleTimeString(),
        });

        const resultsElement = document.getElementById("testResults");
        resultsElement.innerHTML = testResults
          .map(
            (result) => `
          <div style="margin: 10px 0; padding: 10px; background: ${result.status === "pass" ? "#e8f5e8" : result.status === "fail" ? "#ffebee" : "#fff3cd"}; border-radius: 4px;">
            <strong>${result.step}</strong> - <span style="color: ${result.status === "pass" ? "#27ae60" : result.status === "fail" ? "#e74c3c" : "#f39c12"};">${result.status.toUpperCase()}</span>
            <br><small>${result.details}</small>
            <br><em>Time: ${result.timestamp}</em>
          </div>
        `,
          )
          .join("");
      }

      // Test surprise tab
      function testSurpriseTab() {
        logDebug("üé≤ Testing floating surprise tab...");
        updateTestResults(
          "Surprise Tab Test",
          "running",
          "Triggering surprise tab...",
        );

        if (window.floatingSurpriseTab) {
          logDebug("‚úÖ FloatingSurpriseTab instance found");
          try {
            window.floatingSurpriseTab.triggerSurpriseMe();
            logDebug("‚úÖ triggerSurpriseMe called successfully");
            updateTestResults(
              "Surprise Tab Test",
              "pass",
              "Successfully triggered surprise tab",
            );
          } catch (error) {
            logDebug("‚ùå Error calling triggerSurpriseMe:", error);
            updateTestResults(
              "Surprise Tab Test",
              "fail",
              `Error: ${error.message}`,
            );
          }
        } else {
          logDebug("‚ùå FloatingSurpriseTab instance not found");
          updateTestResults(
            "Surprise Tab Test",
            "fail",
            "FloatingSurpriseTab instance not found",
          );
        }
      }

      // Test multiple clicks
      function testMultipleClicks() {
        logDebug("üéØ Testing multiple clicks...");
        updateTestResults(
          "Multiple Clicks Test",
          "running",
          "Testing rapid successive clicks...",
        );

        let successCount = 0;
        let attempts = 0;

        const testClick = () => {
          attempts++;
          logDebug(`Click attempt ${attempts}...`);

          if (window.floatingSurpriseTab) {
            try {
              window.floatingSurpriseTab.triggerSurpriseMe();
              successCount++;
              logDebug(`‚úÖ Click ${attempts} succeeded`);
            } catch (error) {
              logDebug(`‚ùå Click ${attempts} failed:`, error);
            }
          }

          if (attempts < 3) {
            setTimeout(testClick, 100); // Click every 100ms
          } else {
            const result =
              successCount === attempts
                ? "pass"
                : successCount > 0
                  ? "partial"
                  : "fail";
            updateTestResults(
              "Multiple Clicks Test",
              result,
              `${successCount}/${attempts} clicks succeeded`,
            );
          }
        };

        testClick();
      }

      // Check cooldown state
      function checkCooldownState() {
        logDebug("‚è±Ô∏è Checking cooldown state...");

        if (window.app) {
          const now = Date.now();
          const lastSurpriseTime = window.app.lastSurpriseTime || 0;
          const timeSinceLastSurprise = now - lastSurpriseTime;
          const cooldownRemaining = Math.max(0, 500 - timeSinceLastSurprise); // Updated to 500ms

          const cooldownInfo = {
            lastSurpriseTime: new Date(lastSurpriseTime).toLocaleTimeString(),
            timeSinceLastSurprise: `${timeSinceLastSurprise}ms`,
            cooldownRemaining: `${cooldownRemaining}ms`,
            canTriggerNow: cooldownRemaining === 0,
          };

          logDebug("‚è±Ô∏è Cooldown Info:", cooldownInfo);
          updateTestResults(
            "Cooldown Check",
            cooldownInfo.canTriggerNow ? "pass" : "warning",
            `${cooldownRemaining}ms remaining`,
          );
        } else {
          logDebug("‚ùå App instance not available for cooldown check");
          updateTestResults(
            "Cooldown Check",
            "fail",
            "App instance not available",
          );
        }
      }

      // Reset cooldown
      function resetCooldown() {
        logDebug("üîÑ Resetting cooldown...");

        if (window.app) {
          window.app.lastSurpriseTime = 0;
          logDebug("‚úÖ Cooldown reset - can trigger surprise immediately");
          updateTestResults(
            "Cooldown Reset",
            "pass",
            "Cooldown successfully reset",
          );
        } else {
          logDebug("‚ùå App instance not available for cooldown reset");
          updateTestResults(
            "Cooldown Reset",
            "fail",
            "App instance not available",
          );
        }
      }

      // Check progress state
      function checkProgressState() {
        logDebug("üìà Checking progress state...");

        const stored = localStorage.getItem("simulateai_category_progress");
        const userProgress = stored ? JSON.parse(stored) : {};

        logDebug("üìä User Progress Data:", userProgress);

        // Count completed scenarios
        let totalCompleted = 0;
        Object.values(userProgress).forEach((categoryProgress) => {
          Object.values(categoryProgress).forEach((isCompleted) => {
            if (isCompleted) totalCompleted++;
          });
        });

        logDebug(`üìà Total completed scenarios: ${totalCompleted}`);
        updateTestResults(
          "Progress Check",
          "pass",
          `${totalCompleted} scenarios completed`,
        );
      }

      // Check badge system
      function checkBadgeSystem() {
        logDebug("üèÜ Checking badge system...");

        const badgeState = {
          badgeModalExists: !!window.badgeModal,
          mainGridDeferredBadges: window.mainGrid
            ? window.mainGrid.deferredBadges.size
            : "N/A",
        };

        logDebug("üèÜ Badge System State:", badgeState);

        const status = badgeState.badgeModalExists ? "pass" : "fail";
        updateTestResults(
          "Badge System Check",
          status,
          `Badge modal: ${badgeState.badgeModalExists ? "Available" : "Not found"}, Deferred: ${badgeState.mainGridDeferredBadges}`,
        );
      }

      // Clear logs
      function clearLogs() {
        document.getElementById("debugLogs").textContent =
          "Fix verification logs cleared...\n";
      }

      // Listen for scenario completion events
      document.addEventListener("scenario-completed", (e) => {
        logDebug("üì° Received scenario-completed event:", e.detail);
        updateTestResults(
          "Scenario Completion",
          "pass",
          `Scenario ${e.detail.scenarioId} completed`,
        );
      });

      // Listen for reflection completion events
      document.addEventListener("scenarioReflectionCompleted", (e) => {
        logDebug("üì° Received scenarioReflectionCompleted event:", e.detail);
        updateTestResults(
          "Reflection Completion",
          "pass",
          `Reflection completed for ${e.detail.scenarioId}`,
        );
      });

      // Initialize when page loads
      window.addEventListener("load", () => {
        setTimeout(() => {
          logDebug("üöÄ Fix verification page initialized");
          logDebug("üîß Applied fixes:");
          logDebug("  - Reduced cooldown to 500ms");
          logDebug("  - Added cooldown reset after scenario completion");
          logDebug("  - Added cooldown reset after reflection completion");
          updateTestResults(
            "Initialization",
            "pass",
            "Fix verification page loaded successfully",
          );
        }, 1000);
      });
    </script>
  </body>
</html>
