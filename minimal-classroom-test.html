<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minimal Classroom Creation Test - SimulateAI</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
      }
      .test-box {
        border: 2px solid #007bff;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:disabled {
        background: #6c757d;
      }
      .result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üî¨ Minimal Classroom Creation Test</h1>

    <div class="test-box">
      <h3>Test 1: Service Loading</h3>
      <button onclick="testServiceLoading()">Load Services</button>
      <div id="service-result"></div>
    </div>

    <div class="test-box">
      <h3>Test 2: Direct Creation Call</h3>
      <button onclick="testDirectCreation()">Create Classroom Directly</button>
      <div id="creation-result"></div>
    </div>

    <div class="test-box">
      <h3>Test 3: Storage Check</h3>
      <button onclick="testStorageCheck()">Check LocalStorage</button>
      <div id="storage-result"></div>
    </div>

    <div class="test-box">
      <h3>Console Log:</h3>
      <div id="console-log" class="log"></div>
    </div>

    <script type="module">
      // Override console for debugging
      const log = console.log;
      const error = console.error;
      const warn = console.warn;

      function addToLog(level, ...args) {
        const logDiv = document.getElementById("console-log");
        const timestamp = new Date().toISOString().split("T")[1].split(".")[0];
        const entry = document.createElement("div");
        entry.style.color =
          level === "error" ? "red" : level === "warn" ? "orange" : "black";
        entry.textContent = `[${timestamp}] ${level.toUpperCase()}: ${args.join(" ")}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      console.log = (...args) => {
        log(...args);
        addToLog("log", ...args);
      };
      console.error = (...args) => {
        error(...args);
        addToLog("error", ...args);
      };
      console.warn = (...args) => {
        warn(...args);
        addToLog("warn", ...args);
      };

      let realtimeService;

      window.testServiceLoading = async function () {
        const resultDiv = document.getElementById("service-result");
        try {
          console.log("Loading RealtimeClassroomService...");
          const { default: RealtimeClassroomService } = await import(
            "./src/js/services/realtime-classroom-service.js"
          );

          realtimeService = new RealtimeClassroomService();
          console.log("Service instance created");

          const initialized = await realtimeService.initializeDatabase();
          console.log("Database initialization result:", initialized);

          if (realtimeService.fallbackMode) {
            console.log("Service is in fallback mode (localStorage)");
            resultDiv.innerHTML =
              '<div class="result success">‚úÖ Service loaded in fallback mode</div>';
          } else {
            console.log("Service is in Firebase mode");
            resultDiv.innerHTML =
              '<div class="result success">‚úÖ Service loaded in Firebase mode</div>';
          }

          return true;
        } catch (error) {
          console.error("Service loading failed:", error);
          resultDiv.innerHTML =
            '<div class="result error">‚ùå Service loading failed: ' +
            error.message +
            "</div>";
          return false;
        }
      };

      window.testDirectCreation = async function () {
        const resultDiv = document.getElementById("creation-result");

        if (!realtimeService) {
          resultDiv.innerHTML =
            '<div class="result error">‚ùå Service not loaded. Run Test 1 first.</div>';
          return;
        }

        try {
          console.log("Testing direct classroom creation...");

          const classroomData = {
            classroomName: "Test Classroom " + Date.now(),
            instructorId: "test_instructor_123",
            instructorName: "Test Instructor",
            selectedScenarios: [
              {
                scenarioId: "test-scenario-1",
                title: "Test Scenario",
                category: "ethics",
                order: 0,
              },
            ],
          };

          console.log("Classroom data:", classroomData);

          const result = await realtimeService.createClassroom(classroomData);
          console.log("Creation result:", result);

          if (result && result.classroomId) {
            resultDiv.innerHTML =
              '<div class="result success">‚úÖ Classroom created: ' +
              result.classroomCode +
              "</div>";
          } else {
            resultDiv.innerHTML =
              '<div class="result error">‚ùå Creation returned invalid result</div>';
          }
        } catch (error) {
          console.error("Creation failed:", error);
          resultDiv.innerHTML =
            '<div class="result error">‚ùå Creation failed: ' +
            error.message +
            "</div>";
        }
      };

      window.testStorageCheck = function () {
        const resultDiv = document.getElementById("storage-result");

        try {
          console.log("Checking localStorage...");

          const classrooms = localStorage.getItem("simulateai_classrooms");
          console.log("Raw localStorage data:", classrooms);

          if (classrooms) {
            const parsed = JSON.parse(classrooms);
            console.log("Parsed classrooms:", parsed);

            const count = Object.keys(parsed).length;
            resultDiv.innerHTML = `<div class="result success">‚úÖ Found ${count} classrooms in localStorage</div>`;
          } else {
            resultDiv.innerHTML =
              '<div class="result">‚ÑπÔ∏è No classrooms found in localStorage</div>';
          }
        } catch (error) {
          console.error("Storage check failed:", error);
          resultDiv.innerHTML =
            '<div class="result error">‚ùå Storage check failed: ' +
            error.message +
            "</div>";
        }
      };

      // Auto-load services on page load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Page loaded, ready for testing");
      });
    </script>
  </body>
</html>
