<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onboarding Tour Auto-Start Debug Tool</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
        line-height: 1.6;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
      }

      .debug-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #667eea;
      }

      .debug-section h3 {
        margin-top: 0;
        color: #333;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        margin: 8px 5px;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .button:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .button.secondary {
        background: #6c757d;
      }

      .button.secondary:hover {
        background: #5a6268;
      }

      .button.danger {
        background: #dc3545;
      }

      .button.danger:hover {
        background: #c82333;
      }

      .log-container {
        background: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.9rem;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 15px;
        border: 1px solid #4a5568;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #4a5568;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .log-timestamp {
        color: #a0aec0;
        font-size: 0.8rem;
      }

      .log-level {
        font-weight: bold;
        margin: 0 8px;
      }

      .log-level.info {
        color: #63b3ed;
      }
      .log-level.warn {
        color: #f6e05e;
      }
      .log-level.error {
        color: #fc8181;
      }
      .log-level.success {
        color: #68d391;
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .data-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .data-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
      }

      .data-value {
        font-family: monospace;
        background: white;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        word-break: break-all;
      }

      .fresh-browser-simulation {
        background: #e8f4f8;
        border: 2px solid #17a2b8;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }

      .fresh-browser-simulation h4 {
        color: #0c5460;
        margin-top: 0;
      }

      .scenario-button {
        display: block;
        width: 100%;
        margin: 10px 0;
        padding: 15px;
        text-align: left;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .scenario-button:hover {
        background: #e9ecef;
        border-color: #adb5bd;
      }

      .scenario-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
      }

      .scenario-description {
        font-size: 0.9rem;
        color: #6c757d;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        border-left: 4px solid;
      }

      .alert.warning {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
      }

      .alert.info {
        background: #d1ecf1;
        border-color: #17a2b8;
        color: #0c5460;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üöÄ Onboarding Tour Auto-Start Debug Tool</h1>
      <p>Testing automatic onboarding tour behavior for new users</p>
    </div>

    <div class="debug-section">
      <h3>üîç Current Status Analysis</h3>
      <div id="status-analysis">
        <p>Analyzing onboarding tour state...</p>
      </div>
    </div>

    <div class="debug-section">
      <h3>üóÉÔ∏è Storage State Analysis</h3>
      <div id="storage-analysis">
        <p>Checking localStorage and storage state...</p>
      </div>
    </div>

    <div class="debug-section">
      <h3>üèóÔ∏è Tour Instance Analysis</h3>
      <div id="instance-analysis">
        <p>Checking onboarding tour instance state...</p>
      </div>
    </div>

    <div class="fresh-browser-simulation">
      <h4>üåê Fresh Browser Session Testing</h4>
      <p>These buttons simulate what happens when a new user visits the app:</p>

      <button class="scenario-button" onclick="simulateFreshBrowser()">
        <div class="scenario-title">üîÑ Simulate Fresh Browser</div>
        <div class="scenario-description">
          Clear all localStorage data and test onboarding tour trigger logic
        </div>
      </button>

      <button class="scenario-button" onclick="testAutoStart()">
        <div class="scenario-title">üéØ Test Auto-Start Logic</div>
        <div class="scenario-description">
          Check if tour should start automatically based on current state
        </div>
      </button>

      <button class="scenario-button" onclick="debugTourState()">
        <div class="scenario-title">üîß Debug Tour State</div>
        <div class="scenario-description">
          Detailed analysis of tour initialization and state
        </div>
      </button>
    </div>

    <div class="debug-section">
      <h3>üéÆ Manual Tour Controls</h3>
      <button class="button" onclick="manualStartTour()">
        Start Tour Manually
      </button>
      <button class="button secondary" onclick="resetTourProgress()">
        Reset Tour Progress
      </button>
      <button class="button danger" onclick="clearAllStorage()">
        Clear All Storage
      </button>
      <button class="button" onclick="navigateToApp()">Go to App.html</button>
    </div>

    <div class="debug-section">
      <h3>üìä Real-Time Monitoring</h3>
      <div id="realtime-monitoring">
        <button class="button" onclick="startMonitoring()">
          Start Monitoring
        </button>
        <button class="button secondary" onclick="stopMonitoring()">
          Stop Monitoring
        </button>
      </div>
      <div class="log-container" id="log-container">
        <div class="log-entry">
          <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
          <span class="log-level info">[INFO]</span>
          Debug tool initialized
        </div>
      </div>
    </div>

    <script type="module">
      import logger from "./src/js/utils/logger.js";
      import { simpleStorage } from "./src/js/utils/simple-storage.js";
      import DataHandler from "./src/js/core/data-handler.js";

      // Global debug tool state
      window.debugTool = {
        monitoring: false,
        monitoringInterval: null,
        dataHandler: null,
      };

      // Initialize DataHandler for testing
      async function initializeDataHandler() {
        try {
          window.debugTool.dataHandler = new DataHandler({
            appName: "SimulateAI-Debug",
            version: "1.80",
            enableFirebase: true,
            enableCaching: true,
          });
          log("DataHandler initialized successfully", "success");
        } catch (error) {
          log(`DataHandler initialization failed: ${error.message}`, "error");
        }
      }

      // Initialize on load
      initializeDataHandler();

      // Logging function
      window.log = function (message, level = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logContainer = document.getElementById("log-container");
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry";
        logEntry.innerHTML = `
          <span class="log-timestamp">${timestamp}</span>
          <span class="log-level ${level}">[${level.toUpperCase()}]</span>
          ${message}
        `;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;

        // Also log to console
        console.log(`[DEBUG TOOL] ${message}`);
      };

      // Storage analysis function
      window.analyzeStorage = function () {
        const hasVisited = simpleStorage.get("has_visited", false);
        const tourCompleted = simpleStorage.get("tour_completed", false);

        const analysis = {
          hasVisited,
          tourCompleted,
          isFirstTimeVisit: !hasVisited,
          shouldStartTour: !hasVisited && !tourCompleted,
        };

        log(`Storage Analysis: ${JSON.stringify(analysis)}`, "info");
        return analysis;
      };

      // Fresh browser simulation
      window.simulateFreshBrowser = function () {
        log("üîÑ Simulating fresh browser session...", "info");

        // Clear all relevant localStorage keys
        const keysToRemove = [
          "has_visited",
          "tour_completed",
          "onboarding_tour_data",
          "app_settings",
          "user_preferences",
        ];

        keysToRemove.forEach((key) => {
          localStorage.removeItem(key);
          log(`Cleared localStorage key: ${key}`, "info");
        });

        // Re-analyze after clearing
        setTimeout(() => {
          updateStatusAnalysis();
          updateStorageAnalysis();
          log("Fresh browser simulation complete", "success");

          // Test if tour should auto-start now
          testAutoStart();
        }, 100);
      };

      // Test auto-start logic
      window.testAutoStart = function () {
        log("üéØ Testing auto-start logic...", "info");

        const analysis = analyzeStorage();

        if (analysis.isFirstTimeVisit) {
          log(
            "‚úÖ This is a first-time visit - tour SHOULD auto-start",
            "success",
          );

          // Check if we have an onboarding tour instance
          if (window.onboardingTourInstance) {
            const hasCompletedTour =
              window.onboardingTourInstance.hasCompletedTour();
            log(
              `Onboarding tour instance exists. Completed: ${hasCompletedTour}`,
              "info",
            );

            if (!hasCompletedTour) {
              log("üöÄ Tour should start automatically", "success");
            } else {
              log(
                "‚ùå Tour marked as completed - will not auto-start",
                "warning",
              );
            }
          } else {
            log("‚ùå No onboarding tour instance found", "error");
          }
        } else {
          log(
            "‚ùå Not a first-time visit - tour will NOT auto-start",
            "warning",
          );
        }
      };

      // Debug tour state
      window.debugTourState = function () {
        log("üîß Debugging tour state...", "info");

        // Check app instance
        if (window.app) {
          log("‚úÖ App instance found", "success");

          if (window.app.onboardingTour) {
            log("‚úÖ App has onboarding tour instance", "success");

            const tour = window.app.onboardingTour;
            log(`Tour active: ${tour.isActive}`, "info");
            log(`Current tutorial: ${tour.currentTutorial}`, "info");
            log(`Current step: ${tour.currentStep}`, "info");
          } else {
            log("‚ùå App does not have onboarding tour instance", "error");
          }
        } else {
          log("‚ùå No app instance found", "error");
        }

        // Check global instance
        if (window.onboardingTourInstance) {
          log("‚úÖ Global onboarding tour instance found", "success");

          const tour = window.onboardingTourInstance;
          log(`Global tour active: ${tour.isActive}`, "info");
        } else {
          log("‚ùå No global onboarding tour instance found", "error");
        }

        // Check if we're on app page
        const isAppPage =
          window.location.pathname.includes("app.html") ||
          document.querySelector(".categories-grid") !== null;
        log(`Is app page: ${isAppPage}`, isAppPage ? "success" : "warning");

        // Check page ready state
        log(`Document ready state: ${document.readyState}`, "info");
        log(`Page URL: ${window.location.href}`, "info");
      };

      // Manual tour start
      window.manualStartTour = function () {
        log("üöÄ Starting tour manually...", "info");

        if (
          window.app &&
          typeof window.app.startOnboardingTour === "function"
        ) {
          try {
            window.app.startOnboardingTour();
            log("‚úÖ Tour started via app.startOnboardingTour", "success");
          } catch (error) {
            log(`‚ùå Error starting tour: ${error.message}`, "error");
          }
        } else if (window.onboardingTourInstance) {
          try {
            window.onboardingTourInstance.startTour(1);
            log("‚úÖ Tour started via global instance", "success");
          } catch (error) {
            log(`‚ùå Error starting tour: ${error.message}`, "error");
          }
        } else {
          log("‚ùå No tour instance available", "error");
        }
      };

      // Reset tour progress
      window.resetTourProgress = function () {
        log("üîÑ Resetting tour progress...", "info");

        if (
          window.OnboardingTour &&
          typeof window.OnboardingTour.resetTour === "function"
        ) {
          window.OnboardingTour.resetTour();
          log("‚úÖ Tour progress reset", "success");
        } else {
          // Manual reset
          localStorage.removeItem("has_visited");
          localStorage.removeItem("tour_completed");
          localStorage.removeItem("onboarding_tour_data");
          log("‚úÖ Tour progress manually reset", "success");
        }

        updateStatusAnalysis();
        updateStorageAnalysis();
      };

      // Clear all storage
      window.clearAllStorage = function () {
        log("üóëÔ∏è Clearing all storage...", "warning");
        localStorage.clear();
        sessionStorage.clear();
        log("‚úÖ All storage cleared", "success");

        updateStatusAnalysis();
        updateStorageAnalysis();
      };

      // Navigate to app
      window.navigateToApp = function () {
        log("üîÑ Navigating to app.html...", "info");
        window.location.href = "/app.html";
      };

      // Start monitoring
      window.startMonitoring = function () {
        if (window.debugTool.monitoring) {
          log("Monitoring already active", "warning");
          return;
        }

        window.debugTool.monitoring = true;
        log("üìä Starting real-time monitoring...", "info");

        window.debugTool.monitoringInterval = setInterval(() => {
          updateStatusAnalysis();
          updateStorageAnalysis();
          updateInstanceAnalysis();
        }, 2000);
      };

      // Stop monitoring
      window.stopMonitoring = function () {
        if (!window.debugTool.monitoring) {
          log("Monitoring not active", "warning");
          return;
        }

        window.debugTool.monitoring = false;
        clearInterval(window.debugTool.monitoringInterval);
        log("üìä Stopped real-time monitoring", "info");
      };

      // Update status analysis
      function updateStatusAnalysis() {
        const container = document.getElementById("status-analysis");
        const analysis = analyzeStorage();

        const statusHtml = `
          <div class="data-grid">
            <div class="data-item">
              <div class="data-label">First Time Visit</div>
              <div class="data-value">
                <span class="status ${analysis.isFirstTimeVisit ? "success" : "warning"}">
                  ${analysis.isFirstTimeVisit ? "YES" : "NO"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">Should Auto-Start Tour</div>
              <div class="data-value">
                <span class="status ${analysis.shouldStartTour ? "success" : "error"}">
                  ${analysis.shouldStartTour ? "YES" : "NO"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">Page Type</div>
              <div class="data-value">
                ${window.location.pathname.includes("app.html") ? "App Page" : "Other Page"}
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">Document State</div>
              <div class="data-value">${document.readyState}</div>
            </div>
          </div>
        `;

        container.innerHTML = statusHtml;
      }

      // Update storage analysis
      function updateStorageAnalysis() {
        const container = document.getElementById("storage-analysis");
        const hasVisited = simpleStorage.get("has_visited", false);
        const tourCompleted = simpleStorage.get("tour_completed", false);

        const storageHtml = `
          <div class="data-grid">
            <div class="data-item">
              <div class="data-label">has_visited</div>
              <div class="data-value">
                <span class="status ${hasVisited ? "warning" : "success"}">
                  ${hasVisited ? "TRUE" : "FALSE"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">tour_completed</div>
              <div class="data-value">
                <span class="status ${tourCompleted ? "warning" : "success"}">
                  ${tourCompleted ? "TRUE" : "FALSE"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">localStorage Keys</div>
              <div class="data-value">${Object.keys(localStorage).length} keys</div>
            </div>
            <div class="data-item">
              <div class="data-label">Expected Behavior</div>
              <div class="data-value">
                ${!hasVisited && !tourCompleted ? "Tour should auto-start" : "Tour should NOT auto-start"}
              </div>
            </div>
          </div>
        `;

        container.innerHTML = storageHtml;
      }

      // Update instance analysis
      function updateInstanceAnalysis() {
        const container = document.getElementById("instance-analysis");

        const appExists = !!window.app;
        const appHasTour = appExists && !!window.app.onboardingTour;
        const globalTourExists = !!window.onboardingTourInstance;

        const instanceHtml = `
          <div class="data-grid">
            <div class="data-item">
              <div class="data-label">App Instance</div>
              <div class="data-value">
                <span class="status ${appExists ? "success" : "error"}">
                  ${appExists ? "EXISTS" : "NOT FOUND"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">App Tour Instance</div>
              <div class="data-value">
                <span class="status ${appHasTour ? "success" : "error"}">
                  ${appHasTour ? "EXISTS" : "NOT FOUND"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">Global Tour Instance</div>
              <div class="data-value">
                <span class="status ${globalTourExists ? "success" : "error"}">
                  ${globalTourExists ? "EXISTS" : "NOT FOUND"}
                </span>
              </div>
            </div>
            <div class="data-item">
              <div class="data-label">Tour Active</div>
              <div class="data-value">
                ${globalTourExists && window.onboardingTourInstance.isActive ? "YES" : "NO"}
              </div>
            </div>
          </div>
        `;

        container.innerHTML = instanceHtml;
      }

      // Initialize display
      updateStatusAnalysis();
      updateStorageAnalysis();
      updateInstanceAnalysis();

      // Add alerts for common issues
      const alertsContainer = document.createElement("div");
      alertsContainer.innerHTML = `
        <div class="alert info">
          <strong>üí° Testing Tips:</strong><br>
          1. Use "Simulate Fresh Browser" to test new user experience<br>
          2. Check that you're on app.html for tour initialization<br>
          3. Monitor console logs for detailed debugging information<br>
          4. Tour should auto-start when has_visited=false AND tour_completed=false
        </div>
        
        <div class="alert warning">
          <strong>‚ö†Ô∏è Common Issues:</strong><br>
          ‚Ä¢ Tour won't start if not on app.html page<br>
          ‚Ä¢ Tour won't start if has_visited=true in localStorage<br>
          ‚Ä¢ Tour won't start if tour_completed=true in localStorage<br>
          ‚Ä¢ Check that OnboardingTour instance is properly initialized in app.js
        </div>
      `;

      document
        .querySelector(".debug-section")
        .parentNode.insertBefore(
          alertsContainer,
          document.querySelector(".debug-section").nextSibling,
        );
    </script>
  </body>
</html>
