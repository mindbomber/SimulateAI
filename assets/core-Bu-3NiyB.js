var z=Object.defineProperty;var X=(p,e,t)=>e in p?z(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var U=(p,e,t)=>X(p,typeof e!="symbol"?e+"":e,t);import{U as V,F as Y,E as K}from"./ui-D3JF1NtD.js";class Z{constructor(){this.levels={ERROR:0,WARN:1,INFO:2,DEBUG:3,TRACE:4},this.currentLevel=this.detectEnvironment(),this.enabledTypes=new Set(["error","warn","info"]),this.isProduction()&&(this.enabledTypes=new Set(["error"]))}detectEnvironment(){return typeof window<"u"?window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes("dev")||window.location.search.includes("debug=true")?this.levels.DEBUG:this.levels.WARN:this.levels.WARN}isProduction(){return typeof window<"u"&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&!window.location.hostname.includes("dev")}formatMessage(e,t,i,r){const a=`[${new Date().toISOString()}] [${e.toUpperCase()}]`,n=t?` [${t}]`:"";return r!==void 0?[a+n,i,r]:[a+n,i]}log(e,t,i,r){if(!this.enabledTypes.has(e))return;const s=this.formatMessage(e,t,i,r);try{switch(e){case"error":console.error(...s);break;case"warn":console.warn(...s);break;case"info":console.info(...s);break;case"debug":console.log(...s);break;case"trace":console.trace(...s);break;default:console.log(...s)}}catch{try{console.log(...s)}catch{}}}error(e,t,i){this.log("error",e,t,i)}warn(e,t,i){this.log("warn",e,t,i)}info(e,t,i){this.log("info",e,t,i)}debug(e,t,i){this.log("debug",e,t,i)}trace(e,t,i){this.log("trace",e,t,i)}time(e){this.enabledTypes.has("debug")&&console.time(e)}timeEnd(e){this.enabledTypes.has("debug")&&console.timeEnd(e)}enable(e){this.enabledTypes.add(e)}disable(e){this.enabledTypes.delete(e)}enableDebug(){this.enabledTypes.add("debug"),this.enabledTypes.add("trace")}silent(){this.enabledTypes.clear(),this.enabledTypes.add("error")}}const d=new Z;typeof window<"u"&&(window.Logger=d);class q{constructor(){this.prefix="ai_ethics_",this.isLocalStorageAvailable=this.checkStorageAvailability("localStorage"),this.isSessionStorageAvailable=this.checkStorageAvailability("sessionStorage"),this.memoryStorage=new Map,this.init()}init(){d.info("Storage","Storage Status"),d.info("Storage","- localStorage",this.isLocalStorageAvailable?"✅ Available":"❌ Not available"),d.info("Storage","- sessionStorage",this.isSessionStorageAvailable?"✅ Available":"❌ Not available"),!this.isLocalStorageAvailable&&!this.isSessionStorageAvailable&&d.warn("⚠️  Browser storage not available. Using memory storage (data will not persist).")}checkStorageAvailability(e){try{const t=window[e];if(!t)return!1;const i="__storage_test__";return t.setItem(i,"test"),t.removeItem(i),!0}catch{return!1}}get(e,t=null){const i=this.prefix+e;try{if(this.isLocalStorageAvailable){const r=localStorage.getItem(i);if(r!==null)return JSON.parse(r)}if(this.isSessionStorageAvailable){const r=sessionStorage.getItem(i);if(r!==null)return JSON.parse(r)}if(this.memoryStorage.has(i))return this.memoryStorage.get(i)}catch(r){d.warn(`Error reading storage key "${e}":`,r)}return t}set(e,t){const i=this.prefix+e;let r=!1;try{this.isLocalStorageAvailable?(localStorage.setItem(i,JSON.stringify(t)),r=!0):this.isSessionStorageAvailable&&(sessionStorage.setItem(i,JSON.stringify(t)),r=!0),this.memoryStorage.set(i,t)}catch(s){d.warn(`Error saving storage key "${e}":`,s),this.memoryStorage.set(i,t)}return r}remove(e){const t=this.prefix+e;try{this.isLocalStorageAvailable&&localStorage.removeItem(t),this.isSessionStorageAvailable&&sessionStorage.removeItem(t),this.memoryStorage.delete(t)}catch(i){d.warn(`Error removing storage key "${e}":`,i)}}clear(){try{this.isLocalStorageAvailable&&Object.keys(localStorage).forEach(t=>{t.startsWith(this.prefix)&&localStorage.removeItem(t)}),this.isSessionStorageAvailable&&Object.keys(sessionStorage).forEach(t=>{t.startsWith(this.prefix)&&sessionStorage.removeItem(t)}),this.memoryStorage.clear()}catch(e){d.warn("Error clearing storage:",e)}}getAllKeys(){const e=new Set;try{this.isLocalStorageAvailable&&Object.keys(localStorage).forEach(t=>{t.startsWith(this.prefix)&&e.add(t.replace(this.prefix,""))}),this.isSessionStorageAvailable&&Object.keys(sessionStorage).forEach(t=>{t.startsWith(this.prefix)&&e.add(t.replace(this.prefix,""))}),this.memoryStorage.forEach((t,i)=>{i.startsWith(this.prefix)&&e.add(i.replace(this.prefix,""))})}catch(t){d.warn("Error getting storage keys:",t)}return Array.from(e)}getStorageInfo(){return{localStorageAvailable:this.isLocalStorageAvailable,sessionStorageAvailable:this.isSessionStorageAvailable,memoryStorageKeys:this.memoryStorage.size,allKeys:this.getAllKeys()}}}class J{constructor(e){this.storage=e}getTheme(){return this.storage.get("theme","light")}setTheme(e){this.storage.set("theme",e)}getLanguage(){return this.storage.get("language","en")}setLanguage(e){this.storage.set("language",e)}getAccessibilitySettings(){return this.storage.get("accessibility",{})}setAccessibilitySettings(e){this.storage.set("accessibility",e)}getPreLaunchSettings(){return this.storage.get("preLaunchSettings",{skipPreLaunch:!1,skipPreLaunchFor:{},alwaysShowEducatorResources:!0})}setPreLaunchSettings(e){this.storage.set("preLaunchSettings",e)}shouldSkipPreLaunch(e=null){const t=this.getPreLaunchSettings();return e?t.skipPreLaunch||t.skipPreLaunchFor[e]:t.skipPreLaunch}setSkipPreLaunchFor(e,t=!0){const i=this.getPreLaunchSettings();i.skipPreLaunchFor[e]=t,this.setPreLaunchSettings(i)}setSkipPreLaunchGlobally(e=!0){const t=this.getPreLaunchSettings();t.skipPreLaunch=e,this.setPreLaunchSettings(t)}getAllPreferences(){return{theme:this.getTheme(),language:this.getLanguage(),accessibility:this.getAccessibilitySettings(),preLaunch:this.getPreLaunchSettings()}}}class Q{constructor(e){this.storage=e}getSimulationProgress(e){return this.storage.get(`progress_${e}`,{completed:!1,score:0,scenarios:[],timeSpent:0,lastPlayed:null})}setSimulationProgress(e,t){this.storage.set(`progress_${e}`,{...t,lastPlayed:new Date().toISOString()})}getOverallStats(){return this.storage.get("overall_stats",{totalSimulations:0,totalTimeSpent:0,averageScore:0,completedSimulations:[],achievements:[]})}setOverallStats(e){this.storage.set("overall_stats",e)}getAllProgress(){const t=this.storage.getAllKeys().filter(r=>r.startsWith("progress_")),i={};return t.forEach(r=>{const s=r.replace("progress_","");i[s]=this.getSimulationProgress(s)}),{simulations:i,overall:this.getOverallStats()}}}const v=new q,k=new J(v),j=new Q(v);window.SimpleStorage={manager:v,preferences:k,progress:j};d.info("Storage","✅ Simple Storage Manager initialized");const N={MAX_EVENTS:100,SESSION_ID_RADIX:36,SESSION_ID_SUFFIX_START:2,SESSION_ID_SUFFIX_LENGTH:11,AUTO_SAVE_INTERVAL:3e4};class ee{constructor(){this.enabled=!0,this.events=[],this.maxEvents=N.MAX_EVENTS,this.sessionId=this.generateSessionId(),this.startTime=Date.now(),d.info("Analytics","📊 Simple Analytics Manager initialized")}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(N.SESSION_ID_RADIX).substring(N.SESSION_ID_SUFFIX_START,N.SESSION_ID_SUFFIX_LENGTH)}`}isEnabled(){try{return k.getAllPreferences().analytics!==!1&&this.enabled}catch{return this.enabled}}trackEvent(e,t={}){if(this.isEnabled())try{const i={name:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,url:window.location.href};this.events.push(i),this.events.length>this.maxEvents&&(this.events=this.events.slice(-this.maxEvents)),d.info("📊 Event tracked:",e,t)}catch(i){d.warn("Error tracking event:",i)}}trackPageView(e=window.location.pathname){this.trackEvent("page_view",{page:e})}trackSimulationStart(e,t={}){this.trackEvent("simulation_start",{simulationId:e,...t})}trackSimulationComplete(e,t={}){this.trackEvent("simulation_complete",{simulationId:e,score:t.score||0,timeSpent:t.timeSpent||0,scenarios:t.scenarios||[],...t})}trackInteraction(e,t,i={}){this.trackEvent("user_interaction",{type:e,target:t,...i})}trackPerformance(e,t,i={}){this.trackEvent("performance",{metric:e,value:t,...i})}trackAccessibility(e,t,i={}){this.trackEvent("accessibility",{feature:e,enabled:t,...i})}trackError(e,t={}){this.trackEvent("error",{message:e.message||String(e),stack:e.stack||"No stack trace",...t})}getSessionSummary(){const e=this.events.filter(i=>i.sessionId===this.sessionId),t=Date.now()-this.startTime;return{sessionId:this.sessionId,duration:t,eventCount:e.length,events:e,startTime:this.startTime,endTime:Date.now()}}getAllEvents(){return[...this.events]}clearEvents(){this.events=[],d.info("📊 Analytics events cleared")}saveEvents(){try{const e=this.getSessionSummary();v.set("analytics_session",e),v.set("analytics_events",this.events)}catch(e){d.warn("Error saving analytics events:",e)}}loadEvents(){try{const e=v.get("analytics_events",[]),t=v.get("analytics_session",null);e.length>0&&(this.events=e,d.info("📊 Loaded",e.length,"analytics events")),t&&d.info("📊 Previous session:",t)}catch(e){d.warn("Error loading analytics events:",e)}}async init(){try{this.loadEvents(),this.trackPageView(),setInterval(()=>{this.saveEvents()},N.AUTO_SAVE_INTERVAL),window.addEventListener("beforeunload",()=>{this.saveEvents()}),d.info("Analytics","📊 Simple Analytics Manager ready")}catch(e){d.warn("Error initializing analytics:",e)}}setEnabled(e){this.enabled=e,d.info("📊 Analytics",e?"enabled":"disabled");try{const t=k.getAllPreferences();t.analytics=e}catch(t){d.warn("Error saving analytics preference:",t)}}}const w=new ee;window.AnalyticsManager=w;window.SimpleAnalytics=w;w.init();d.info("Analytics","✅ Simple Analytics Manager loaded");const fe={FAST:300,SECONDS_PER_MINUTE:60},Ee={MOBILE:768,TABLET:992},pe={ETHICAL_EXCELLENT:.9,ETHICAL_GOOD:.7,ETHICAL_AVERAGE:.5,SCORE_EXCELLENT:.8,SCORE_GOOD:.6,SCORE_AVERAGE:.4},b={BOUNCE_C4:2.75,BOUNCE_C5:7.5625},A={HALF:.5,THREE_QUARTERS:.75,ONE_TENTH:.1,ONE_AND_HALF:1.5,TWO_AND_HALF:2.5,TWO_AND_QUARTER:2.25,TWO_AND_FIVE_EIGHTHS:2.625,FIFTEEN_SIXTEENTHS:.9375,SIXTYTHREE_SIXTYFOURTHS:.984375,TWO:2,FOUR:4,EIGHT:8,MILLISECONDS_100:100,MILLISECONDS_2000:2e3,OPACITY_30:.3,OPACITY_40:.4,OPACITY_80:.8,HOURS_24:24,MINUTES_60:60},I={DEFAULT_DURATION:300,DEFAULT_METRIC_VALUE:50,FEEDBACK_PANEL_WIDTH:220,FEEDBACK_PANEL_MARGIN:10,ETHICS_PANEL_WIDTH:250,ETHICS_PANEL_HEIGHT:150,ETHICS_PANEL_Y_OFFSET:420,ETHICS_PANEL_WIDTH_OFFSET:240,UI_POSITIONS:{CONTROL_PANEL:{x:10,y:10},INFO_PANEL:{x:10,y:170}},UI_SIZES:{CONTROL_PANEL:{width:200,height:150},INFO_PANEL:{width:200,height:300}},INITIAL_VALUES:{SCENARIO_INDEX:0,SCORE:0,TIME_ELAPSED:0,METRIC_MIN:0,METRIC_MAX:100,DEFAULT_WEIGHT:1}};class ge{constructor(e,t={}){this.id=e,this.title=t.title||"Untitled Simulation",this.description=t.description||"",this.difficulty=t.difficulty||"beginner",this.duration=t.duration||I.DEFAULT_DURATION,this.tags=t.tags||[],this.ethicsMetrics=new Map,this.ethicsHistory=[],this.currentScenario=I.INITIAL_VALUES.SCENARIO_INDEX,this.scenarios=t.scenarios||[],this.state={started:!1,completed:!1,paused:!1,score:I.INITIAL_VALUES.SCORE,decisions:[],timeElapsed:I.INITIAL_VALUES.TIME_ELAPSED},this.engine=null,this.components=[],this.events=new Map,this.initializeEthicsMetrics(t.ethicsMetrics||[])}initializeEthicsMetrics(e){[...[{name:"fairness",label:"Fairness",value:I.DEFAULT_METRIC_VALUE,weight:I.INITIAL_VALUES.DEFAULT_WEIGHT},{name:"transparency",label:"Transparency",value:I.DEFAULT_METRIC_VALUE,weight:I.INITIAL_VALUES.DEFAULT_WEIGHT},{name:"privacy",label:"Privacy",value:I.DEFAULT_METRIC_VALUE,weight:I.INITIAL_VALUES.DEFAULT_WEIGHT},{name:"accountability",label:"Accountability",value:I.DEFAULT_METRIC_VALUE,weight:I.INITIAL_VALUES.DEFAULT_WEIGHT}],...e].forEach(r=>{this.ethicsMetrics.set(r.name,{label:r.label,value:r.value||I.DEFAULT_METRIC_VALUE,min:r.min||I.INITIAL_VALUES.METRIC_MIN,max:r.max||I.INITIAL_VALUES.METRIC_MAX,weight:r.weight||I.INITIAL_VALUES.DEFAULT_WEIGHT,description:r.description||""})})}init(e){this.engine=e,this.setupUI(),this.setupEthicsDisplay(),this.loadScenario(I.INITIAL_VALUES.SCENARIO_INDEX),this.startTime=Date.now(),this.emit("simulation:initialized")}setupUI(){this.createControlPanel(),this.createInformationPanel(),this.createFeedbackSystem()}createControlPanel(){const e=new V({id:"control-panel",position:I.UI_POSITIONS.CONTROL_PANEL,size:I.UI_SIZES.CONTROL_PANEL,title:"Controls"});e.addButton("Reset",()=>this.reset()),e.addButton("Pause",()=>this.togglePause()),e.addButton("Help",()=>this.showHelp()),this.controlPanel=e,this.engine.addComponent(e)}createInformationPanel(){const e=new V({id:"info-panel",position:I.UI_POSITIONS.INFO_PANEL,size:I.UI_SIZES.INFO_PANEL,title:"Information"});this.informationPanel=e,this.engine.addComponent(e)}createFeedbackSystem(){if(!this.engine||!this.engine.config){this.handleError("Engine not properly initialized for feedback system");return}this.feedbackSystem=new Y({position:{x:this.engine.config.width-I.FEEDBACK_PANEL_WIDTH,y:I.FEEDBACK_PANEL_MARGIN},size:{width:200,height:400}}),this.engine.addComponent(this.feedbackSystem)}setupEthicsDisplay(){if(!this.engine||!this.engine.config){this.handleError("Engine not properly initialized for ethics display");return}this.ethicsDisplay=new K({metrics:this.ethicsMetrics,position:{x:this.engine.config.width-I.ETHICS_PANEL_WIDTH,y:I.ETHICS_PANEL_Y_OFFSET},size:{width:I.ETHICS_PANEL_WIDTH_OFFSET,height:I.ETHICS_PANEL_HEIGHT}}),this.engine.addComponent(this.ethicsDisplay)}loadScenario(e){if(!this.scenarios||!Array.isArray(this.scenarios)){this.handleError("Scenarios not properly initialized");return}if(e>=this.scenarios.length){this.completeSimulation();return}if(e<0){this.handleError(`Invalid scenario index: ${e}`);return}this.currentScenario=e;const t=this.scenarios[e];if(!t){this.handleError(`Scenario not found at index: ${e}`);return}this.clearScenarioComponents(),this.setupScenarioComponents(t),this.updateInformationPanel(t),this.emit("scenario:loaded",{scenario:t,index:e})}clearScenarioComponents(){this.components.forEach(e=>{e.isScenarioComponent&&this.engine.removeComponent(e)}),this.components=this.components.filter(e=>!e.isScenarioComponent)}setupScenarioComponents(e){}updateInformationPanel(e){if(!this.informationPanel){this.handleError("Information panel not initialized");return}if(!e){this.handleError("Cannot update information panel: scenario is null/undefined");return}const t=e.title||"Unknown Scenario",i=e.description||"No description available",r=e.objective||"No objective specified";this.informationPanel.setContent(`
            <h3>${t}</h3>
            <p>${i}</p>
            <div class="scenario-info">
                <p><strong>Objective:</strong> ${r}</p>
                <p><strong>Scenario ${this.currentScenario+1}</strong> of ${this.scenarios.length}</p>
            </div>
        `)}updateEthicsMetric(e,t,i=""){const r=this.ethicsMetrics.get(e);if(!r){this.handleError(`Ethics metric '${e}' not found`);return}const s=r.value;r.value=Math.max(r.min,Math.min(r.max,r.value+t));const a={timestamp:Date.now(),metric:e,oldValue:s,newValue:r.value,change:t,reasoning:i,scenario:this.currentScenario};this.ethicsHistory.push(a),this.logEthicalDecision(e,t,i),this.ethicsDisplay&&this.ethicsDisplay.updateMetric(e,r.value),this.provideFeedback(e,t,i),this.emit("ethics:updated",a)}logEthicalDecision(e,t,i){const r={timestamp:Date.now(),simulationId:this.id,scenario:this.currentScenario,category:e,change:t,reasoning:i,state:{...this.state},allMetrics:Object.fromEntries(this.ethicsMetrics)};try{v.set(`decision_${this.id}_${Date.now()}`,r)}catch(s){this.handleError("Failed to log decision to storage",s)}try{w.trackEvent("ethics_decision",r)}catch(s){this.handleError("Failed to track decision in analytics",s)}}provideFeedback(e,t,i){if(!this.feedbackSystem)return;const r=this.ethicsMetrics.get(e),s=t>0;let a="",n=s?"positive":"negative";Math.abs(t)>10&&(n=s?"excellent":"concerning"),a=`${r.label} ${s?"improved":"decreased"} by ${Math.abs(t)} points.`,i&&(a+=` ${i}`),this.feedbackSystem.addFeedback(a,n)}makeDecision(e,t,i={}){const r={id:e,choice:t,timestamp:Date.now(),scenario:this.currentScenario,impact:i};return this.state.decisions.push(r),Object.entries(i).forEach(([s,a])=>{typeof a=="object"?this.updateEthicsMetric(s,a.value,a.reasoning):this.updateEthicsMetric(s,a)}),this.emit("decision:made",r),r}start(){this.state.started||(this.state.started=!0,this.state.paused=!1,this.startTime=Date.now(),this.emit("simulation:started"))}pause(){this.state.paused=!0,this.emit("simulation:paused")}resume(){this.state.paused=!1,this.emit("simulation:resumed")}togglePause(){this.state.paused?this.resume():this.pause()}reset(){this.state={started:!1,completed:!1,paused:!1,score:0,decisions:[],timeElapsed:0},this.ethicsMetrics.forEach(e=>{e.value=50}),this.ethicsHistory=[],this.currentScenario=0,this.loadScenario(0),this.emit("simulation:reset")}nextScenario(){this.currentScenario<this.scenarios.length-1?this.loadScenario(this.currentScenario+1):this.completeSimulation()}completeSimulation(){this.state.completed=!0,this.state.timeElapsed=Date.now()-this.startTime,this.calculateFinalScore();const e=this.generateCompletionReport();this.emit("simulation:completed",{score:this.state.score,report:e})}calculateFinalScore(){if(!this.ethicsMetrics||this.ethicsMetrics.size===0){this.handleError("No ethics metrics available for score calculation"),this.state.score=0;return}let e=0,t=0;if(this.ethicsMetrics.forEach(i=>{typeof i.value=="number"&&typeof i.weight=="number"&&(e+=i.value*i.weight,t+=i.weight)}),t===0){this.handleError("Total weight is zero, cannot calculate score"),this.state.score=0;return}this.state.score=Math.round(e/t)}generateCompletionReport(){return{simulationId:this.id,title:this.title,duration:this.state.timeElapsed,score:this.state.score,decisions:this.state.decisions.length,ethicsMetrics:Object.fromEntries(this.ethicsMetrics),ethicsHistory:this.ethicsHistory,scenarios:this.scenarios.length,completedAt:new Date().toISOString()}}on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}emit(e,t={}){this.events.has(e)&&this.events.get(e).forEach(i=>{try{i(t)}catch(r){this.handleError(`Error in event handler for ${e}`,r)}})}getAccessibilityDescription(){return`${this.title}: ${this.description}. Current ethics scores: ${Array.from(this.ethicsMetrics.entries()).map(([e,t])=>`${t.label}: ${t.value}`).join(", ")}`}update(e){!this.state.started||this.state.paused||this.state.completed||(this.state.timeElapsed+=e,this.updateSimulation(e))}updateSimulation(e){}showHelp(){this.emit("help:requested")}getProgress(){const e=this.scenarios?this.scenarios.length:0,t=Math.max(0,this.currentScenario);return e===0?{scenario:0,totalScenarios:0,percentage:0}:{scenario:t+1,totalScenarios:e,percentage:(t+1)/e*100}}handleError(e,t=null){const i={simulationId:this.id,message:e,error:t?.message||"Unknown error",timestamp:Date.now(),scenario:this.currentScenario};try{w.trackEvent("simulation_error",i)}catch{}this.emit("error",i)}destroy(){try{this.clearScenarioComponents(),this.engine&&(this.controlPanel&&this.engine.removeComponent(this.controlPanel),this.informationPanel&&this.engine.removeComponent(this.informationPanel),this.feedbackSystem&&this.engine.removeComponent(this.feedbackSystem),this.ethicsDisplay&&this.engine.removeComponent(this.ethicsDisplay)),this.events.clear(),this.state=null,this.ethicsMetrics.clear(),this.ethicsHistory=[],this.components=[],typeof process<"u"}catch(e){this.handleError("Error during simulation cleanup",e)}}}const g={DEFAULT_DURATION:300,REDUCED_MOTION_DURATION:50,MAX_ANIMATIONS_PER_FRAME:50,FRAME_TIME_LIMIT:16,PERFORMANCE_WARNING_THRESHOLD:32,MEMORY_CLEANUP_INTERVAL:3e4,THROTTLE_DELAY:16,TOUCH_GESTURE_THRESHOLD:50,PERFORMANCE_WARNING_LIMIT:5,PERFORMANCE_RESET_DELAY:5e3,CLEANUP_DELAY:1500,PROPERTY_SIZE_MULTIPLIER:128,HISTORY_CUTOFF_TIME:6e4,HEX_SHORT_LENGTH:3,HEX_LONG_LENGTH:6,HEX_SLICE_END_SHORT:4,TRANSITION_MIDPOINT:.5,SCALE_DURATION_MULTIPLIER:.8,REDUCED_SHAKE_COUNT:3,NORMAL_SHAKE_COUNT:10,FADE_DURATION_MULTIPLIER:.5,SWIPE_DISTANCE:50,PINCH_IN_SCALE:.8,PINCH_OUT_SCALE:1.2},$={accessibility:"easeInOut",reduced:"linear"};class F{static getCurrentTheme(){const e=window.matchMedia?.("(prefers-reduced-motion: reduce)").matches,t=window.matchMedia?.("(prefers-contrast: high)").matches;return{reducedMotion:e,highContrast:t,theme:t?"highContrast":"light"}}static getAnimationConfig(e=null){const t=e||this.getCurrentTheme();return{duration:t.reducedMotion?g.REDUCED_MOTION_DURATION:g.DEFAULT_DURATION,easing:t.reducedMotion?$.reduced:$.accessibility,enabled:!t.reducedMotion,respectSystemPreferences:!0}}}class B{static startOperation(e){const t=performance.now();return this.metrics.set(e,{startTime:t,operations:(this.metrics.get(e)?.operations||0)+1}),t}static endOperation(e,t=null){const i=performance.now(),r=this.metrics.get(e);if(r){const s=i-(t||r.startTime);r.lastDuration=s,r.averageDuration=((r.averageDuration||0)*(r.operations-1)+s)/r.operations,s>g.PERFORMANCE_WARNING_THRESHOLD&&d.warn(`Slow animation operation: ${e} took ${s.toFixed(2)}ms`)}}static trackMemory(e,t){this.memoryTracker.set(e,{size:t,timestamp:Date.now()})}static releaseMemory(e){this.memoryTracker.delete(e)}static getMetrics(){return{operations:Object.fromEntries(this.metrics),memory:{trackedAnimations:this.memoryTracker.size,totalMemoryEstimate:Array.from(this.memoryTracker.values()).reduce((e,t)=>e+t.size,0)}}}}U(B,"metrics",new Map),U(B,"memoryTracker",new Map);class L extends Error{constructor(e,t={},i=null){super(e),this.name="AnimationError",this.context=t,this.originalError=i,this.timestamp=new Date().toISOString(),this.animationId=t.animationId,this.theme=F.getCurrentTheme()}}class D{constructor(e){this.engine=e,this.animations=new Map,this.timelines=new Map,this.activeAnimations=new Set,this.animationId=0,this.theme=F.getCurrentTheme(),this.performanceMonitor=B,this.renderCache=new Map,this.maxAnimationsPerFrame=g.MAX_ANIMATIONS_PER_FRAME,this.frameTimeLimit=g.FRAME_TIME_LIMIT,this.accessibilityEnabled=!0,this.reducedMotionMode=this.theme.reducedMotion,this.announcements=[],this.errorCount=0,this.lastError=null,this.memoryCleanupInterval=null,this.gestureAnimations=new Map,this.settings=this.loadSettings(),this.init()}init(){const e=this.performanceMonitor.startOperation("animation-manager-init");try{this.setupThemeIntegration(),this.setupAccessibilityFeatures(),this.setupPerformanceMonitoring(),this.setupMemoryManagement(),this.setupEventListeners(),d.info("Animation","Enhanced AnimationManager initialized with accessibility and performance features")}catch(t){this.handleError(new L("Failed to initialize AnimationManager",{engine:this.engine},t))}finally{this.performanceMonitor.endOperation("animation-manager-init",e)}}setupThemeIntegration(){const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=window.matchMedia("(prefers-contrast: high)"),i=()=>{this.theme=F.getCurrentTheme(),this.reducedMotionMode=this.theme.reducedMotion,this.updateAnimationDefaults(),this.announceThemeChange()};e.addEventListener&&(e.addEventListener("change",i),t.addEventListener("change",i)),this.themeListeners={reducedMotionQuery:e,contrastQuery:t,updateTheme:i}}setupAccessibilityFeatures(){this.createAccessibilityRegion(),this.accessibilityConfig={announceAnimations:this.settings.announceAnimations!==!1,respectReducedMotion:this.settings.respectReducedMotion!==!1,enableKeyboardControls:this.settings.enableKeyboardControls!==!1}}createAccessibilityRegion(){if(typeof document>"u")return;let e=document.getElementById("animation-announcements");e||(e=document.createElement("div"),e.id="animation-announcements",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",e.style.cssText=`
                position: absolute !important;
                left: -10000px !important;
                width: 1px !important;
                height: 1px !important;
                overflow: hidden !important;
            `,document.body.appendChild(e)),this.accessibilityRegion=e}setupPerformanceMonitoring(){this.performanceConfig={trackRenderTime:!0,trackMemoryUsage:!0,enableWarnings:!0,maxAnimationDuration:this.reducedMotionMode?A.MILLISECONDS_100:A.MILLISECONDS_2000}}setupMemoryManagement(){this.memoryCleanupInterval=setInterval(()=>{this.performMemoryCleanup()},g.MEMORY_CLEANUP_INTERVAL)}setupEventListeners(){typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.hidden?this.pauseAllAnimations():this.resumeAllAnimations()})}updateAnimationDefaults(){const e=F.getAnimationConfig(this.theme);this.defaultDuration=e.duration,this.defaultEasing=e.easing,this.animationsEnabled=e.enabled||this.settings.forceAnimations}announceThemeChange(){this.accessibilityConfig.announceAnimations&&this.announce(`Animation theme updated: ${this.theme.theme} mode, reduced motion: ${this.reducedMotionMode?"on":"off"}`)}animate(e,t,i=null,r={}){const s=this.performanceMonitor.startOperation("create-animation");try{if(!e||!t)throw new L("Invalid animation parameters",{target:e,properties:t});const a=i||this.defaultDuration||g.DEFAULT_DURATION,n=this.reducedMotionMode?Math.min(a,g.REDUCED_MOTION_DURATION):a;if(!this.animationsEnabled&&!r.force)return r.onComplete&&setTimeout(()=>r.onComplete(e),0),null;const o={id:++this.animationId,target:e,properties:this.processProperties(e,t),duration:Math.max(n,1),startTime:performance.now(),elapsed:0,progress:0,easing:r.easing||this.defaultEasing||"easeInOut",delay:r.delay||0,repeat:r.repeat||0,yoyo:r.yoyo||!1,onStart:r.onStart||null,onUpdate:r.onUpdate||null,onComplete:r.onComplete||null,onRepeat:r.onRepeat||null,onError:r.onError||null,announceStart:r.announceStart||!1,announceComplete:r.announceComplete||!1,description:r.description||"",started:!1,completed:!1,paused:!1,repeatCount:0,direction:1,createdAt:Date.now(),performanceWarnings:0};return this.animations.set(o.id,o),this.activeAnimations.add(o.id),this.performanceMonitor.trackMemory(o.id,this.estimateAnimationMemory(o)),o.announceStart&&o.description&&this.announce(`Starting animation: ${o.description}`),o.id}catch(a){return this.handleError(new L("Failed to create animation",{target:e,properties:t,duration:i,options:r},a)),null}finally{this.performanceMonitor.endOperation("create-animation",s)}}to(e,t,i,r={}){return this.animate(e,t,i,r)}from(e,t,i,r={}){const s={};return Object.keys(t).forEach(a=>{s[a]=e[a]||0,e[a]=t[a]}),this.animate(e,s,i,r)}createTimeline(e={}){const t={id:++this.animationId,animations:[],duration:0,startTime:0,elapsed:0,progress:0,repeat:e.repeat||0,yoyo:e.yoyo||!1,onStart:e.onStart||null,onUpdate:e.onUpdate||null,onComplete:e.onComplete||null,started:!1,completed:!1,paused:!1};return this.timelines.set(t.id,t),t.id}addToTimeline(e,t,i,r,s=0,a={}){const n=this.timelines.get(e);if(!n)return null;const o={target:t,properties:this.processProperties(t,i),duration:r,delay:s,easing:a.easing||"easeInOut",onStart:a.onStart||null,onUpdate:a.onUpdate||null,onComplete:a.onComplete||null,started:!1,completed:!1};return n.animations.push(o),n.duration=Math.max(n.duration,s+r),o}playTimeline(e){const t=this.timelines.get(e);t&&(t.startTime=performance.now(),t.started=!0,t.completed=!1,t.onStart&&t.onStart(t))}pause(e){const t=this.animations.get(e);t&&(t.paused=!0)}resume(e){const t=this.animations.get(e);if(t&&t.paused){t.paused=!1;const i=performance.now();t.startTime=i-t.elapsed}}stop(e){const t=this.animations.get(e);t&&(t.completed=!0,this.activeAnimations.delete(e))}stopAll(){this.activeAnimations.forEach(e=>this.stop(e))}update(e){const t=this.performanceMonitor.startOperation("animation-update");let i=0,r=0;try{for(const a of this.activeAnimations){if(i>=this.maxAnimationsPerFrame||performance.now()-t.startTime>this.frameTimeLimit)break;const n=this.animations.get(a);if(n&&!n.paused)try{this.updateAnimation(n,e),i++}catch(o){r++,this.handleAnimationError(n,o)}}this.timelines.forEach(a=>{if(a.started&&!a.completed&&!a.paused)try{this.updateTimeline(a,e)}catch(n){r++,this.handleTimelineError(a,n)}}),this.cleanupCompleted();const s=performance.now()-t.startTime;s>this.frameTimeLimit*2&&d.warn(`Animation frame took ${s.toFixed(2)}ms (processed ${i} animations)`)}catch(s){this.handleError(new L("Animation update failed",{processedCount:i,errorCount:r},s))}finally{this.performanceMonitor.endOperation("animation-update",t)}}updateAnimation(e,t){const i=performance.now();try{if(!e.started)if(i-e.startTime>=e.delay)e.started=!0,e.startTime=i,e.onStart&&e.onStart(e.target,e),e.announceStart&&e.description&&this.announce(`Animation started: ${e.description}`);else return;e.elapsed=i-e.startTime,e.progress=Math.min(Math.max(e.elapsed/e.duration,0),1);const r=this.applyEasing(e.progress,e.easing);if(this.updateProperties(e,r),e.onUpdate)try{e.onUpdate(e.target,e.progress,e)}catch(s){e.performanceWarnings++,e.onError&&e.onError(s,e)}e.progress>=1&&this.handleAnimationComplete(e)}catch(r){throw e.performanceWarnings++,new L("Animation update failed",{animationId:e.id},r)}}updateTimeline(e,t){const i=performance.now();e.elapsed=i-e.startTime,e.progress=Math.min(e.elapsed/e.duration,1),e.animations.forEach(r=>{const s=e.startTime+r.delay,a=s+r.duration;if(i>=s&&i<=a&&!r.completed){r.started||(r.started=!0,r.onStart&&r.onStart(r.target,r));const n=Math.min((i-s)/r.duration,1),o=this.applyEasing(n,r.easing);this.updateProperties(r,o),r.onUpdate&&r.onUpdate(r.target,n,r),n>=1&&!r.completed&&(r.completed=!0,r.onComplete&&r.onComplete(r.target,r))}}),e.progress>=1&&(e.completed=!0,e.onComplete&&e.onComplete(e))}handleAnimationComplete(e){try{if((e.repeat>0||e.repeat===-1)&&(e.repeatCount++,e.repeat===-1||e.repeatCount<e.repeat)){e.yoyo&&(e.direction*=-1,Object.keys(e.properties).forEach(t=>{const i=e.properties[t];[i.start,i.end]=[i.end,i.start]})),e.startTime=performance.now(),e.elapsed=0,e.progress=0,e.onRepeat&&e.onRepeat(e.target,e.repeatCount,e);return}e.completed=!0,this.activeAnimations.delete(e.id),this.performanceMonitor.releaseMemory(e.id),e.announceComplete&&e.description&&this.announce(`Animation completed: ${e.description}`),e.onComplete&&e.onComplete(e.target,e)}catch(t){this.handleAnimationError(e,t)}}handleError(e){this.errorCount++,this.lastError=e,d.error("AnimationManager Error:",e),this.engine&&this.engine.emit&&this.engine.emit("animation:error",e),this.attemptErrorRecovery(e)}handleAnimationError(e,t){e.performanceWarnings++,e.onError?e.onError(t,e):this.handleError(new L("Animation execution error",{animationId:e.id},t)),e.performanceWarnings>g.PERFORMANCE_WARNING_LIMIT&&(this.stop(e.id),this.announce(`Animation stopped due to errors: ${e.description||"Unknown animation"}`))}handleTimelineError(e,t){d.warn("Timeline error:",t),e.completed=!0}attemptErrorRecovery(e){switch(e.context?.operation){case"create-animation":e.context?.animationId&&this.stop(e.context.animationId);break;case"animation-update":this.maxAnimationsPerFrame=Math.max(10,this.maxAnimationsPerFrame-10),setTimeout(()=>{this.maxAnimationsPerFrame=g.MAX_ANIMATIONS_PER_FRAME},g.PERFORMANCE_RESET_DELAY);break}}announce(e,t=!1){!this.accessibilityConfig.announceAnimations||!e||(this.announcements.push({message:String(e).trim(),urgent:t,timestamp:Date.now()}),setTimeout(()=>this.processAnnouncements(),100))}processAnnouncements(){if(this.announcements.length===0||!this.accessibilityRegion)return;const e=this.announcements.shift();this.accessibilityRegion.textContent=e.message,setTimeout(()=>{this.accessibilityRegion&&this.accessibilityRegion.textContent===e.message&&(this.accessibilityRegion.textContent="")},g.CLEANUP_DELAY)}estimateAnimationMemory(e){return 1024+Object.keys(e.properties).length*g.PROPERTY_SIZE_MULTIPLIER}performMemoryCleanup(){const e=Date.now()-g.HISTORY_CUTOFF_TIME;this.animations.forEach((t,i)=>{t.completed&&t.createdAt<e&&(this.animations.delete(i),this.performanceMonitor.releaseMemory(i))}),this.timelines.forEach((t,i)=>{t.completed&&t.createdAt<e&&this.timelines.delete(i)}),this.renderCache.size>100&&this.renderCache.clear()}pauseAllAnimations(){this.activeAnimations.forEach(e=>{const t=this.animations.get(e);t&&(t.paused=!0)}),this.accessibilityConfig.announceAnimations&&this.announce("All animations paused")}resumeAllAnimations(){const e=performance.now();this.activeAnimations.forEach(t=>{const i=this.animations.get(t);i&&i.paused&&(i.paused=!1,i.startTime=e-i.elapsed)}),this.accessibilityConfig.announceAnimations&&this.announce("All animations resumed")}loadSettings(){try{if(typeof localStorage<"u"){const e=JSON.parse(localStorage.getItem("animationSettings")||"{}");return{announceAnimations:e.announceAnimations!==!1,respectReducedMotion:e.respectReducedMotion!==!1,enableKeyboardControls:e.enableKeyboardControls!==!1,forceAnimations:e.forceAnimations||!1,maxAnimationsPerFrame:e.maxAnimationsPerFrame||g.MAX_ANIMATIONS_PER_FRAME}}}catch(e){d.warn("Failed to load animation settings:",e)}return{announceAnimations:!0,respectReducedMotion:!0,enableKeyboardControls:!0,forceAnimations:!1,maxAnimationsPerFrame:g.MAX_ANIMATIONS_PER_FRAME}}saveSettings(e){try{if(typeof localStorage<"u"){const i={...this.loadSettings(),...e};localStorage.setItem("animationSettings",JSON.stringify(i)),this.settings=i}}catch(t){d.warn("Failed to save animation settings:",t)}}setReducedMotionMode(e){this.reducedMotionMode=e,this.settings.respectReducedMotion=e,this.updateAnimationDefaults(),this.saveSettings({respectReducedMotion:e}),e&&this.activeAnimations.forEach(t=>{const i=this.animations.get(t);i&&!i.completed&&(i.duration=Math.min(i.duration,g.REDUCED_MOTION_DURATION),i.easing="linear")}),this.announce(`Reduced motion mode ${e?"enabled":"disabled"}`)}setAccessibilityAnnouncements(e){this.accessibilityConfig.announceAnimations=e,this.saveSettings({announceAnimations:e}),this.announce(`Animation announcements ${e?"enabled":"disabled"}`)}updateProperties(e,t){Object.keys(e.properties).forEach(i=>{const r=e.properties[i];r.type==="number"?e.target[i]=r.start+(r.end-r.start)*t:r.type==="color"?e.target[i]=this.interpolateColor(r.start,r.end,t):r.type==="transform"&&(e.target[i]=this.interpolateTransform(r.start,r.end,t))})}processProperties(e,t){const i={};return Object.keys(t).forEach(r=>{const s=t[r],a=e[r]||0;typeof s=="number"?i[r]={type:"number",start:a,end:s}:this.isColor(s)?i[r]={type:"color",start:this.parseColor(a),end:this.parseColor(s)}:typeof s=="string"&&s.includes("transform")?i[r]={type:"transform",start:a,end:s}:i[r]={type:"number",start:parseFloat(a)||0,end:parseFloat(s)||0}}),i}applyEasing(e,t){const i={linear:s=>s,easeIn:s=>s*s,easeOut:s=>s*(2-s),easeInOut:s=>s<A.HALF?A.TWO*s*s:-1+(A.FOUR-A.TWO*s)*s,easeInCubic:s=>s*s*s,easeOutCubic:s=>--s*s*s+1,easeInOutCubic:s=>s<A.HALF?A.FOUR*s*s*s:(s-1)*(A.TWO*s-A.TWO)*(A.TWO*s-A.TWO)+1,easeInQuart:s=>s*s*s*s,easeOutQuart:s=>1- --s*s*s*s,easeInOutQuart:s=>s<A.HALF?A.EIGHT*s*s*s*s:1-A.EIGHT*--s*s*s*s,easeInSine:s=>1-Math.cos(s*Math.PI/2),easeOutSine:s=>Math.sin(s*Math.PI/2),easeInOutSine:s=>-(Math.cos(Math.PI*s)-1)/2,bounce:s=>s<1/b.BOUNCE_C4?b.BOUNCE_C5*s*s:s<A.TWO/b.BOUNCE_C4?b.BOUNCE_C5*(s-=A.ONE_AND_HALF/b.BOUNCE_C4)*s+A.THREE_QUARTERS:s<A.TWO_AND_HALF/b.BOUNCE_C4?b.BOUNCE_C5*(s-=A.TWO_AND_QUARTER/b.BOUNCE_C4)*s+A.FIFTEEN_SIXTEENTHS:b.BOUNCE_C5*(s-=A.TWO_AND_FIVE_EIGHTHS/b.BOUNCE_C4)*s+A.SIXTYTHREE_SIXTYFOURTHS,elastic:s=>s===0?0:s===1?1:Math.pow(A.TWO,-10*s)*Math.sin((s-A.ONE_TENTH)*(A.TWO*Math.PI)/A.OPACITY_40)+1};return(i[t]||i.linear)(e)}isColor(e){return typeof e=="string"&&(e.startsWith("#")||e.startsWith("rgb")||e.startsWith("hsl"))}parseColor(e){if(typeof e!="string")return{r:0,g:0,b:0,a:1};if(e.startsWith("#")){const t=e.slice(1);if(t.length===g.HEX_SHORT_LENGTH)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16),a:1};if(t.length===g.HEX_LONG_LENGTH)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,g.HEX_SLICE_END_SHORT),16),b:parseInt(t.slice(g.HEX_SLICE_END_SHORT,g.HEX_LONG_LENGTH),16),a:1}}return{r:0,g:0,b:0,a:1}}interpolateColor(e,t,i){const r=Math.round(e.r+(t.r-e.r)*i),s=Math.round(e.g+(t.g-e.g)*i),a=Math.round(e.b+(t.b-e.b)*i),n=e.a+(t.a-e.a)*i;return`rgba(${r}, ${s}, ${a}, ${n})`}interpolateTransform(e,t,i){return i<g.TRANSITION_MIDPOINT?e:t}cleanupCompleted(){const e=[];this.animations.forEach((i,r)=>{i.completed&&e.push(r)}),e.forEach(i=>{this.animations.delete(i),this.activeAnimations.delete(i)});const t=[];this.timelines.forEach((i,r)=>{i.completed&&t.push(r)}),t.forEach(i=>{this.timelines.delete(i)})}getActiveAnimationCount(){return this.activeAnimations.size}getActiveTimelineCount(){return Array.from(this.timelines.values()).filter(e=>e.started&&!e.completed).length}fadeIn(e,t=null,i={}){const r=t||this.defaultDuration;return e.opacity=e.opacity||0,this.to(e,{opacity:1},r,{...i,description:i.description||"Fade in animation",announceComplete:i.announceComplete||!1})}fadeOut(e,t=null,i={}){const r=t||this.defaultDuration;return this.to(e,{opacity:0},r,{...i,description:i.description||"Fade out animation",announceComplete:i.announceComplete||!1})}slideIn(e,t="left",i=100,r=null,s={}){const a=r||this.defaultDuration,n=t==="left"?-i:t==="right"?i:t==="up"?-i:i,o=t==="left"||t==="right"?"x":"y",h=e[o]||0;return e[o]=n,this.to(e,{[o]:h},a,{...s,description:s.description||`Slide in from ${t}`,easing:s.easing||"easeOutCubic"})}scale(e,t=1.2,i=null,r={}){const s=i||this.defaultDuration*g.SCALE_DURATION_MULTIPLIER,a=e.scale||1;return this.to(e,{scale:t},s,{...r,yoyo:!0,description:r.description||"Scale animation",onComplete:()=>{e.scale=a,r.onComplete&&r.onComplete()}})}shake(e,t=5,i=null,r={}){const s=i||this.defaultDuration,a=e.x||0,n=this.reducedMotionMode?g.REDUCED_SHAKE_COUNT:g.NORMAL_SHAKE_COUNT,o=this.reducedMotionMode?Math.min(t,2):t,h=this.createTimeline({...r,description:r.description||"Shake animation"});for(let u=0;u<n;u++){const m=u%2===0?1:-1,T=a+m*o;this.addToTimeline(h,e,{x:T},s/n,u*(s/n))}return this.addToTimeline(h,e,{x:a},s/n,s-s/n),this.playTimeline(h),h}focusHighlight(e,t=null,i={}){const r=t||this.defaultDuration*g.FADE_DURATION_MULTIPLIER;return this.theme.highContrast?this.to(e,{borderWidth:3,borderColor:"#ffff00"},r,{...i,description:"Focus highlight animation",yoyo:!0}):this.to(e,{scale:1.05,boxShadow:"0 0 10px rgba(0, 123, 255, 0.5)"},r,{...i,description:"Focus highlight animation",yoyo:!0,easing:"easeInOut"})}slideReveal(e,t="down",i=null,r={}){const s=i||this.defaultDuration,a=t==="down"||t==="up"?"height":"width",n=0,o=e[`original${a.charAt(0).toUpperCase()+a.slice(1)}`]||e[a]||100;return e[a]=n,e.overflow="hidden",this.to(e,{[a]:o},s,{...r,description:r.description||`Slide reveal ${t}`,easing:"easeOutCubic",onComplete:()=>{e.overflow="visible",r.onComplete&&r.onComplete()}})}createGestureAnimation(e,t,i={}){const s={swipeLeft:()=>this.slideIn(e,"left",g.SWIPE_DISTANCE,null,i),swipeRight:()=>this.slideIn(e,"right",g.SWIPE_DISTANCE,null,i),swipeUp:()=>this.slideIn(e,"up",g.SWIPE_DISTANCE,null,i),swipeDown:()=>this.slideIn(e,"down",g.SWIPE_DISTANCE,null,i),pinchIn:()=>this.scale(e,g.PINCH_IN_SCALE,null,i),pinchOut:()=>this.scale(e,g.PINCH_OUT_SCALE,null,i),tap:()=>this.focusHighlight(e,null,i)}[t];if(s){const a=s();return this.gestureAnimations.set(e,a),a}return null}getAccessibilityReport(){return{isEnabled:this.accessibilityEnabled,reducedMotionMode:this.reducedMotionMode,theme:this.theme,activeAnimations:this.activeAnimations.size,announcements:this.accessibilityConfig.announceAnimations,settings:this.settings,performance:this.performanceMonitor.getMetrics(),errors:this.errorCount,lastError:this.lastError}}getPerformanceReport(){const e=this.performanceMonitor.getMetrics(),t=this.activeAnimations.size,i=this.getActiveTimelineCount();return{activeAnimations:t,activeTimelines:i,framePerformance:{averageFrameTime:e.operations["animation-update"]?.averageDuration||0,lastFrameTime:e.operations["animation-update"]?.lastDuration||0,frameTimeLimit:this.frameTimeLimit,maxAnimationsPerFrame:this.maxAnimationsPerFrame},memory:e.memory,errors:this.errorCount,reducedMotionMode:this.reducedMotionMode,theme:this.theme.theme}}destroy(){const e=this.performanceMonitor.startOperation("animation-cleanup");try{this.stopAll(),this.removeEventListeners(),this.cleanupAccessibilityFeatures(),this.performanceMonitor.memoryTracker.clear(),this.memoryCleanupInterval&&(clearInterval(this.memoryCleanupInterval),this.memoryCleanupInterval=null),this.animations.clear(),this.timelines.clear(),this.activeAnimations.clear(),this.gestureAnimations.clear(),this.renderCache.clear(),this.announcements=[],this.saveSettings(this.settings),d.info("Enhanced AnimationManager destroyed successfully")}catch(t){d.error("Error during AnimationManager cleanup:",t)}finally{this.performanceMonitor.endOperation("animation-cleanup",e)}}removeEventListeners(){try{if(this.themeListeners){const{reducedMotionQuery:e,contrastQuery:t,updateTheme:i}=this.themeListeners;e.removeEventListener&&(e.removeEventListener("change",i),t.removeEventListener("change",i))}typeof document<"u"&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)}catch(e){d.warn("Event listener cleanup failed:",e)}}cleanupAccessibilityFeatures(){try{this.accessibilityRegion&&this.accessibilityRegion.parentNode&&this.accessibilityRegion.parentNode.removeChild(this.accessibilityRegion)}catch(e){d.warn("Accessibility cleanup failed:",e)}}}D.createGlobalStyles=function(){if(typeof document>"u"||document.getElementById("animation-manager-styles"))return;const p=document.createElement("style");p.id="animation-manager-styles",p.textContent=`
        /* Global animation styles with accessibility support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .animation-enabled {
                animation: none !important;
                transition: none !important;
            }
        }
        
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
        
        .animation-focus-highlight {
            outline: 2px solid #007bff !important;
            outline-offset: 2px !important;
        }
        
        @media (prefers-contrast: high) {
            .animation-focus-highlight {
                outline: 3px solid #ffff00 !important;
                outline-offset: 2px !important;
            }
        }
        
        .animation-container {
            contain: layout style;
        }
        
        .animation-target {
            will-change: auto;
        }
        
        .animation-target.animating {
            will-change: transform, opacity, background-color;
        }
    `,document.head.appendChild(p)};D.detectAnimationSupport=function(){if(typeof window>"u")return!1;const p=document.createElement("div");return["animation","webkitAnimation","mozAnimation","oAnimation","msAnimation"].some(t=>t in p.style)};D.getSystemAnimationPreferences=function(){return typeof window>"u"?{}:{reducedMotion:window.matchMedia?.("(prefers-reduced-motion: reduce)").matches||!1,highContrast:window.matchMedia?.("(prefers-contrast: high)").matches||!1,animationSupport:this.detectAnimationSupport()}};typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",D.createGlobalStyles):D.createGlobalStyles());const _={HALF:.5,TWO:2,BOUNCE_DIVISOR:2.75,BOUNCE_MULTIPLIER:7.5625,BOUNCE_THRESHOLD_1:1,BOUNCE_THRESHOLD_2:2,BOUNCE_THRESHOLD_3:2.5,BOUNCE_OFFSET_1:1.5,BOUNCE_OFFSET_2:2.25,BOUNCE_OFFSET_3:2.625,BOUNCE_VALUE_1:.75,BOUNCE_VALUE_2:.9375,BOUNCE_VALUE_3:.984375};class Te{constructor(){this.objects=[],this.interactiveObjects=[],this.layers=new Map,this.background=null,this.camera=null,this.spatialGrid=null,this.needsSpatialUpdate=!1,this.objectPools=new Map}add(e){e&&(e.scene=this,this.objects.push(e),e.isInteractive&&this.interactiveObjects.push(e),e.layer!==void 0&&this.addToLayer(e,e.layer),this.needsSpatialUpdate=!0,e.onAdded&&e.onAdded(this))}remove(e){if(!e)return;const t=this.objects.indexOf(e);t>-1&&this.objects.splice(t,1);const i=this.interactiveObjects.indexOf(e);i>-1&&this.interactiveObjects.splice(i,1),e.layer!==void 0&&this.removeFromLayer(e,e.layer),e.scene=null,this.needsSpatialUpdate=!0,e.onRemoved&&e.onRemoved()}addToLayer(e,t){this.layers.has(t)||this.layers.set(t,[]);const i=this.layers.get(t);i.includes(e)||(i.push(e),i.sort((r,s)=>(r.zIndex||0)-(s.zIndex||0)))}removeFromLayer(e,t){if(this.layers.has(t)){const i=this.layers.get(t),r=i.indexOf(e);r>-1&&i.splice(r,1)}}clear(){this.objects.forEach(e=>{e.onRemoved&&e.onRemoved(),e.scene=null}),this.objects=[],this.interactiveObjects=[],this.layers.clear(),this.background=null,this.needsSpatialUpdate=!0}update(e){for(let t=this.objects.length-1;t>=0;t--){const i=this.objects[t];i.update&&i.update(e),i.markedForDeletion&&this.remove(i)}this.needsSpatialUpdate&&this.spatialGrid&&(this.updateSpatialGrid(),this.needsSpatialUpdate=!1)}render(e){this.background&&e.renderObject(this.background),this.layers.size>0?this.renderByLayers(e):this.renderByZIndex(e)}renderByLayers(e){Array.from(this.layers.keys()).sort((i,r)=>i-r).forEach(i=>{this.layers.get(i).forEach(s=>{s.visible!==!1&&e.renderObject(s)})}),this.objects.forEach(i=>{i.layer===void 0&&i.visible!==!1&&e.renderObject(i)})}renderByZIndex(e){[...this.objects].sort((i,r)=>(i.zIndex||0)-(r.zIndex||0)).forEach(i=>{i.visible!==!1&&e.renderObject(i)})}getObjectsAt(e,t){const i=[];for(let r=this.interactiveObjects.length-1;r>=0;r--){const s=this.interactiveObjects[r];s.visible!==!1&&s.containsPoint&&s.containsPoint(e,t)&&i.push(s)}return i}getObjectsInArea(e,t,i,r){const s=[],a={x:e,y:t,width:i,height:r};return this.objects.forEach(n=>{if(n.visible!==!1&&n.getBounds){const o=n.getBounds();this.rectanglesIntersect(a,o)&&s.push(n)}}),s}getObjectsByType(e){return this.objects.filter(t=>t.type===e)}getObjectsByTag(e){return this.objects.filter(t=>t.tags&&t.tags.includes(e))}findObject(e){return this.objects.find(e)}findObjects(e){return this.objects.filter(e)}hitTest(e,t,i={}){const{includeNonInteractive:r=!1,layer:s=null,type:a=null}=i;let n=r?this.objects:this.interactiveObjects;s!==null&&(n=n.filter(o=>o.layer===s)),a!==null&&(n=n.filter(o=>o.type===a));for(let o=n.length-1;o>=0;o--){const h=n[o];if(h.visible!==!1&&h.containsPoint){const u=this.worldToLocal(h,e,t);if(h.containsPoint(u.x,u.y))return{object:h,worldPoint:{x:e,y:t},localPoint:u,distance:this.getDistance(e,t,h.x||0,h.y||0)}}}return null}worldToLocal(e,t,i){return{x:t-(e.x||0),y:i-(e.y||0)}}localToWorld(e,t,i){return{x:t+(e.x||0),y:i+(e.y||0)}}rectanglesIntersect(e,t){return!(t.x>e.x+e.width||t.x+t.width<e.x||t.y>e.y+e.height||t.y+t.height<e.y)}getDistance(e,t,i,r){const s=i-e,a=r-t;return Math.sqrt(s*s+a*a)}handleInput(e,t){const i=[...this.interactiveObjects].reverse();for(const r of i)if(r.visible!==!1){if(r.handleInput&&r.handleInput(e,t))return!0;if((e.includes("mouse")||e.includes("touch"))&&t.x!==void 0&&t.y!==void 0&&r.containsPoint&&r.containsPoint(t.x,t.y)){if(e==="mousedown"&&r.onMouseDown)return r.onMouseDown(t),!0;if(e==="mouseup"&&r.onClick)return r.onClick(t),!0;if(e==="mousemove"&&r.onMouseMove)return r.onMouseMove(t),!0}}return!1}handleResize(){this.objects.forEach(e=>{e.onResize&&e.onResize()})}animateObject(e,t,i,r={}){if(!e||!t||i<=0)return;const{easing:s="easeInOut",onComplete:a=null,onUpdate:n=null}=r,o=performance.now(),h={};Object.keys(t).forEach(m=>{h[m]=e[m]||0});const u=m=>{const T=m-o,f=Math.min(T/i,1),S=this.applyEasing(f,s);Object.keys(t).forEach(C=>{const R=h[C],O=t[C];e[C]=R+(O-R)*S}),n&&n(e,S),f<1?requestAnimationFrame(u):a&&a(e)};requestAnimationFrame(u)}applyEasing(e,t){switch(t){case"linear":return e;case"easeIn":return e*e;case"easeOut":return 1-(1-e)*(1-e);case"easeInOut":return e<_.HALF?_.TWO*e*e:1-Math.pow(-2*e+_.TWO,_.TWO)/_.TWO;case"bounce":return e<_.BOUNCE_THRESHOLD_1/_.BOUNCE_DIVISOR?_.BOUNCE_MULTIPLIER*e*e:e<_.BOUNCE_THRESHOLD_2/_.BOUNCE_DIVISOR?_.BOUNCE_MULTIPLIER*(e-=_.BOUNCE_OFFSET_1/_.BOUNCE_DIVISOR)*e+_.BOUNCE_VALUE_1:e<_.BOUNCE_THRESHOLD_3/_.BOUNCE_DIVISOR?_.BOUNCE_MULTIPLIER*(e-=_.BOUNCE_OFFSET_2/_.BOUNCE_DIVISOR)*e+_.BOUNCE_VALUE_2:_.BOUNCE_MULTIPLIER*(e-=_.BOUNCE_OFFSET_3/_.BOUNCE_DIVISOR)*e+_.BOUNCE_VALUE_3;default:return e}}getStats(){return{totalObjects:this.objects.length,interactiveObjects:this.interactiveObjects.length,layers:this.layers.size,needsSpatialUpdate:this.needsSpatialUpdate}}updateSpatialGrid(){}}const W={PERFORMANCE_MONITOR_INTERVAL:1e3,MAX_EVENT_HISTORY:100,THROTTLE_INTERVAL:16,MAX_LOG_ENTRIES:50,GESTURE_THRESHOLDS:{TAP_TIMEOUT:300,TAP_MAX_DISTANCE:10,PAN_MIN_DISTANCE:10,PINCH_MIN_DISTANCE:20,LONG_PRESS_DURATION:500,DOUBLE_TAP_INTERVAL:300},TOUCH_SETTINGS:{DEFAULT_RADIUS:20,DEFAULT_FORCE:1,MAX_TOUCHES:10,PASSIVE_EVENTS:!1},KEYBOARD_SETTINGS:{REPEAT_DELAY:500,REPEAT_RATE:50,GLOBAL_SHORTCUTS:["F1","F11","F12","Tab","Escape"],ACCESSIBILITY_KEYS:["Tab","Enter","Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"]},GAMEPAD_SETTINGS:{POLL_INTERVAL:16,DEADZONE:.1,BUTTON_THRESHOLD:.5,VIBRATION_ENABLED:!0},ACCESSIBILITY:{FOCUS_VISIBLE_OUTLINE:"2px solid #0078d4",HIGH_CONTRAST_SUPPORT:!0,REDUCED_MOTION_SUPPORT:!0,SCREEN_READER_SUPPORT:!0},PRIVACY:{ANONYMOUS_TRACKING:!0,RESPECT_DNT:!0,MINIMAL_DATA_COLLECTION:!0}},P={light:{focusColor:"#0078d4",hoverColor:"#106ebe",disabledColor:"#8a8886",backgroundColor:"#ffffff",textColor:"#323130"},dark:{focusColor:"#4cc2ff",hoverColor:"#0078d4",disabledColor:"#605e5c",backgroundColor:"#1f1f1f",textColor:"#ffffff"},highContrast:{focusColor:"#ffff00",hoverColor:"#ffffff",disabledColor:"#808080",backgroundColor:"#000000",textColor:"#ffffff"}},y={INVALID_EVENT:"INVALID_EVENT",HANDLER_ERROR:"HANDLER_ERROR",GAMEPAD_ERROR:"GAMEPAD_ERROR",ACCESSIBILITY_ERROR:"ACCESSIBILITY_ERROR"};class Ae{constructor(e,t={}){if(!e)throw new Error("Engine instance is required for InputManager");this.engine=e,this.container=e.container,this.renderer=e.renderer,this.config={...W,...t},this.currentTheme=t.theme||"light",this.themeColors=P[this.currentTheme],this.performanceMonitor=new te,this.accessibilityManager=new ie(this),this.errorHandler=new re,this.privacyManager=new se(this.config.PRIVACY),this.inputValidator=new ae,this.throttleTimers=new Map,this.eventHistory=[],this.mouse={x:0,y:0,down:!1,button:-1,wheel:0,velocity:{x:0,y:0},lastUpdate:performance.now(),buttons:new Set,hoveredElements:new Set},this.keyboard={keys:new Set,modifiers:{shift:!1,ctrl:!1,alt:!1,meta:!1},composition:!1,lastKeyTime:0,repeatKeys:new Map},this.touch={touches:new Map,maxTouches:0,gestures:{pinch:{active:!1,scale:1,startDistance:0,center:{x:0,y:0}},pan:{active:!1,deltaX:0,deltaY:0,velocity:{x:0,y:0}},tap:{active:!1,startTime:0,count:0,lastTapTime:0},longPress:{active:!1,startTime:0,triggered:!1},rotate:{active:!1,angle:0,startAngle:0}},history:[]},this.gamepad={controllers:new Map,pollInterval:null,deadzone:this.config.GAMEPAD_SETTINGS.DEADZONE,buttonStates:new Map,axisStates:new Map},this.eventHandlers=new Map,this.eventPriorities=new Map,this.gestureThreshold={...this.config.GESTURE_THRESHOLDS},this.init()}init(){try{this.setupMouseEvents(),this.setupKeyboardEvents(),this.setupTouchEvents(),this.setupWheelEvents(),this.setupGamepadEvents(),this.setupAccessibilityFeatures(),this.startPerformanceMonitoring(),this.applyTheme(this.currentTheme),this.privacyManager.initialize(),this.log("InputManager initialized successfully","info")}catch(e){throw this.errorHandler.handleError(e,"INITIALIZATION_ERROR"),e}}applyTheme(e){if(!P[e]){this.log(`Unknown theme: ${e}`,"warn");return}this.currentTheme=e,this.themeColors=P[e];const t=this.renderer.getElement();t&&(t.style.setProperty("--input-focus-color",this.themeColors.focusColor),t.style.setProperty("--input-hover-color",this.themeColors.hoverColor)),this.emit("themeChanged",{theme:e,colors:this.themeColors})}log(e,t="info",i={}){if(!this.privacyManager.shouldLog())return;const s={timestamp:new Date().toISOString(),level:t,message:e,context:i,component:"InputManager"};switch(t){case"error":d.error(`[InputManager Error] ${e}`,i);break;case"warn":d.warn(`[InputManager Warning] ${e}`,i);break;case"debug":d.debug(`[InputManager Debug] ${e}`,i);break;default:d.info(`[InputManager] ${e}`,i)}this.performanceMonitor.logEvent(s)}throttle(e,t){let i,r=0;return(...s)=>{const a=performance.now();a-r>t?(e.apply(this,s),r=a):(clearTimeout(i),i=setTimeout(()=>{e.apply(this,s),r=performance.now()},t-(a-r)))}}setupMouseEvents(){const e=this.renderer.getElement(),t={passive:!1,capture:!1};this.boundMouseHandlers={mousedown:this.handleMouseDown.bind(this),mousemove:this.throttle(this.handleMouseMove.bind(this),this.config.THROTTLE_INTERVAL),mouseup:this.handleMouseUp.bind(this),mouseenter:this.handleMouseEnter.bind(this),mouseleave:this.handleMouseLeave.bind(this),contextmenu:this.handleContextMenu.bind(this)},Object.entries(this.boundMouseHandlers).forEach(([i,r])=>{e.addEventListener(i,r,t)})}setupKeyboardEvents(){const e={passive:!1,capture:!0};this.boundKeyboardHandlers={keydown:this.handleKeyDown.bind(this),keyup:this.handleKeyUp.bind(this)},Object.entries(this.boundKeyboardHandlers).forEach(([t,i])=>{document.addEventListener(t,i,e)})}setupTouchEvents(){const e=this.renderer.getElement(),t={passive:this.config.TOUCH_SETTINGS.PASSIVE_EVENTS,capture:!1};this.boundTouchHandlers={touchstart:this.handleTouchStart.bind(this),touchmove:this.throttle(this.handleTouchMove.bind(this),this.config.THROTTLE_INTERVAL),touchend:this.handleTouchEnd.bind(this),touchcancel:this.handleTouchCancel.bind(this)},Object.entries(this.boundTouchHandlers).forEach(([i,r])=>{e.addEventListener(i,r,t)})}setupWheelEvents(){const e=this.renderer.getElement(),t={passive:!1,capture:!1};this.boundWheelHandler=this.throttle(this.handleWheel.bind(this),this.config.THROTTLE_INTERVAL),e.addEventListener("wheel",this.boundWheelHandler,t)}setupGamepadEvents(){window.addEventListener("gamepadconnected",this.handleGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.handleGamepadDisconnected.bind(this)),this.startGamepadPolling()}setupAccessibilityFeatures(){this.accessibilityManager.initialize(),this.setupFocusManagement(),this.setupAriaSupport()}startPerformanceMonitoring(){this.performanceMonitor.start(this.config.PERFORMANCE_MONITOR_INTERVAL)}setupFocusManagement(){const e=this.renderer.getElement();e.hasAttribute("tabindex")||e.setAttribute("tabindex","0"),e.addEventListener("focus",this.handleFocus.bind(this)),e.addEventListener("blur",this.handleBlur.bind(this))}setupAriaSupport(){const e=this.renderer.getElement();e.setAttribute("role","application"),e.setAttribute("aria-label","Interactive simulation canvas")}startGamepadPolling(){this.gamepad.pollInterval||(this.gamepad.pollInterval=setInterval(()=>{this.pollGamepads()},this.config.GAMEPAD_SETTINGS.POLL_INTERVAL))}pollGamepads(){const e=navigator.getGamepads();for(let t=0;t<e.length;t++){const i=e[t];i&&this.processGamepadState(i)}}processGamepadState(e){const{id:t}=e,i=this.gamepad.controllers.get(t)||{};e.buttons.forEach((r,s)=>{const a=i.buttons?.[s]?.pressed||!1,n=r.pressed||r.value>this.config.GAMEPAD_SETTINGS.BUTTON_THRESHOLD;n!==a&&this.emit(n?"gamepadbuttondown":"gamepadbuttonup",{gamepadId:t,button:s,value:r.value})}),this.gamepad.controllers.set(t,{buttons:e.buttons.map(r=>({pressed:r.pressed,value:r.value})),axes:[...e.axes]})}handleMouseDown(e){try{const t=this.getEventCoordinates(e),i=performance.now();this.mouse.x=t.x,this.mouse.y=t.y,this.mouse.down=!0,this.mouse.button=e.button,this.mouse.buttons.add(e.button),this.mouse.lastUpdate=i,this.updateKeyboardModifiers(e);const r={type:"mousedown",x:t.x,y:t.y,button:e.button,buttons:Array.from(this.mouse.buttons),timestamp:i,originalEvent:e,...this.keyboard.modifiers};this.performanceMonitor.recordEvent("mousedown",i),this.emit("mousedown",r),this.notifyScene("mousedown",r)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleMouseMove(e){try{const t=this.getEventCoordinates(e),i=performance.now(),r=i-this.mouse.lastUpdate,s=t.x-this.mouse.x,a=t.y-this.mouse.y;this.mouse.velocity.x=r>0?s/r:0,this.mouse.velocity.y=r>0?a/r:0,this.mouse.x=t.x,this.mouse.y=t.y,this.mouse.lastUpdate=i,this.updateKeyboardModifiers(e);const n={type:"mousemove",x:t.x,y:t.y,deltaX:s,deltaY:a,velocity:{...this.mouse.velocity},button:this.mouse.button,down:this.mouse.down,timestamp:i,originalEvent:e,...this.keyboard.modifiers};this.performanceMonitor.recordEvent("mousemove",i),this.emit("mousemove",n),this.notifyScene("mousemove",n)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleMouseUp(e){try{const t=this.getEventCoordinates(e),i=performance.now();this.mouse.x=t.x,this.mouse.y=t.y,this.mouse.down=!1,this.mouse.buttons.delete(e.button),this.mouse.lastUpdate=i,this.updateKeyboardModifiers(e);const r={type:"mouseup",x:t.x,y:t.y,button:e.button,buttons:Array.from(this.mouse.buttons),timestamp:i,originalEvent:e,...this.keyboard.modifiers};this.performanceMonitor.recordEvent("mouseup",i),this.emit("mouseup",r),this.notifyScene("mouseup",r),this.mouse.buttons.size===0&&(this.mouse.button=-1)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleMouseEnter(e){try{const t={type:"mouseenter",timestamp:performance.now(),originalEvent:e};this.emit("mouseenter",t),this.performanceMonitor.recordEvent("mouseenter")}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleMouseLeave(e){try{this.mouse.down=!1,this.mouse.buttons.clear(),this.mouse.button=-1;const t={type:"mouseleave",timestamp:performance.now(),originalEvent:e};this.emit("mouseleave",t),this.performanceMonitor.recordEvent("mouseleave")}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleContextMenu(e){try{e.preventDefault();const t=this.getEventCoordinates(e),i={type:"contextmenu",x:t.x,y:t.y,timestamp:performance.now(),originalEvent:e};this.emit("contextmenu",i),this.performanceMonitor.recordEvent("contextmenu")}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleKeyDown(e){try{if(!this.container.contains(document.activeElement)&&!this.isGlobalShortcut(e))return;const t=performance.now();this.keyboard.keys.add(e.code),this.updateKeyboardModifiers(e);const i={type:"keydown",key:e.key,code:e.code,repeat:e.repeat,timestamp:t,originalEvent:e,...this.keyboard.modifiers};this.performanceMonitor.recordEvent("keydown",t),this.emit("keydown",i),this.notifyScene("keydown",i)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleKeyUp(e){try{const t=performance.now();this.keyboard.keys.delete(e.code),this.updateKeyboardModifiers(e);const i={type:"keyup",key:e.key,code:e.code,timestamp:t,originalEvent:e,...this.keyboard.modifiers};this.performanceMonitor.recordEvent("keyup",t),this.emit("keyup",i),this.notifyScene("keyup",i)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleTouchStart(e){try{e.preventDefault();const t=this.processTouches(e.touches),i=performance.now();t.forEach(s=>{this.touch.touches.set(s.identifier,{...s,startTime:i,startX:s.x,startY:s.y})}),this.detectGestures(t);const r={type:"touchstart",touches:t,touchCount:this.touch.touches.size,timestamp:i,originalEvent:e};this.performanceMonitor.recordEvent("touchstart",i),this.emit("touchstart",r),this.notifyScene("touchstart",r)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleTouchMove(e){try{e.preventDefault();const t=this.processTouches(e.touches),i=performance.now();t.forEach(s=>{const a=this.touch.touches.get(s.identifier);a&&this.touch.touches.set(s.identifier,{...s,startTime:a.startTime,startX:a.startX,startY:a.startY})}),this.updateGestures(t);const r={type:"touchmove",touches:t,gestures:{...this.touch.gestures},touchCount:this.touch.touches.size,timestamp:i,originalEvent:e};this.performanceMonitor.recordEvent("touchmove",i),this.emit("touchmove",r),this.notifyScene("touchmove",r)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleTouchEnd(e){try{e.preventDefault();const t=this.processTouches(e.changedTouches),i=performance.now();t.forEach(s=>{this.touch.touches.delete(s.identifier)}),this.finalizeGestures(t);const r={type:"touchend",touches:t,gestures:{...this.touch.gestures},touchCount:this.touch.touches.size,timestamp:i,originalEvent:e};this.performanceMonitor.recordEvent("touchend",i),this.emit("touchend",r),this.notifyScene("touchend",r)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleTouchCancel(e){try{this.touch.touches.clear(),this.resetGestures();const t={type:"touchcancel",timestamp:performance.now(),originalEvent:e};this.emit("touchcancel",t),this.performanceMonitor.recordEvent("touchcancel")}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleWheel(e){try{e.preventDefault();const t=this.getEventCoordinates(e),i=performance.now();this.mouse.wheel=e.deltaY;const r={type:"wheel",x:t.x,y:t.y,deltaX:e.deltaX,deltaY:e.deltaY,deltaZ:e.deltaZ,timestamp:i,originalEvent:e};this.performanceMonitor.recordEvent("wheel",i),this.emit("wheel",r),this.notifyScene("wheel",r)}catch(t){this.errorHandler.handleError(t,y.HANDLER_ERROR)}}handleFocus(e){try{this.accessibilityManager.onFocus(e);const t={type:"focus",timestamp:performance.now(),originalEvent:e};this.emit("focus",t)}catch(t){this.errorHandler.handleError(t,y.ACCESSIBILITY_ERROR)}}handleBlur(e){try{this.accessibilityManager.onBlur(e);const t={type:"blur",timestamp:performance.now(),originalEvent:e};this.emit("blur",t)}catch(t){this.errorHandler.handleError(t,y.ACCESSIBILITY_ERROR)}}handleGamepadConnected(e){try{const{gamepad:t}=e;this.gamepad.controllers.set(t.id,{buttons:t.buttons.map(r=>({pressed:r.pressed,value:r.value})),axes:[...t.axes]}),this.log(`Gamepad connected: ${t.id}`,"info");const i={type:"gamepadconnected",gamepadId:t.id,gamepad:t,timestamp:performance.now(),originalEvent:e};this.emit("gamepadconnected",i)}catch(t){this.errorHandler.handleError(t,y.GAMEPAD_ERROR)}}handleGamepadDisconnected(e){try{const{gamepad:t}=e;this.gamepad.controllers.delete(t.id),this.log(`Gamepad disconnected: ${t.id}`,"info");const i={type:"gamepaddisconnected",gamepadId:t.id,timestamp:performance.now(),originalEvent:e};this.emit("gamepaddisconnected",i)}catch(t){this.errorHandler.handleError(t,y.GAMEPAD_ERROR)}}getEventCoordinates(e){const t=this.renderer.getElement().getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}processTouches(e){const t=this.renderer.getElement().getBoundingClientRect(),i=[];for(let r=0;r<e.length;r++){const s=e[r];i.push({identifier:s.identifier,x:s.clientX-t.left,y:s.clientY-t.top,radiusX:s.radiusX||this.config.TOUCH_SETTINGS.DEFAULT_RADIUS,radiusY:s.radiusY||this.config.TOUCH_SETTINGS.DEFAULT_RADIUS,force:s.force||this.config.TOUCH_SETTINGS.DEFAULT_FORCE})}return i}updateKeyboardModifiers(e){this.keyboard.modifiers.shift=e.shiftKey,this.keyboard.modifiers.ctrl=e.ctrlKey,this.keyboard.modifiers.alt=e.altKey,this.keyboard.modifiers.meta=e.metaKey}isGlobalShortcut(e){return this.config.KEYBOARD_SETTINGS.GLOBAL_SHORTCUTS.includes(e.key)||e.ctrlKey&&["?","h","H"].includes(e.key)}detectGestures(e){if(e.length===1)this.touch.gestures.tap={active:!0,startTime:performance.now(),startX:e[0].x,startY:e[0].y};else if(e.length===2){const t=this.getTouchDistance(e[0],e[1]);this.touch.gestures.pinch={active:!0,scale:1,startDistance:t,centerX:(e[0].x+e[1].x)/2,centerY:(e[0].y+e[1].y)/2}}}updateGestures(e){if(this.touch.gestures.pinch.active&&e.length===2){const i=this.getTouchDistance(e[0],e[1])/this.touch.gestures.pinch.startDistance;this.touch.gestures.pinch.scale=i,this.touch.gestures.pinch.centerX=(e[0].x+e[1].x)/2,this.touch.gestures.pinch.centerY=(e[0].y+e[1].y)/2,this.emit("pinch",{scale:i,centerX:this.touch.gestures.pinch.centerX,centerY:this.touch.gestures.pinch.centerY})}if(e.length===1&&this.touch.gestures.tap.active){const t=e[0].x-this.touch.gestures.tap.startX,i=e[0].y-this.touch.gestures.tap.startY;Math.sqrt(t*t+i*i)>this.gestureThreshold.PAN_MIN_DISTANCE&&(this.touch.gestures.tap.active=!1,this.touch.gestures.pan={active:!0,deltaX:t,deltaY:i},this.emit("panstart",{x:e[0].x,y:e[0].y,deltaX:t,deltaY:i}))}}finalizeGestures(e){this.touch.gestures.tap.active&&performance.now()-this.touch.gestures.tap.startTime<this.gestureThreshold.TAP_TIMEOUT&&this.emit("tap",{x:this.touch.gestures.tap.startX,y:this.touch.gestures.tap.startY}),this.touch.gestures.pan.active&&this.emit("panend",{deltaX:this.touch.gestures.pan.deltaX,deltaY:this.touch.gestures.pan.deltaY}),this.resetGestures()}resetGestures(){this.touch.gestures={pinch:{active:!1,scale:1,startDistance:0},pan:{active:!1,deltaX:0,deltaY:0},tap:{active:!1,startTime:0}}}getTouchDistance(e,t){const i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,new Set),this.eventHandlers.get(e).add(t)}off(e,t){this.eventHandlers.has(e)&&this.eventHandlers.get(e).delete(t)}emit(e,t){this.eventHandlers.has(e)&&this.eventHandlers.get(e).forEach(i=>{try{i(t)}catch(r){this.errorHandler.handleError(r,y.HANDLER_ERROR,{eventType:e})}})}notifyScene(e,t){this.engine.scene&&this.engine.scene.handleInput&&this.engine.scene.handleInput(e,t)}isKeyPressed(e){return this.keyboard.keys.has(e)}isMouseDown(){return this.mouse.down}getMousePosition(){return{x:this.mouse.x,y:this.mouse.y}}getTouchCount(){return this.touch.touches.size}getPerformanceMetrics(){return this.performanceMonitor.getMetrics()}update(e){this.performanceMonitor.update(),this.accessibilityManager.update()}destroy(){try{const e=this.renderer.getElement();this.boundMouseHandlers&&Object.entries(this.boundMouseHandlers).forEach(([t,i])=>{e.removeEventListener(t,i)}),this.boundKeyboardHandlers&&Object.entries(this.boundKeyboardHandlers).forEach(([t,i])=>{document.removeEventListener(t,i)}),this.boundTouchHandlers&&Object.entries(this.boundTouchHandlers).forEach(([t,i])=>{e.removeEventListener(t,i)}),this.boundWheelHandler&&e.removeEventListener("wheel",this.boundWheelHandler),window.removeEventListener("gamepadconnected",this.handleGamepadConnected),window.removeEventListener("gamepaddisconnected",this.handleGamepadDisconnected),this.gamepad.pollInterval&&clearInterval(this.gamepad.pollInterval),this.performanceMonitor.stop(),this.eventHandlers.clear(),this.keyboard.keys.clear(),this.keyboard.repeatKeys.clear(),this.touch.touches.clear(),this.gamepad.controllers.clear(),this.eventHistory=[],this.log("InputManager destroyed","info")}catch(e){this.errorHandler.handleError(e,"DESTRUCTION_ERROR")}}}class te{constructor(){this.events=new Map,this.metrics={totalEvents:0,averageResponseTime:0,peakResponseTime:0,eventCounts:new Map},this.isRunning=!1,this.logEntries=[]}start(e=1e3){this.isRunning||(this.isRunning=!0,this.startTime=performance.now(),this.monitorInterval=setInterval(()=>{this.updateMetrics()},e))}stop(){this.isRunning&&(this.isRunning=!1,clearInterval(this.monitorInterval))}recordEvent(e,t=performance.now()){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t),this.metrics.totalEvents++;const i=this.metrics.eventCounts.get(e)||0;this.metrics.eventCounts.set(e,i+1)}updateMetrics(){const e=performance.now(),t=[];for(const[,i]of this.events){const r=i.filter(s=>e-s<1e3);t.push(...r)}if(t.length>0){const i=t.reduce((r,s)=>r+(e-s),0)/t.length;this.metrics.averageResponseTime=i,this.metrics.peakResponseTime=Math.max(this.metrics.peakResponseTime,i)}}getMetrics(){return{...this.metrics}}logEvent(e){this.logEntries.push(e),this.logEntries.length>W.MAX_EVENT_HISTORY&&(this.logEntries=this.logEntries.slice(-50))}update(){}}class ie{constructor(e){this.inputManager=e,this.focusVisible=!1,this.reducedMotion=!1,this.highContrast=!1,this.screenReader=!1}initialize(){this.detectAccessibilityPreferences(),this.setupAccessibilityFeatures()}detectAccessibilityPreferences(){if(window.matchMedia){const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.reducedMotion=e.matches;const t=s=>{this.reducedMotion=s.matches,this.inputManager.emit("accessibilityChanged",{reducedMotion:this.reducedMotion})};e.addListener(t);const i=window.matchMedia("(prefers-contrast: high)");this.highContrast=i.matches;const r=s=>{this.highContrast=s.matches,this.inputManager.emit("accessibilityChanged",{highContrast:this.highContrast})};i.addListener(r)}this.screenReader=this.detectScreenReader()}detectScreenReader(){return window.navigator.userAgent.includes("NVDA")||window.navigator.userAgent.includes("JAWS")||window.speechSynthesis||window.navigator.userAgent.includes("VoiceOver")}setupAccessibilityFeatures(){document.addEventListener("keydown",()=>{this.focusVisible=!0}),document.addEventListener("mousedown",()=>{this.focusVisible=!1})}getEventAccessibilityData(e){return{focusVisible:this.focusVisible,reducedMotion:this.reducedMotion,highContrast:this.highContrast,screenReader:this.screenReader,keyboardNavigation:this.focusVisible}}onFocus(e){this.focusVisible=!0,e.target&&e.target.setAttribute("data-focus-visible","true")}onBlur(e){e.target&&e.target.removeAttribute("data-focus-visible")}update(){}}class re{constructor(){this.errors=[],this.maxErrors=50}handleError(e,t,i={}){const r={timestamp:new Date().toISOString(),type:t,message:e.message,stack:e.stack,context:i};this.errors.push(r),this.errors.length>this.maxErrors&&(this.errors=this.errors.slice(-this.maxErrors/2)),t===y.INVALID_EVENT?d.warn("[InputManager] Invalid event:",r):d.error("[InputManager] Error:",r)}getErrors(){return[...this.errors]}clearErrors(){this.errors=[]}}class se{constructor(e){this.config=e,this.respectDNT=e.RESPECT_DNT,this.anonymousTracking=e.ANONYMOUS_TRACKING,this.minimalDataCollection=e.MINIMAL_DATA_COLLECTION}initialize(){this.respectDNT&&navigator.doNotTrack==="1"&&(this.anonymousTracking=!1)}shouldLog(){return!navigator.doNotTrack||!this.respectDNT}sanitizeEventData(e){if(!this.minimalDataCollection)return e;const t={...e};return delete t.originalEvent,delete t.element,t}}class ae{validate(e,t){if(!e)throw new Error("Event is null or undefined");if(!t)throw new Error("Event type is required");if(typeof e!="object")throw new Error("Event must be an object");switch(t){case"mousedown":case"mouseup":case"mousemove":return this.validateMouseEvent(e);case"keydown":case"keyup":return this.validateKeyboardEvent(e);case"touchstart":case"touchmove":case"touchend":return this.validateTouchEvent(e);default:return!0}}validateMouseEvent(e){return typeof e.clientX=="number"&&typeof e.clientY=="number"}validateKeyboardEvent(e){return typeof e.key=="string"||typeof e.code=="string"}validateTouchEvent(e){return e.touches&&typeof e.touches.length=="number"}}const c={VERSION:"2.0.0",DEFAULT_WIDTH:800,DEFAULT_HEIGHT:600,MAX_CANVAS_SIZE:32767,ANIMATION_FPS:60,PERFORMANCE_SAMPLE_RATE:.1,FRAME_TIME_THRESHOLD:16.67,MAX_DRAW_CALLS:1e4,DEFAULT_FONT_SIZE:14,LABEL_FONT_SIZE:12,DEFAULT_BORDER_RADIUS:4,FOCUSED_BORDER_WIDTH:3,DEFAULT_STROKE_WIDTH:1,CHART_TITLE_Y_OFFSET:20,CHART_AREA_RATIO:.8,CHART_BAR_PADDING_RATIO:.1,CHART_BAR_PADDING_MIN:2,CHART_BAR_BOTTOM_MARGIN:20,CHART_LABEL_Y_OFFSET:5,CHART_POINT_RADIUS:4,CHART_POINT_LABEL_Y_OFFSET:15,CHART_GRID_LINES:5,CHART_PIE_RADIUS_RATIO:.8,CHART_PIE_LABEL_RADIUS_RATIO:.7,CHART_PIE_MIN_SLICE_ANGLE:.2,CHART_LEGEND_OFFSET:20,COLOR_HUE_FULL_CIRCLE:360,COLOR_SATURATION:70,COLOR_LIGHTNESS:50,REDUCED_MOTION_DURATION_FACTOR:.2,REDUCED_MOTION_MAX_DURATION:300,ANIMATION_ID_BASE:36,ANIMATION_ID_LENGTH:9,EASING_HALF_POINT:.5,EASING_QUADRATIC_FACTOR:2,EASING_CUBIC_FACTOR:4,EASING_BOUNCE_DIVISOR:2.75,EASING_BOUNCE_MULTIPLIER:7.5625,EASING_BOUNCE_THRESHOLD_1:1.5,EASING_BOUNCE_THRESHOLD_2:2.5,EASING_BOUNCE_THRESHOLD_3:2.25,EASING_BOUNCE_THRESHOLD_4:2.625,EASING_BOUNCE_OFFSET_1:.75,EASING_BOUNCE_OFFSET_2:.9375,EASING_BOUNCE_OFFSET_3:.984375,DEFAULT_OBJECT_WIDTH:50,DEFAULT_OBJECT_HEIGHT:50,DEFAULT_CIRCLE_RADIUS:25,DEFAULT_LINE_LENGTH:50,PLACEHOLDER_OFFSET:-5,PLACEHOLDER_SIZE:10,ACCESSIBILITY:{MIN_CONTRAST_RATIO:4.5,MIN_FONT_SIZE:12,MIN_TOUCH_TARGET:44},THEMES:{LIGHT:{background:"#ffffff",foreground:"#333333",primary:"#007acc",secondary:"#28a745",accent:"#6c757d"},DARK:{background:"#1a1a1a",foreground:"#e0e0e0",primary:"#4da6ff",secondary:"#66bb6a",accent:"#9e9e9e"},HIGH_CONTRAST:{background:"#000000",foreground:"#ffffff",primary:"#ffff00",secondary:"#00ffff",accent:"#ff00ff"}}};class ne{constructor(){this.metrics={drawCalls:0,renderTime:0,frameCount:0,averageFrameTime:0,droppedFrames:0,lastFrameTime:0},this.enabled=c.PERFORMANCE_SAMPLE_RATE>Math.random()}startFrame(){this.enabled&&(this.frameStartTime=performance.now())}endFrame(){if(!this.enabled)return;const e=performance.now()-this.frameStartTime;this.metrics.frameCount++,this.metrics.renderTime+=e,this.metrics.averageFrameTime=this.metrics.renderTime/this.metrics.frameCount,e>c.FRAME_TIME_THRESHOLD&&this.metrics.droppedFrames++,this.metrics.lastFrameTime=e}recordDrawCall(){this.enabled&&this.metrics.drawCalls++}getMetrics(){return{...this.metrics}}reset(){Object.keys(this.metrics).forEach(e=>{this.metrics[e]=0})}}class oe{constructor(e,t){this.canvas=e,this.renderer=t,this.description="",this.elements=new Map,this.focusedElement=null,this.setupAccessibility()}setupAccessibility(){this.canvas.setAttribute("role","img"),this.canvas.setAttribute("tabindex","0"),this.updateDescription("Interactive simulation canvas"),this.canvas.addEventListener("keydown",this.handleKeydown.bind(this)),this.canvas.addEventListener("focus",this.handleFocus.bind(this)),this.canvas.addEventListener("blur",this.handleBlur.bind(this))}updateDescription(e){this.description=e,this.canvas.setAttribute("aria-label",e)}addElement(e,t){this.elements.set(e,{...t,id:e,focusable:t.focusable!==!1}),this.updateDescription()}removeElement(e){this.elements.delete(e),this.focusedElement===e&&(this.focusedElement=null),this.updateDescription()}handleKeydown(e){const t=Array.from(this.elements.values()).filter(r=>r.focusable);if(t.length===0)return;let i=t.findIndex(r=>r.id===this.focusedElement);switch(e.key){case"Tab":e.preventDefault(),e.shiftKey?i=i<=0?t.length-1:i-1:i=i>=t.length-1?0:i+1,this.focusElement(t[i].id);break;case"Enter":case" ":if(this.focusedElement){const r=this.elements.get(this.focusedElement);r&&r.onClick&&(e.preventDefault(),r.onClick())}break}}focusElement(e){this.focusedElement=e;const t=this.elements.get(e);t&&(this.announceElement(t),this.renderer.requestRender())}announceElement(e){const t=e.ariaLabel||e.label||`${e.type} element`;this.announceToScreenReader(t)}announceToScreenReader(e){const t=document.createElement("div");t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.style.position="absolute",t.style.left="-10000px",t.style.width="1px",t.style.height="1px",t.style.overflow="hidden",document.body.appendChild(t),t.textContent=e,setTimeout(()=>{document.body.removeChild(t)},1e3)}handleFocus(){this.canvas.style.outline="2px solid #007acc"}handleBlur(){this.canvas.style.outline="none",this.focusedElement=null}getElementAt(e,t){for(const[i,r]of this.elements.entries())if(this.isPointInElement(e,t,r))return i;return null}isPointInElement(e,t,i){const{x:r,y:s,width:a,height:n}=i;return e>=r&&e<=r+a&&t>=s&&t<=s+n}}class le{constructor(e,t={}){this.container=e,this.options={width:t.width||c.DEFAULT_WIDTH,height:t.height||c.DEFAULT_HEIGHT,pixelRatio:t.pixelRatio||window.devicePixelRatio||1,alpha:t.alpha!==!1,antialias:t.antialias!==!1,theme:t.theme||"light",enableAccessibility:t.enableAccessibility!==!1,enablePerformanceMonitoring:t.enablePerformanceMonitoring!==!1,respectReducedMotion:t.respectReducedMotion!==!1,maxDrawCalls:t.maxDrawCalls||c.MAX_DRAW_CALLS,...t},this.canvas=null,this.ctx=null,this.layers=new Map,this.animations=new Set,this.isRendering=!1,this.renderRequested=!1,this.performanceMonitor=new ne,this.accessibilityManager=null;const i=(typeof this.options.theme=="string"?this.options.theme:"light").toUpperCase();this.currentTheme=c.THEMES[i]||c.THEMES.LIGHT,this.imageCache=new Map,this.drawCallCount=0,this.resizeObserver=null,this.boundHandleResize=this.handleResize.bind(this),this.animationFrameId=null,this.lastFrameTime=0,this.errorHandler=t.errorHandler||this.defaultErrorHandler.bind(this);try{this.initialize()}catch(r){this.errorHandler("Initialization failed",r)}}initialize(){this.validateContainer(),this.createCanvas(),this.setupContext(),this.setupAccessibility(),this.setupResponsiveHandling(),this.setupThemeMonitoring(),this.applyInitialStyles()}validateContainer(){if(!this.container||!this.container.nodeType)throw new Error("Invalid container element provided")}createCanvas(){this.canvas=document.createElement("canvas");const e=Math.min(this.options.width,c.MAX_CANVAS_SIZE),t=Math.min(this.options.height,c.MAX_CANVAS_SIZE);this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.display="block",this.canvas.style.touchAction="none",this.canvas.width=e*this.options.pixelRatio,this.canvas.height=t*this.options.pixelRatio,this.canvas.setAttribute("data-renderer","canvas"),this.canvas.setAttribute("data-version",c.VERSION),this.container.appendChild(this.canvas)}setupContext(){const e={alpha:this.options.alpha,antialias:this.options.antialias,colorSpace:"srgb",desynchronized:!1,willReadFrequently:!1};if(this.ctx=this.canvas.getContext("2d",e),!this.ctx)throw new Error("Failed to get 2D canvas context");this.ctx.scale(this.options.pixelRatio,this.options.pixelRatio),this.applyDefaultStyles()}applyDefaultStyles(){this.ctx.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, system-ui, sans-serif',this.ctx.textBaseline="middle",this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.imageSmoothingEnabled=this.options.antialias,this.ctx.imageSmoothingQuality="high"}setupAccessibility(){this.options.enableAccessibility&&(this.accessibilityManager=new oe(this.canvas,this))}setupResponsiveHandling(){window.ResizeObserver?(this.resizeObserver=new ResizeObserver(this.boundHandleResize),this.resizeObserver.observe(this.container)):window.addEventListener("resize",this.boundHandleResize)}setupThemeMonitoring(){if(window.matchMedia){const e=window.matchMedia("(prefers-contrast: high)"),t=()=>{let i="light";e.matches&&(i="high_contrast"),this.setTheme(i)};e.addEventListener("change",t),t()}}applyInitialStyles(){this.clear(),this.ctx.fillStyle=this.currentTheme.background,this.ctx.fillRect(0,0,this.options.width,this.options.height)}handleResize(e){let t,i;e&&e[0]?{width:t,height:i}=e[0].contentRect:{width:t,height:i}=this.container.getBoundingClientRect(),t>0&&i>0&&this.resize(t,i)}setTheme(e){const t=(typeof e=="string"?e:"light").toUpperCase(),i=c.THEMES[t];i&&i!==this.currentTheme&&(this.currentTheme=i,this.options.theme=e,this.applyInitialStyles(),this.requestRender())}requestRender(){this.renderRequested||(this.renderRequested=!0,this.animationFrameId=requestAnimationFrame(e=>{this.performanceMonitor.startFrame(),this.renderRequested=!1,this.lastFrameTime=e,this.performanceMonitor.endFrame()}))}defaultErrorHandler(e,t){d.error(`CanvasRenderer Error: ${e}`,t),this.options.enableAccessibility&&this.accessibilityManager&&this.accessibilityManager.announceToScreenReader(`Rendering error: ${e}`)}clear(e=0,t=0,i=this.options.width,r=this.options.height){this.ctx.clearRect(e,t,i,r),e===0&&t===0&&i===this.options.width&&r===this.options.height&&(this.ctx.fillStyle=this.currentTheme.background,this.ctx.fillRect(e,t,i,r)),this.performanceMonitor.recordDrawCall()}drawRect(e,t,i,r,s={}){if(this.drawCallCount>=this.options.maxDrawCalls){this.errorHandler("Maximum draw calls exceeded",new Error("Performance limit"));return}this.ctx.save();try{const a=s.fill||(s.primary?this.currentTheme.primary:null),n=s.stroke||(s.border?this.currentTheme.foreground:null);s.interactive&&(i<c.ACCESSIBILITY.MIN_TOUCH_TARGET||r<c.ACCESSIBILITY.MIN_TOUCH_TARGET)&&d.warn("Interactive element below minimum touch target size"),a&&(this.ctx.fillStyle=a,s.borderRadius?(this.drawRoundedRect(e,t,i,r,s.borderRadius),this.ctx.fill()):this.ctx.fillRect(e,t,i,r)),n&&(this.ctx.strokeStyle=n,this.ctx.lineWidth=s.strokeWidth||1,s.borderRadius?(this.drawRoundedRect(e,t,i,r,s.borderRadius),this.ctx.stroke()):this.ctx.strokeRect(e,t,i,r)),s.interactive&&this.accessibilityManager&&this.accessibilityManager.addElement(s.id||`rect_${Date.now()}`,{type:"rectangle",x:e,y:t,width:i,height:r,label:s.label,ariaLabel:s.ariaLabel,onClick:s.onClick,focusable:s.focusable})}catch(a){this.errorHandler("Failed to draw rectangle",a)}finally{this.ctx.restore(),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}}drawRoundedRect(e,t,i,r,s){typeof s=="number"&&(s={tl:s,tr:s,br:s,bl:s}),this.ctx.beginPath(),this.ctx.moveTo(e+s.tl,t),this.ctx.lineTo(e+i-s.tr,t),this.ctx.quadraticCurveTo(e+i,t,e+i,t+s.tr),this.ctx.lineTo(e+i,t+r-s.br),this.ctx.quadraticCurveTo(e+i,t+r,e+i-s.br,t+r),this.ctx.lineTo(e+s.bl,t+r),this.ctx.quadraticCurveTo(e,t+r,e,t+r-s.bl),this.ctx.lineTo(e,t+s.tl),this.ctx.quadraticCurveTo(e,t,e+s.tl,t),this.ctx.closePath()}drawCircle(e,t,i,r={}){if(!(this.drawCallCount>=this.options.maxDrawCalls)){this.ctx.save();try{const s=r.fill||(r.primary?this.currentTheme.primary:null),a=r.stroke||(r.border?this.currentTheme.foreground:null);this.ctx.beginPath(),this.ctx.arc(e,t,i,0,2*Math.PI),s&&(this.ctx.fillStyle=s,this.ctx.fill()),a&&(this.ctx.strokeStyle=a,this.ctx.lineWidth=r.strokeWidth||1,this.ctx.stroke()),r.interactive&&this.accessibilityManager&&this.accessibilityManager.addElement(r.id||`circle_${Date.now()}`,{type:"circle",x:e-i,y:t-i,width:i*2,height:i*2,label:r.label,ariaLabel:r.ariaLabel,onClick:r.onClick})}catch(s){this.errorHandler("Failed to draw circle",s)}finally{this.ctx.restore(),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}}}drawLine(e,t,i,r,s={}){if(!(this.drawCallCount>=this.options.maxDrawCalls)){this.ctx.save();try{this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(i,r),this.ctx.strokeStyle=s.stroke||this.currentTheme.foreground,this.ctx.lineWidth=s.strokeWidth||1,s.lineCap&&(this.ctx.lineCap=s.lineCap),s.dashPattern&&this.ctx.setLineDash(s.dashPattern),this.ctx.stroke()}catch(a){this.errorHandler("Failed to draw line",a)}finally{this.ctx.restore(),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}}}drawPath(e,t={}){if(!(!Array.isArray(e)||e.length<2)&&!(this.drawCallCount>=this.options.maxDrawCalls)){this.ctx.save();try{this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y);for(let i=1;i<e.length;i++)if(t.smooth&&i>0&&i<e.length-1){const r=e[i],s=e[i+1];this.ctx.quadraticCurveTo(r.x,r.y,(r.x+s.x)/2,(r.y+s.y)/2)}else this.ctx.lineTo(e[i].x,e[i].y);t.closePath&&this.ctx.closePath(),t.fill&&(this.ctx.fillStyle=t.fill,this.ctx.fill()),t.stroke&&(this.ctx.strokeStyle=t.stroke,this.ctx.lineWidth=t.strokeWidth||1,this.ctx.stroke())}catch(i){this.errorHandler("Failed to draw path",i)}finally{this.ctx.restore(),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}}}drawText(e,t,i,r={}){if(!(typeof e!="string"||this.drawCallCount>=this.options.maxDrawCalls)){this.ctx.save();try{const s=Math.max(r.fontSize||c.DEFAULT_FONT_SIZE,c.ACCESSIBILITY.MIN_FONT_SIZE),a=r.fill||r.color||this.currentTheme.foreground,n=r.fontWeight||"normal",o=r.fontFamily||'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, system-ui, sans-serif';if(this.ctx.font=`${n} ${s}px ${o}`,this.ctx.textAlign=r.textAlign||"left",this.ctx.textBaseline=r.textBaseline||"middle",r.shadow&&(this.ctx.shadowColor=r.shadow.color||"rgba(0,0,0,0.5)",this.ctx.shadowBlur=r.shadow.blur||2,this.ctx.shadowOffsetX=r.shadow.offsetX||1,this.ctx.shadowOffsetY=r.shadow.offsetY||1),a&&(this.ctx.fillStyle=a,this.ctx.fillText(e,t,i)),r.stroke&&(this.ctx.strokeStyle=r.stroke,this.ctx.lineWidth=r.strokeWidth||1,this.ctx.strokeText(e,t,i)),r.accessible&&this.accessibilityManager){const h=this.ctx.measureText(e);this.accessibilityManager.addElement(r.id||`text_${Date.now()}`,{type:"text",x:t,y:i-s/2,width:h.width,height:s,text:e,label:r.label||e,ariaLabel:r.ariaLabel||e})}}catch(s){this.errorHandler("Failed to draw text",s)}finally{this.ctx.restore(),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}}}drawButton(e,t,i,r,s,a={}){if(!(this.drawCallCount>=this.options.maxDrawCalls))try{const n=Math.max(i,c.ACCESSIBILITY.MIN_TOUCH_TARGET),o=Math.max(r,c.ACCESSIBILITY.MIN_TOUCH_TARGET),h=a.backgroundColor||(a.variant==="secondary"?this.currentTheme.secondary:this.currentTheme.primary),u=a.borderColor||this.currentTheme.foreground,m=a.textColor||"#ffffff",T=this.accessibilityManager?.focusedElement===a.id;this.drawRect(e,t,n,o,{fill:h,stroke:T?this.currentTheme.accent:u,strokeWidth:T?c.FOCUSED_BORDER_WIDTH:c.DEFAULT_STROKE_WIDTH,borderRadius:a.borderRadius||c.DEFAULT_BORDER_RADIUS,interactive:!0,id:a.id,label:a.label||s,ariaLabel:a.ariaLabel||s,onClick:a.onClick,focusable:!0}),this.drawText(s,e+n/2,t+o/2,{fill:m,fontSize:Math.max(a.fontSize||c.DEFAULT_FONT_SIZE,c.ACCESSIBILITY.MIN_FONT_SIZE),fontWeight:a.fontWeight||"500",textAlign:"center",textBaseline:"middle",accessible:!0,id:`${a.id}_text`,ariaLabel:`Button: ${s}`})}catch(n){this.errorHandler("Failed to draw button",n)}}drawChart(e,t,i,r,s,a={}){if(!Array.isArray(e)||e.length===0){this.errorHandler("Invalid chart data provided",new Error("Data must be non-empty array"));return}const n=a.type||"bar";this.ctx.save();try{switch(a.backgroundColor!==!1&&this.drawRect(t,i,r,s,{fill:a.backgroundColor||this.currentTheme.background}),a.border!==!1&&this.drawRect(t,i,r,s,{stroke:a.borderColor||this.currentTheme.foreground,strokeWidth:1}),a.title&&this.drawText(a.title,t+r/2,i-c.CHART_TITLE_Y_OFFSET,{fill:this.currentTheme.foreground,fontSize:16,fontWeight:"bold",textAlign:"center",accessible:!0,ariaLabel:`Chart title: ${a.title}`}),n){case"bar":this.drawBarChart(e,t,i,r,s,a);break;case"line":this.drawLineChart(e,t,i,r,s,a);break;case"pie":this.drawPieChart(e,t,i,Math.min(r,s),a);break;default:throw new Error(`Unsupported chart type: ${n}`)}this.accessibilityManager&&this.accessibilityManager.addElement(a.id||`chart_${Date.now()}`,{type:"chart",x:t,y:i,width:r,height:s,chartType:n,data:e,label:a.label||`${n} chart`,ariaLabel:a.ariaLabel||this.generateChartDescription(e,n)})}catch(o){this.errorHandler("Failed to draw chart",o)}finally{this.ctx.restore()}}generateChartDescription(e,t){const i=e.reduce((n,o)=>n+(o.value||0),0),r=e.length,s=Math.max(...e.map(n=>n.value||0)),a=Math.min(...e.map(n=>n.value||0));return`${t} chart with ${r} data points. Values range from ${a} to ${s}. Total: ${i}`}drawBarChart(e,t,i,r,s,a={}){if(e.length)try{const n=Math.max(...e.map(m=>m.value||0));if(n===0)return;const o=r/e.length,h=Math.max(o*c.CHART_BAR_PADDING_RATIO,c.CHART_BAR_PADDING_MIN),u=s*c.CHART_AREA_RATIO;e.forEach((m,T)=>{const f=m.value/n*u,S=t+T*o+h,C=i+s-f-c.CHART_BAR_BOTTOM_MARGIN,R=o-h*2,O=m.color||a.barColor||this.currentTheme.primary;this.drawRect(S,C,R,f,{fill:O,interactive:a.interactive,id:`bar_${T}`,label:`${m.label||`Item ${T+1}`}: ${m.value}`,ariaLabel:`Bar ${T+1} of ${e.length}: ${m.label||"Unnamed"} with value ${m.value}`,onClick:()=>a.onBarClick?.(m,T)}),a.showValues!==!1&&this.drawText(m.value.toString(),S+R/2,C-10,{fill:this.currentTheme.foreground,fontSize:Math.max(10,c.ACCESSIBILITY.MIN_FONT_SIZE),textAlign:"center",textBaseline:"bottom"}),m.label&&this.drawText(m.label,S+R/2,i+s-c.CHART_LABEL_Y_OFFSET,{fill:this.currentTheme.foreground,fontSize:Math.max(c.LABEL_FONT_SIZE,c.ACCESSIBILITY.MIN_FONT_SIZE),textAlign:"center",textBaseline:"bottom"})})}catch(n){this.errorHandler("Failed to draw bar chart",n)}}drawLineChart(e,t,i,r,s,a={}){if(e.length<2){this.errorHandler("Line chart requires at least 2 data points",new Error("Insufficient data"));return}try{const n=e.map(f=>f.value||0),o=Math.max(...n),h=Math.min(...n),u=o-h||1,m=s*c.CHART_AREA_RATIO,T=e.map((f,S)=>({x:t+S/(e.length-1)*r,y:i+m-(f.value-h)/u*m+c.CHART_BAR_BOTTOM_MARGIN,value:f.value,label:f.label}));a.showGrid!==!1&&this.drawGrid(t,i+c.CHART_BAR_BOTTOM_MARGIN,r,m,a),this.drawPath(T,{stroke:a.lineColor||this.currentTheme.primary,strokeWidth:a.lineWidth||2,smooth:a.smooth!==!1}),T.forEach((f,S)=>{this.drawCircle(f.x,f.y,a.pointRadius||c.CHART_POINT_RADIUS,{fill:a.pointColor||this.currentTheme.primary,stroke:this.currentTheme.background,strokeWidth:2,interactive:a.interactive,id:`point_${S}`,label:`${f.label||`Point ${S+1}`}: ${f.value}`,ariaLabel:`Data point ${S+1} of ${T.length}: ${f.label||"Unnamed"} with value ${f.value}`,onClick:()=>a.onPointClick?.(e[S],S)}),a.showValues&&this.drawText(f.value.toString(),f.x,f.y-c.CHART_POINT_LABEL_Y_OFFSET,{fill:this.currentTheme.foreground,fontSize:10,textAlign:"center",textBaseline:"bottom"})})}catch(n){this.errorHandler("Failed to draw line chart",n)}}drawGrid(e,t,i,r,s={}){const a=s.gridColor||`${this.currentTheme.accent}40`,n=s.gridLines||c.CHART_GRID_LINES;this.ctx.save(),this.ctx.strokeStyle=a,this.ctx.lineWidth=.5,this.ctx.setLineDash([2,2]);for(let o=0;o<=n;o++){const h=t+o/n*r;this.ctx.beginPath(),this.ctx.moveTo(e,h),this.ctx.lineTo(e+i,h),this.ctx.stroke()}for(let o=0;o<=n;o++){const h=e+o/n*i;this.ctx.beginPath(),this.ctx.moveTo(h,t),this.ctx.lineTo(h,t+r),this.ctx.stroke()}this.ctx.restore()}drawPieChart(e,t,i,r,s={}){if(e.length)try{const a=t+r/2,n=i+r/2,o=r/2*c.CHART_PIE_RADIUS_RATIO,h=e.reduce((m,T)=>m+(T.value||0),0);if(h===0)return;let u=-Math.PI/2;e.forEach((m,T)=>{const f=m.value/h*2*Math.PI,S=u+f,C=u+f/2,R=o*c.CHART_PIE_LABEL_RADIUS_RATIO,O=a+Math.cos(C)*R,x=n+Math.sin(C)*R;this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(a,n),this.ctx.arc(a,n,o,u,S),this.ctx.closePath();const M=m.color||this.generateSliceColor(T,e.length);if(this.ctx.fillStyle=M,this.ctx.fill(),this.ctx.strokeStyle=s.borderColor||this.currentTheme.background,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore(),this.accessibilityManager){const H=(m.value/h*100).toFixed(1);this.accessibilityManager.addElement(`slice_${T}`,{type:"pie-slice",x:a-o,y:n-o,width:o*2,height:o*2,label:`${m.label||`Slice ${T+1}`}: ${H}%`,ariaLabel:`Pie slice ${T+1} of ${e.length}: ${m.label||"Unnamed"} representing ${H}% with value ${m.value}`,interactive:s.interactive,onClick:()=>s.onSliceClick?.(m,T)})}if(f>c.CHART_PIE_MIN_SLICE_ANGLE&&s.showLabels!==!1){const H=(m.value/h*100).toFixed(1),G=s.showPercentages?`${H}%`:m.label;G&&this.drawText(G,O,x,{fill:this.currentTheme.background,fontSize:Math.max(10,c.ACCESSIBILITY.MIN_FONT_SIZE),textAlign:"center",textBaseline:"middle",fontWeight:"bold"})}u=S}),s.showLegend!==!1&&this.drawPieChartLegend(e,t+r+c.CHART_LEGEND_OFFSET,i,s)}catch(a){this.errorHandler("Failed to draw pie chart",a)}}generateSliceColor(e,t){const i=e/t*c.COLOR_HUE_FULL_CIRCLE,r=c.COLOR_SATURATION,s=c.COLOR_LIGHTNESS;return`hsl(${i}, ${r}%, ${s}%)`}drawPieChartLegend(e,t,i,r={}){e.forEach((n,o)=>{const h=i+o*25,u=n.color||this.generateSliceColor(o,e.length);this.drawRect(t,h,15,15,{fill:u,stroke:this.currentTheme.foreground,strokeWidth:1}),this.drawText(n.label||`Item ${o+1}`,t+15+10,h+15/2,{fill:this.currentTheme.foreground,fontSize:12,textBaseline:"middle"})})}animate(e,t=1e3,i={}){if(this.options.respectReducedMotion&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(i.skipOnReducedMotion!==!1)return e(1),null;t=Math.min(t*c.REDUCED_MOTION_DURATION_FACTOR,c.REDUCED_MOTION_MAX_DURATION)}const r={callback:e,duration:t,startTime:performance.now(),id:Math.random().toString(c.ANIMATION_ID_BASE).substr(2,c.ANIMATION_ID_LENGTH),easing:i.easing||"easeInOut",onComplete:i.onComplete,onProgress:i.onProgress,paused:!1,cancelled:!1};return this.animations.add(r),this.runAnimation(r),r.id}runAnimation(e){const t=i=>{if(e.cancelled){this.animations.delete(e);return}if(e.paused){requestAnimationFrame(t);return}const r=i-e.startTime;let s=Math.min(r/e.duration,1);s=this.applyEasing(s,e.easing);try{e.callback(s),e.onProgress&&e.onProgress(s),s<1?requestAnimationFrame(t):(this.animations.delete(e),e.onComplete&&e.onComplete())}catch(a){this.errorHandler("Animation callback failed",a),this.animations.delete(e)}};requestAnimationFrame(t)}applyEasing(e,t){switch(t){case"linear":return e;case"easeIn":return e*e;case"easeOut":return e*(2-e);case"easeInOut":return e<c.EASING_HALF_POINT?c.EASING_QUADRATIC_FACTOR*e*e:-1+(c.EASING_CUBIC_FACTOR-c.EASING_QUADRATIC_FACTOR*e)*e;case"easeInCubic":return e*e*e;case"easeOutCubic":return--e*e*e+1;case"easeInOutCubic":return e<c.EASING_HALF_POINT?c.EASING_CUBIC_FACTOR*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;case"bounce":return e<1/c.EASING_BOUNCE_DIVISOR?c.EASING_BOUNCE_MULTIPLIER*e*e:e<c.EASING_QUADRATIC_FACTOR/c.EASING_BOUNCE_DIVISOR?c.EASING_BOUNCE_MULTIPLIER*(e-=c.EASING_BOUNCE_THRESHOLD_1/c.EASING_BOUNCE_DIVISOR)*e+c.EASING_BOUNCE_OFFSET_1:e<c.EASING_BOUNCE_THRESHOLD_2/c.EASING_BOUNCE_DIVISOR?c.EASING_BOUNCE_MULTIPLIER*(e-=c.EASING_BOUNCE_THRESHOLD_3/c.EASING_BOUNCE_DIVISOR)*e+c.EASING_BOUNCE_OFFSET_2:c.EASING_BOUNCE_MULTIPLIER*(e-=c.EASING_BOUNCE_THRESHOLD_4/c.EASING_BOUNCE_DIVISOR)*e+c.EASING_BOUNCE_OFFSET_3;default:return e}}pauseAnimation(e){for(const t of this.animations)if(t.id===e){t.paused=!0;break}}resumeAnimation(e){for(const t of this.animations)if(t.id===e){t.paused=!1,t.startTime=performance.now()-(t.duration*t.progress||0);break}}stopAnimation(e){for(const t of this.animations)if(t.id===e){t.cancelled=!0;break}}stopAllAnimations(){for(const e of this.animations)e.cancelled=!0;this.animations.clear()}fadeAnimation(e,t,i=500,r={}){const s=e.alpha||0,a=t-s;return this.animate(n=>{e.alpha=s+a*n,this.requestRender()},i,r)}slideAnimation(e,t,i,r=500,s={}){const a=e.x||0,n=e.y||0,o=t-a,h=i-n;return this.animate(u=>{e.x=a+o*u,e.y=n+h*u,this.requestRender()},r,s)}scaleAnimation(e,t,i=500,r={}){const s=e.scale||1,a=t-s;return this.animate(n=>{e.scale=s+a*n,this.requestRender()},i,r)}get type(){return"canvas"}getElement(){return this.canvas}render(e){if(e){this.performanceMonitor.startFrame(),this.drawCallCount=0;try{this.clear(),e.backgroundColor&&(this.ctx.fillStyle=e.backgroundColor,this.ctx.fillRect(0,0,this.options.width,this.options.height)),e.render&&typeof e.render=="function"?e.render(this):e.objects&&Array.isArray(e.objects)&&e.objects.forEach(t=>this.renderObject(t)),this.accessibilityManager&&e.description&&this.accessibilityManager.updateDescription(e.description)}catch(t){this.errorHandler("Failed to render scene",t)}finally{this.performanceMonitor.endFrame()}}}renderObject(e){if(!(!e||e.visible===!1)){this.ctx.save();try{if((e.x||e.y)&&this.ctx.translate(e.x||0,e.y||0),e.rotation&&this.ctx.rotate(e.rotation),e.scale&&e.scale!==1){const t=typeof e.scale=="object"?e.scale.x:e.scale,i=typeof e.scale=="object"?e.scale.y:e.scale;this.ctx.scale(t,i)}e.alpha!==void 0&&(this.ctx.globalAlpha=Math.max(0,Math.min(1,e.alpha))),e.blendMode&&(this.ctx.globalCompositeOperation=e.blendMode),e.render&&typeof e.render=="function"?e.render(this):e.type&&this.renderByType(e)}catch(t){this.errorHandler(`Failed to render object: ${e.type||"unknown"}`,t)}finally{this.ctx.restore()}}}renderByType(e){const t={fill:e.fill||e.color,stroke:e.stroke||e.borderColor,strokeWidth:e.strokeWidth||e.borderWidth,interactive:e.interactive,id:e.id,label:e.label,ariaLabel:e.ariaLabel,onClick:e.onClick};switch(e.type){case"rect":case"rectangle":this.drawRect(0,0,e.width||c.DEFAULT_OBJECT_WIDTH,e.height||c.DEFAULT_OBJECT_HEIGHT,{...t,borderRadius:e.borderRadius});break;case"circle":this.drawCircle(0,0,e.radius||c.DEFAULT_CIRCLE_RADIUS,t);break;case"text":this.drawText(e.text||"",0,0,{fill:t.fill,fontSize:e.fontSize,fontFamily:e.fontFamily,fontWeight:e.fontWeight,textAlign:e.textAlign||e.align,textBaseline:e.textBaseline||e.baseline,accessible:e.accessible,id:t.id,label:t.label,ariaLabel:t.ariaLabel});break;case"line":this.drawLine(e.x1||0,e.y1||0,e.x2||c.DEFAULT_LINE_LENGTH,e.y2||c.DEFAULT_LINE_LENGTH,{stroke:t.stroke,strokeWidth:t.strokeWidth,lineCap:e.lineCap,dashPattern:e.dashPattern});break;case"path":e.points&&Array.isArray(e.points)&&this.drawPath(e.points,{...t,closePath:e.closePath,smooth:e.smooth});break;case"image":(e.src||e.image)&&this.drawImage(e.src||e.image,0,0,{width:e.width,height:e.height,...t});break;default:this.drawRect(c.PLACEHOLDER_OFFSET,c.PLACEHOLDER_OFFSET,c.PLACEHOLDER_SIZE,c.PLACEHOLDER_SIZE,{fill:"#ff6b6b",stroke:"#e55555",strokeWidth:1}),d.warn(`Unknown object type: ${e.type}`)}}drawImage(e,t,i,r={}){if(this.drawCallCount>=this.options.maxDrawCalls)return;const s=a=>{try{const n=r.width||a.naturalWidth||a.width,o=r.height||a.naturalHeight||a.height;if(r.filter&&(this.ctx.filter=r.filter),r.opacity!==void 0){const h=this.ctx.globalAlpha;this.ctx.globalAlpha=r.opacity,this.ctx.drawImage(a,t,i,n,o),this.ctx.globalAlpha=h}else this.ctx.drawImage(a,t,i,n,o);r.filter&&(this.ctx.filter="none"),r.accessible&&this.accessibilityManager&&this.accessibilityManager.addElement(r.id||`image_${Date.now()}`,{type:"image",x:t,y:i,width:n,height:o,label:r.label||r.alt||"Image",ariaLabel:r.ariaLabel||r.alt||"Interactive image"}),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}catch(n){this.errorHandler("Failed to draw image",n)}};if(typeof e=="string"){if(this.imageCache.has(e)){const n=this.imageCache.get(e);n.complete?s(n):n.addEventListener("load",()=>s(n));return}const a=new Image;this.imageCache.set(e,a),a.onload=()=>s(a),a.onerror=()=>{this.errorHandler("Failed to load image",new Error(`Image not found: ${e}`)),this.imageCache.delete(e)},r.crossOrigin&&(a.crossOrigin=r.crossOrigin),a.src=e}else e instanceof HTMLImageElement?s(e):this.errorHandler("Invalid image source",new Error("Source must be string URL or HTMLImageElement"))}createGradient(e,t,i){let r;try{if(e==="linear"){const{x0:s=0,y0:a=0,x1:n=0,y1:o=100}=i;r=this.ctx.createLinearGradient(s,a,n,o)}else if(e==="radial"){const{x0:s=0,y0:a=0,r0:n=0,x1:o=0,y1:h=0,r1:u=100}=i;r=this.ctx.createRadialGradient(s,a,n,o,h,u)}else throw new Error(`Unsupported gradient type: ${e}`);return t.forEach(s=>{const a=typeof s=="object"?s.offset:s[0],n=typeof s=="object"?s.color:s[1];r.addColorStop(a,n)}),r}catch(s){return this.errorHandler("Failed to create gradient",s),this.currentTheme.primary}}resize(e,t){if(!e||!t||e<=0||t<=0){this.errorHandler("Invalid resize dimensions",new Error("Width and height must be positive"));return}try{const i=Math.min(e,c.MAX_CANVAS_SIZE),r=Math.min(t,c.MAX_CANVAS_SIZE);this.options.width=i,this.options.height=r,this.canvas.width=i*this.options.pixelRatio,this.canvas.height=r*this.options.pixelRatio,this.ctx.scale(this.options.pixelRatio,this.options.pixelRatio),this.applyDefaultStyles(),this.canvas.dispatchEvent(new CustomEvent("canvasResize",{detail:{width:i,height:r}})),this.performanceMonitor.reset(),this.drawCallCount=0}catch(i){this.errorHandler("Failed to resize canvas",i)}}getImageData(e=0,t=0,i=this.options.width,r=this.options.height){try{return this.ctx.getImageData(e,t,i,r)}catch(s){return this.errorHandler("Failed to get image data",s),null}}putImageData(e,t=0,i=0){if(!e){this.errorHandler("Invalid image data",new Error("ImageData is required"));return}try{this.ctx.putImageData(e,t,i),this.performanceMonitor.recordDrawCall(),this.drawCallCount++}catch(r){this.errorHandler("Failed to put image data",r)}}toDataURL(e="image/png",t=.92){try{return this.canvas.toDataURL(e,t)}catch(i){return this.errorHandler("Failed to export canvas",i),null}}toBlob(e,t="image/png",i=.92){try{this.canvas.toBlob(e,t,i)}catch(r){this.errorHandler("Failed to create blob",r),e(null)}}getPerformanceMetrics(){return{...this.performanceMonitor.getMetrics(),drawCallCount:this.drawCallCount,activeAnimations:this.animations.size,cacheSize:this.imageCache.size,canvasSize:{width:this.options.width,height:this.options.height,pixelRatio:this.options.pixelRatio}}}clearImageCache(){this.imageCache.clear()}destroy(){try{this.stopAllAnimations(),this.clearImageCache(),this.resizeObserver?this.resizeObserver.disconnect():window.removeEventListener("resize",this.boundHandleResize),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.accessibilityManager&&(this.accessibilityManager=null),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.ctx=null,this.container=null,this.layers.clear(),document.dispatchEvent(new CustomEvent("canvasRendererDestroyed",{detail:{rendererId:this.id}}))}catch(e){this.errorHandler("Error during cleanup",e)}}}typeof window<"u"&&(window.CanvasRenderer=le);/**
 * Enhanced SVG Renderer for SimulateAI Platform
 * High-performance, accessible, and modern SVG-based graphics rendering
 *
 * Features:
 * - Vector-based scalable graphics with responsive design
 * - Accessibility integration with ARIA and screen reader support
 * - Theme-aware rendering with dark mode support
 * - Performance monitoring and optimization
 * - Advanced animation system with motion sensitivity
 * - Memory management and cleanup
 * - Security-conscious rendering
 * - Comprehensive error handling
 * - SVG-specific optimizations and capabilities
 *
 * @version 2.0.0
 * @author SimulateAI Team
 * @license Apache-2.0
 */const l={VERSION:"2.0.0",DEFAULT_WIDTH:800,DEFAULT_HEIGHT:600,SVG_NAMESPACE:"http://www.w3.org/2000/svg",XLINK_NAMESPACE:"http://www.w3.org/1999/xlink",ANIMATION_FPS:60,PERFORMANCE_SAMPLE_RATE:.1,MAX_ELEMENTS:1e4,PERFORMANCE:{TARGET_FRAME_TIME:16.67,ANIMATION_DURATION_MULTIPLIER:.2,MAX_ANIMATION_DURATION:300},UI:{DEFAULT_FONT_SIZE:14,DEFAULT_PADDING:4,DEFAULT_BORDER_RADIUS:4,DEFAULT_SHADOW_OPACITY:.5,TITLE_OFFSET:-10,DEFAULT_OBJECT_SIZE:50,DEFAULT_RADIUS:25},ID_GENERATION:{RADIX:36,SUBSTRING_LENGTH:9,SUBSTRING_START:2},MATH:{DEGREES_PER_PI:180,HALF:.5,EASING_THRESHOLD_1:.5,EASING_MULTIPLIER:4,BOUNCE_DIVISOR:2.75,BOUNCE_COEFFICIENT:7.5625,BOUNCE_OFFSET_1:1.5,BOUNCE_OFFSET_2:2.25,BOUNCE_OFFSET_3:2.625,BOUNCE_THRESHOLD_1:.75,BOUNCE_THRESHOLD_2:.9375,BOUNCE_THRESHOLD_3:.984375,BOUNCE_MIDPOINT:2.5,ELASTIC_DIVISOR:3,ELASTIC_POWER:-10,ELASTIC_OFFSET:.75,ELASTIC_MULTIPLIER:10,PATTERN_SIZE:5,PATTERN_DOT_RADIUS:1,PLACEHOLDER_OFFSET:-5,PLACEHOLDER_SIZE:10},ACCESSIBILITY:{MIN_CONTRAST_RATIO:4.5,MIN_FONT_SIZE:12,MIN_TOUCH_TARGET:44,MIN_STROKE_WIDTH:1},THEMES:{LIGHT:{background:"#ffffff",foreground:"#333333",primary:"#007acc",secondary:"#28a745",accent:"#6c757d",border:"#e0e0e0"},DARK:{background:"#1a1a1a",foreground:"#e0e0e0",primary:"#4da6ff",secondary:"#66bb6a",accent:"#9e9e9e",border:"#404040"},HIGH_CONTRAST:{background:"#000000",foreground:"#ffffff",primary:"#ffff00",secondary:"#00ffff",accent:"#ff00ff",border:"#ffffff"}}};class ce{constructor(){this.metrics={elementCount:0,animationCount:0,renderTime:0,frameCount:0,averageFrameTime:0,droppedFrames:0,lastFrameTime:0,domOperations:0},this.enabled=l.PERFORMANCE_SAMPLE_RATE>Math.random()}startFrame(){this.enabled&&(this.frameStartTime=performance.now())}endFrame(){if(!this.enabled)return;const e=performance.now()-this.frameStartTime;this.metrics.frameCount++,this.metrics.renderTime+=e,this.metrics.averageFrameTime=this.metrics.renderTime/this.metrics.frameCount,e>l.PERFORMANCE.TARGET_FRAME_TIME&&this.metrics.droppedFrames++,this.metrics.lastFrameTime=e}recordDOMOperation(){this.enabled&&this.metrics.domOperations++}recordElement(){this.enabled&&this.metrics.elementCount++}getMetrics(){return{...this.metrics}}reset(){Object.keys(this.metrics).forEach(e=>{this.metrics[e]=0})}}class he{constructor(e,t){this.svg=e,this.renderer=t,this.description="",this.elements=new Map,this.focusedElement=null,this.tabIndex=0,this.setupAccessibility()}setupAccessibility(){this.svg.setAttribute("role","img"),this.svg.setAttribute("tabindex","0"),this.svg.setAttribute("focusable","true"),this.updateDescription("Interactive simulation SVG graphics"),this.svg.addEventListener("keydown",this.handleKeydown.bind(this)),this.svg.addEventListener("focus",this.handleFocus.bind(this)),this.svg.addEventListener("blur",this.handleBlur.bind(this)),this.svg.addEventListener("click",this.handleClick.bind(this))}updateDescription(e){this.description=e,this.svg.setAttribute("aria-label",e);let t=this.svg.querySelector("title");t||(t=document.createElementNS(l.SVG_NAMESPACE,"title"),this.svg.insertBefore(t,this.svg.firstChild)),t.textContent=e}addElement(e,t){const i={...t,id:e,tabIndex:this.tabIndex++,focusable:t.focusable!==!1};this.elements.set(e,i),t.svgElement&&this.enhanceElementAccessibility(t.svgElement,i),this.updateDescription()}enhanceElementAccessibility(e,t){if(t.focusable&&(e.setAttribute("tabindex",t.tabIndex),e.setAttribute("focusable","true")),t.ariaLabel&&e.setAttribute("aria-label",t.ariaLabel),t.role&&e.setAttribute("role",t.role),t.label||t.ariaLabel){const i=document.createElementNS(l.SVG_NAMESPACE,"title");i.textContent=t.label||t.ariaLabel,e.insertBefore(i,e.firstChild)}if(t.description){const i=document.createElementNS(l.SVG_NAMESPACE,"desc");i.textContent=t.description,e.appendChild(i)}}removeElement(e){this.elements.delete(e),this.focusedElement===e&&(this.focusedElement=null),this.updateDescription()}handleKeydown(e){const t=Array.from(this.elements.values()).filter(r=>r.focusable).sort((r,s)=>r.tabIndex-s.tabIndex);if(t.length===0)return;let i=t.findIndex(r=>r.id===this.focusedElement);switch(e.key){case"Tab":e.preventDefault(),e.shiftKey?i=i<=0?t.length-1:i-1:i=i>=t.length-1?0:i+1,this.focusElement(t[i].id);break;case"Enter":case" ":if(this.focusedElement){const r=this.elements.get(this.focusedElement);r&&r.onClick&&(e.preventDefault(),r.onClick())}break;case"Escape":this.focusedElement&&(this.focusedElement=null,this.svg.focus(),this.renderer.requestRender());break}}handleClick(e){const{target:t}=e,i=this.findElementIdByTarget(t);if(i){this.focusElement(i);const r=this.elements.get(i);r&&r.onClick&&r.onClick(e)}}findElementIdByTarget(e){for(const[t,i]of this.elements.entries())if(i.svgElement===e||i.svgElement?.contains(e))return t;return null}focusElement(e){this.focusedElement=e;const t=this.elements.get(e);t&&(this.announceElement(t),this.highlightFocusedElement(t),this.renderer.requestRender())}highlightFocusedElement(e){if(this.svg.querySelectorAll(".focus-indicator").forEach(t=>t.remove()),e.svgElement){const t=e.svgElement.getBBox(),i=document.createElementNS(l.SVG_NAMESPACE,"rect");i.setAttribute("class","focus-indicator"),i.setAttribute("x",t.x-2),i.setAttribute("y",t.y-2),i.setAttribute("width",t.width+l.UI.DEFAULT_PADDING),i.setAttribute("height",t.height+l.UI.DEFAULT_PADDING),i.setAttribute("fill","none"),i.setAttribute("stroke","#007acc"),i.setAttribute("stroke-width","2"),i.setAttribute("stroke-dasharray","4,2"),i.setAttribute("pointer-events","none"),e.svgElement.parentNode.insertBefore(i,e.svgElement.nextSibling)}}announceElement(e){const t=e.ariaLabel||e.label||`${e.type} element`;this.announceToScreenReader(t)}announceToScreenReader(e){const t=document.createElement("div");t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.style.position="absolute",t.style.left="-10000px",t.style.width="1px",t.style.height="1px",t.style.overflow="hidden",document.body.appendChild(t),t.textContent=e,setTimeout(()=>{document.body.removeChild(t)},1e3)}handleFocus(){this.svg.style.outline="2px solid #007acc"}handleBlur(){this.svg.style.outline="none",this.focusedElement=null,this.svg.querySelectorAll(".focus-indicator").forEach(e=>e.remove())}generateOverallDescription(){const e=new Map;for(const i of this.elements.values()){const r=e.get(i.type)||0;e.set(i.type,r+1)}return`SVG contains ${Array.from(e.entries()).map(([i,r])=>`${r} ${i}${r>1?"s":""}`).join(", ")}`}}class de{constructor(e,t={}){this.container=e,this.options={width:t.width||l.DEFAULT_WIDTH,height:t.height||l.DEFAULT_HEIGHT,preserveAspectRatio:t.preserveAspectRatio||"xMidYMid meet",theme:t.theme||"light",enableAccessibility:t.enableAccessibility!==!1,enablePerformanceMonitoring:t.enablePerformanceMonitoring!==!1,respectReducedMotion:t.respectReducedMotion!==!1,maxElements:t.maxElements||l.MAX_ELEMENTS,...t},this.svg=null,this.defs=null,this.mainGroup=null,this.layers=new Map,this.animations=new Set,this.elementCount=0,this.renderRequested=!1,this.performanceMonitor=new ce,this.accessibilityManager=null,this.currentTheme=l.THEMES[this.options.theme.toUpperCase()]||l.THEMES.LIGHT,this.gradientCache=new Map,this.patternCache=new Map,this.resizeObserver=null,this.boundHandleResize=this.handleResize.bind(this),this.animationFrameId=null,this.lastFrameTime=0,this.errorHandler=t.errorHandler||this.defaultErrorHandler.bind(this);try{this.initialize()}catch(i){this.errorHandler("Initialization failed",i)}}initialize(){this.validateContainer(),this.createSVG(),this.setupStructure(),this.setupAccessibility(),this.setupResponsiveHandling(),this.setupThemeMonitoring(),this.addDefaultStyles()}validateContainer(){if(!this.container||!this.container.nodeType)throw new Error("Invalid container element provided")}createSVG(){this.svg=this.createSVGElement("svg",{width:"100%",height:"100%",viewBox:`0 0 ${this.options.width} ${this.options.height}`,preserveAspectRatio:this.options.preserveAspectRatio,role:"img","aria-label":"Interactive simulation graphics",class:"svg-renderer","data-theme":this.options.theme,"data-version":l.VERSION}),this.container.appendChild(this.svg)}setupStructure(){this.defs=this.createSVGElement("defs"),this.svg.appendChild(this.defs),this.mainGroup=this.createSVGElement("g",{class:"main-group"}),this.svg.appendChild(this.mainGroup)}setupAccessibility(){this.options.enableAccessibility&&(this.accessibilityManager=new he(this.svg,this))}setupResponsiveHandling(){window.ResizeObserver?(this.resizeObserver=new ResizeObserver(this.boundHandleResize),this.resizeObserver.observe(this.container)):window.addEventListener("resize",this.boundHandleResize)}setupThemeMonitoring(){if(window.matchMedia){const e=window.matchMedia("(prefers-contrast: high)"),t=()=>{let i="light";e.matches&&(i="high_contrast"),this.setTheme(i)};e.addEventListener("change",t),t()}}handleResize(e){if(e&&e[0]){const{width:t,height:i}=e[0].contentRect;this.resize(t,i)}else{const t=this.container.getBoundingClientRect();this.resize(t.width,t.height)}}setTheme(e){const t=l.THEMES[e.toUpperCase()];t&&t!==this.currentTheme&&(this.currentTheme=t,this.options.theme=e,this.svg.setAttribute("data-theme",e),this.updateThemeStyles(),this.requestRender())}updateThemeStyles(){this.svg.querySelectorAll("[data-theme-color]").forEach(e=>{const t=e.getAttribute("data-theme-color"),i=this.currentTheme[t];if(i){const r=e.getAttribute("data-theme-attribute")||"fill";e.setAttribute(r,i)}})}requestRender(){this.renderRequested||(this.renderRequested=!0,this.animationFrameId=requestAnimationFrame(e=>{this.performanceMonitor.startFrame(),this.renderRequested=!1,this.lastFrameTime=e,this.performanceMonitor.endFrame()}))}defaultErrorHandler(e,t){d.error(`SVGRenderer Error: ${e}`,t),this.options.enableAccessibility&&this.accessibilityManager&&this.accessibilityManager.announceToScreenReader(`Rendering error: ${e}`)}createSVGElement(e,t={}){try{const i=document.createElementNS(l.SVG_NAMESPACE,e);return Object.entries(t).forEach(([r,s])=>{s!=null&&i.setAttribute(r,s)}),this.performanceMonitor.recordDOMOperation(),i}catch(i){return this.errorHandler(`Failed to create SVG element: ${e}`,i),null}}addDefaultStyles(){const e=this.createSVGElement("style");e&&(e.textContent=`
      .svg-renderer {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
        overflow: hidden;
      }
      
      .svg-renderer[data-theme="light"] {
        background: ${this.currentTheme.background};
        color: ${this.currentTheme.foreground};
      }
      
      .svg-renderer[data-theme="high_contrast"] {
        background: ${l.THEMES.HIGH_CONTRAST.background};
        color: ${l.THEMES.HIGH_CONTRAST.foreground};
      }
      
      .clickable {
        cursor: pointer;
        transition: opacity 0.2s ease;
      }
      
      .clickable:hover:not([aria-disabled="true"]) {
        opacity: 0.8;
      }
      
      .clickable:focus {
        outline: 2px solid #007acc;
        outline-offset: 2px;
      }
      
      .animated {
        transition: all 0.3s ease;
      }
      
      @media (prefers-reduced-motion: reduce) {
        .animated {
          transition: none;
        }
      }
      
      .text-element {
        user-select: none;
        pointer-events: none;
        font-size: ${Math.max(l.UI.DEFAULT_FONT_SIZE,l.ACCESSIBILITY.MIN_FONT_SIZE)}px;
      }
      
      .interactive {
        pointer-events: all;
      }
      
      .accessible-element {
        outline: none;
      }
      
      .accessible-element:focus {
        outline: 2px solid #007acc;
        outline-offset: 1px;
      }
      
      .focus-indicator {
        animation: focus-pulse 2s infinite;
      }
      
      @keyframes focus-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .screen-reader-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    `,this.defs.appendChild(e))}createLayer(e,t=0,i={}){const r=this.createSVGElement("g",{class:`layer layer-${e} ${i.className||""}`,"data-layer":e,"data-z-index":t,transform:i.transform||"",opacity:i.opacity||1});if(!r)return null;const s=Array.from(this.mainGroup.children).filter(n=>n.hasAttribute("data-layer")).sort((n,o)=>{const h=parseInt(n.getAttribute("data-z-index")||"0"),u=parseInt(o.getAttribute("data-z-index")||"0");return h-u});let a=null;for(const n of s)if(parseInt(n.getAttribute("data-z-index")||"0")>t){a=n;break}return a?this.mainGroup.insertBefore(r,a):this.mainGroup.appendChild(r),this.layers.set(e,r),this.performanceMonitor.recordElement(),r}getLayer(e){return this.layers.get(e)||this.createLayer(e)}createRect(e,t,i,r,s={}){if(this.elementCount>=this.options.maxElements)return this.errorHandler("Maximum element count exceeded",new Error("Performance limit")),null;try{const a=s.fill||(s.primary?this.currentTheme.primary:"transparent"),n=s.stroke||(s.border?this.currentTheme.border:"none");s.interactive&&(i<l.ACCESSIBILITY.MIN_TOUCH_TARGET||r<l.ACCESSIBILITY.MIN_TOUCH_TARGET)&&d.warn("Interactive element below minimum touch target size");const o=this.createSVGElement("rect",{x:e,y:t,width:i,height:r,fill:a,stroke:n,"stroke-width":s.strokeWidth||(n!=="none"?l.ACCESSIBILITY.MIN_STROKE_WIDTH:0),rx:s.borderRadius||0,ry:s.borderRadius||0,class:`rect-element ${s.className||""} ${s.interactive?"interactive clickable accessible-element":""}`,"data-theme-color":s.themeColor,"data-theme-attribute":s.themeAttribute||"fill",...s.attributes});return o?(s.interactive&&this.accessibilityManager&&this.accessibilityManager.addElement(s.id||`rect_${this.elementCount}`,{type:"rectangle",svgElement:o,x:e,y:t,width:i,height:r,label:s.label,ariaLabel:s.ariaLabel,description:s.description,onClick:s.onClick,focusable:s.focusable!==!1,role:s.role||"button"}),this.elementCount++,this.performanceMonitor.recordElement(),o):null}catch(a){return this.errorHandler("Failed to create rectangle",a),null}}createCircle(e,t,i,r={}){if(this.elementCount>=this.options.maxElements)return this.errorHandler("Maximum element count exceeded",new Error("Performance limit")),null;try{const s=r.fill||(r.primary?this.currentTheme.primary:"transparent"),a=r.stroke||(r.border?this.currentTheme.border:"none"),n=i*2;r.interactive&&n<l.ACCESSIBILITY.MIN_TOUCH_TARGET&&d.warn("Interactive circle below minimum touch target size");const o=this.createSVGElement("circle",{cx:e,cy:t,r:i,fill:s,stroke:a,"stroke-width":r.strokeWidth||(a!=="none"?l.ACCESSIBILITY.MIN_STROKE_WIDTH:0),class:`circle-element ${r.className||""} ${r.interactive?"interactive clickable accessible-element":""}`,"data-theme-color":r.themeColor,"data-theme-attribute":r.themeAttribute||"fill",...r.attributes});return o?(r.interactive&&this.accessibilityManager&&this.accessibilityManager.addElement(r.id||`circle_${this.elementCount}`,{type:"circle",svgElement:o,x:e-i,y:t-i,width:n,height:n,label:r.label,ariaLabel:r.ariaLabel,description:r.description,onClick:r.onClick,focusable:r.focusable!==!1,role:r.role||"button"}),this.elementCount++,this.performanceMonitor.recordElement(),o):null}catch(s){return this.errorHandler("Failed to create circle",s),null}}createLine(e,t,i,r,s={}){if(this.elementCount>=this.options.maxElements)return this.errorHandler("Maximum element count exceeded",new Error("Performance limit")),null;try{const a=s.stroke||this.currentTheme.foreground,n=this.createSVGElement("line",{x1:e,y1:t,x2:i,y2:r,stroke:a,"stroke-width":Math.max(s.strokeWidth||1,l.ACCESSIBILITY.MIN_STROKE_WIDTH),"stroke-linecap":s.linecap||"round","stroke-linejoin":s.linejoin||"round","stroke-dasharray":s.dashArray,"stroke-dashoffset":s.dashOffset,class:`line-element ${s.className||""}`,"data-theme-color":s.themeColor,"data-theme-attribute":"stroke",...s.attributes});return n?(this.elementCount++,this.performanceMonitor.recordElement(),n):null}catch(a){return this.errorHandler("Failed to create line",a),null}}createPath(e,t={}){if(this.elementCount>=this.options.maxElements)return this.errorHandler("Maximum element count exceeded",new Error("Performance limit")),null;try{const i=t.fill||"none",r=t.stroke||this.currentTheme.foreground,s=this.createSVGElement("path",{d:e,fill:i,stroke:r,"stroke-width":t.strokeWidth||(r!=="none"?l.ACCESSIBILITY.MIN_STROKE_WIDTH:0),"stroke-linecap":t.linecap||"round","stroke-linejoin":t.linejoin||"round","stroke-dasharray":t.dashArray,"stroke-dashoffset":t.dashOffset,"fill-rule":t.fillRule||"evenodd",class:`path-element ${t.className||""} ${t.interactive?"interactive clickable accessible-element":""}`,"data-theme-color":t.themeColor,"data-theme-attribute":t.themeAttribute||"stroke",...t.attributes});return s?(t.interactive&&this.accessibilityManager&&this.accessibilityManager.addElement(t.id||`path_${this.elementCount}`,{type:"path",svgElement:s,label:t.label,ariaLabel:t.ariaLabel,description:t.description,onClick:t.onClick,focusable:t.focusable!==!1,role:t.role||"button"}),this.elementCount++,this.performanceMonitor.recordElement(),s):null}catch(i){return this.errorHandler("Failed to create path",i),null}}createText(e,t,i,r={}){if(this.elementCount>=this.options.maxElements)return this.errorHandler("Maximum element count exceeded",new Error("Performance limit")),null;try{const s=Math.max(parseFloat(r.fontSize)||l.UI.DEFAULT_FONT_SIZE,l.ACCESSIBILITY.MIN_FONT_SIZE),a=r.fill||r.color||this.currentTheme.foreground,n=this.createSVGElement("text",{x:e,y:t,"text-anchor":r.textAnchor||"start","dominant-baseline":r.dominantBaseline||"middle","font-size":s,"font-family":r.fontFamily||"inherit","font-weight":r.fontWeight||"normal","font-style":r.fontStyle||"normal","text-decoration":r.textDecoration,fill:a,stroke:r.stroke,"stroke-width":r.strokeWidth||0,"letter-spacing":r.letterSpacing,"word-spacing":r.wordSpacing,class:`text-element ${r.className||""} ${r.accessible?"accessible-element":""}`,"data-theme-color":r.themeColor,"data-theme-attribute":"fill",...r.attributes});if(!n)return null;if(n.textContent=i,r.shadow){const o=this.createTextShadowFilter(r.shadow);o&&n.setAttribute("filter",`url(#${o.id})`)}return r.accessible&&this.accessibilityManager&&this.accessibilityManager.addElement(r.id||`text_${this.elementCount}`,{type:"text",svgElement:n,x:e,y:t,width:n.getBBox?n.getBBox().width:0,height:s,text:i,label:r.label||i,ariaLabel:r.ariaLabel||i,description:r.description}),this.elementCount++,this.performanceMonitor.recordElement(),n}catch(s){return this.errorHandler("Failed to create text",s),null}}createGroup(e={}){try{const t=this.createSVGElement("g",{class:`group-element ${e.className||""}`,transform:e.transform||"",opacity:e.opacity||1,"data-group-id":e.id,...e.attributes});return t?(this.elementCount++,this.performanceMonitor.recordElement(),t):null}catch(t){return this.errorHandler("Failed to create group",t),null}}createTextShadowFilter(e){try{const t=`text-shadow-${Math.random().toString(l.ID_GENERATION.RADIX).substr(l.ID_GENERATION.SUBSTRING_START,l.ID_GENERATION.SUBSTRING_LENGTH)}`,i=this.createSVGElement("filter",{id:t,x:"-50%",y:"-50%",width:"200%",height:"200%"}),r=this.createSVGElement("feDropShadow",{dx:e.offsetX||1,dy:e.offsetY||1,"std-deviation":e.blur||1,"flood-color":e.color||"rgba(0,0,0,0.5)","flood-opacity":e.opacity||l.UI.DEFAULT_SHADOW_OPACITY});return i.appendChild(r),this.defs.appendChild(i),i}catch(t){return this.errorHandler("Failed to create text shadow filter",t),null}}createGradient(e,t,i,r){try{const s=r||`gradient-${Math.random().toString(l.ID_GENERATION.RADIX).substr(l.ID_GENERATION.SUBSTRING_START,l.ID_GENERATION.SUBSTRING_LENGTH)}`;if(this.gradientCache.has(s))return this.gradientCache.get(s);let a;if(e==="linear")a=this.createSVGElement("linearGradient",{id:s,x1:i.x1||"0%",y1:i.y1||"0%",x2:i.x2||"100%",y2:i.y2||"0%"});else if(e==="radial")a=this.createSVGElement("radialGradient",{id:s,cx:i.cx||"50%",cy:i.cy||"50%",r:i.r||"50%",fx:i.fx||i.cx||"50%",fy:i.fy||i.cy||"50%"});else throw new Error(`Unsupported gradient type: ${e}`);return a?(t.forEach(n=>{const o=typeof n=="object"?n.offset:n[0],h=typeof n=="object"?n.color:n[1],u=typeof n=="object"?n.opacity:void 0,m=this.createSVGElement("stop",{offset:typeof o=="number"?`${o*100}%`:o,"stop-color":h,"stop-opacity":u});a.appendChild(m)}),this.defs.appendChild(a),this.gradientCache.set(s,a),a):null}catch(s){return this.errorHandler("Failed to create gradient",s),null}}createButton(e,t,i,r,s,a,n={}){try{const o=Math.max(i,l.ACCESSIBILITY.MIN_TOUCH_TARGET),h=Math.max(r,l.ACCESSIBILITY.MIN_TOUCH_TARGET),u=this.createGroup({className:"svg-button clickable interactive accessible-element",transform:`translate(${e}, ${t})`,id:n.id});if(!u)return null;const m=this.createRect(0,0,o,h,{fill:n.backgroundColor||this.currentTheme.primary,stroke:n.borderColor||this.currentTheme.border,strokeWidth:1,borderRadius:n.borderRadius||l.UI.DEFAULT_BORDER_RADIUS,themeColor:"primary",className:"button-background"}),T=this.createText(o/2,h/2,s,{textAnchor:"middle",dominantBaseline:"middle",fill:n.textColor||"#ffffff",fontSize:Math.max(n.fontSize||l.UI.DEFAULT_FONT_SIZE,l.ACCESSIBILITY.MIN_FONT_SIZE),fontWeight:n.fontWeight||"500",className:"button-text",accessible:!0});return m&&u.appendChild(m),T&&u.appendChild(T),a&&(u.addEventListener("click",a),u.addEventListener("keydown",f=>{(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),a(f))})),u.setAttribute("tabindex","0"),u.setAttribute("role","button"),u.setAttribute("aria-label",n.ariaLabel||s),n.disabled&&(u.setAttribute("aria-disabled","true"),u.style.opacity="0.5",u.style.cursor="not-allowed"),this.accessibilityManager&&this.accessibilityManager.addElement(n.id||`button_${this.elementCount}`,{type:"button",svgElement:u,x:e,y:t,width:o,height:h,text:s,label:n.label||s,ariaLabel:n.ariaLabel||s,description:n.description,onClick:a,focusable:!n.disabled,role:"button"}),this.elementCount++,this.performanceMonitor.recordElement(),u}catch(o){return this.errorHandler("Failed to create button",o),null}}createChart(e,t,i,r,s={}){try{const a=this.createGroup({className:"svg-chart accessible-element",transform:`translate(${e}, ${t})`,id:s.id});if(!a)return null;if(s.backgroundColor!==!1){const n=this.createRect(0,0,i,r,{fill:s.backgroundColor||this.currentTheme.background,stroke:s.borderColor||this.currentTheme.border,strokeWidth:s.borderWidth||1,className:"chart-background"});n&&a.appendChild(n)}if(s.title){const n=this.createText(i/2,l.UI.TITLE_OFFSET,s.title,{textAnchor:"middle",fill:this.currentTheme.foreground,fontSize:16,fontWeight:"bold",className:"chart-title",accessible:!0});n&&a.appendChild(n)}return this.accessibilityManager&&this.accessibilityManager.addElement(s.id||`chart_${this.elementCount}`,{type:"chart",svgElement:a,x:e,y:t,width:i,height:r,label:s.label||s.title||"Chart",ariaLabel:s.ariaLabel||`${s.type||"Data"} chart`,description:s.description||"Interactive data visualization"}),this.elementCount++,this.performanceMonitor.recordElement(),a}catch(a){return this.errorHandler("Failed to create chart",a),null}}createPattern(e,t={},i){try{const r=i||`pattern-${e}-${Math.random().toString(l.ID_GENERATION.RADIX).substr(l.ID_GENERATION.SUBSTRING_START,l.ID_GENERATION.SUBSTRING_LENGTH)}`;if(this.patternCache.has(r))return this.patternCache.get(r);const s=this.createSVGElement("pattern",{id:r,patternUnits:"userSpaceOnUse",width:t.width||10,height:t.height||10});if(!s)return null;const a=t.color||this.currentTheme.accent,n=t.strokeWidth||1;switch(e){case"dots":{const o=this.createCircle(l.MATH.PATTERN_SIZE,l.MATH.PATTERN_SIZE,l.MATH.PATTERN_DOT_RADIUS,{fill:a});o&&s.appendChild(o);break}case"lines":{const o=this.createLine(0,0,0,10,{stroke:a,strokeWidth:n});o&&s.appendChild(o);break}case"grid":{const o=this.createLine(0,0,0,10,{stroke:a,strokeWidth:n}),h=this.createLine(0,0,10,0,{stroke:a,strokeWidth:n});o&&s.appendChild(o),h&&s.appendChild(h);break}case"diagonal":{const o=this.createLine(0,10,10,0,{stroke:a,strokeWidth:n});o&&s.appendChild(o);break}default:d.warn(`Unknown pattern type: ${e}`)}return this.defs.appendChild(s),this.patternCache.set(r,s),s}catch(r){return this.errorHandler("Failed to create pattern",r),null}}animate(e,t,i=1e3,r="ease",s={}){if(!e)return this.errorHandler("Invalid element for animation",new Error("Element is required")),null;if(this.options.respectReducedMotion&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches){if(s.skipOnReducedMotion!==!1)return this.applyFinalAnimationState(e,t),null;i=Math.min(i*l.PERFORMANCE.ANIMATION_DURATION_MULTIPLIER,l.PERFORMANCE.MAX_ANIMATION_DURATION)}const a={element:e,properties:t,duration:i,easing:r,startTime:performance.now(),startValues:{},id:Math.random().toString(l.ID_GENERATION.RADIX).substr(l.ID_GENERATION.SUBSTRING_START,l.ID_GENERATION.SUBSTRING_LENGTH),onComplete:s.onComplete,onProgress:s.onProgress,paused:!1,cancelled:!1};return Object.keys(t).forEach(n=>{try{n==="transform"?a.startValues[n]=e.getAttribute("transform")||"":n==="opacity"?a.startValues[n]=parseFloat(e.getAttribute("opacity"))||1:a.startValues[n]=parseFloat(e.getAttribute(n))||0}catch(o){d.warn(`Failed to get starting value for property: ${n}`,o),a.startValues[n]=0}}),this.animations.add(a),this.runAnimation(a),a.id}applyFinalAnimationState(e,t){try{Object.entries(t).forEach(([i,r])=>{e.setAttribute(i,r)})}catch(i){this.errorHandler("Failed to apply animation state",i)}}runAnimation(e){const t=i=>{if(e.cancelled){this.animations.delete(e);return}if(e.paused){requestAnimationFrame(t);return}const r=i-e.startTime;let s=Math.min(r/e.duration,1);s=this.applyEasing(s,e.easing);try{Object.entries(e.properties).forEach(([a,n])=>{const o=e.startValues[a];if(a==="transform")e.element.setAttribute(a,n);else{const h=o+(n-o)*s;e.element.setAttribute(a,h)}}),e.onProgress&&e.onProgress(s),s<1?requestAnimationFrame(t):(this.animations.delete(e),e.onComplete&&e.onComplete())}catch(a){this.errorHandler("Animation update failed",a),this.animations.delete(e)}};requestAnimationFrame(t)}applyEasing(e,t){switch(t){case"linear":return e;case"ease-in":return e*e;case"ease-out":return e*(2-e);case"ease-in-out":return e<l.MATH.EASING_THRESHOLD_1?2*e*e:-1+(l.MATH.EASING_MULTIPLIER-2*e)*e;case"ease-in-cubic":return e*e*e;case"ease-out-cubic":return--e*e*e+1;case"ease-in-out-cubic":return e<l.MATH.EASING_THRESHOLD_1?l.MATH.EASING_MULTIPLIER*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;case"bounce":return e<1/l.MATH.BOUNCE_DIVISOR?l.MATH.BOUNCE_COEFFICIENT*e*e:e<2/l.MATH.BOUNCE_DIVISOR?l.MATH.BOUNCE_COEFFICIENT*(e-=l.MATH.BOUNCE_OFFSET_1/l.MATH.BOUNCE_DIVISOR)*e+l.MATH.BOUNCE_THRESHOLD_1:e<l.MATH.BOUNCE_MIDPOINT/l.MATH.BOUNCE_DIVISOR?l.MATH.BOUNCE_COEFFICIENT*(e-=l.MATH.BOUNCE_OFFSET_2/l.MATH.BOUNCE_DIVISOR)*e+l.MATH.BOUNCE_THRESHOLD_2:l.MATH.BOUNCE_COEFFICIENT*(e-=l.MATH.BOUNCE_OFFSET_3/l.MATH.BOUNCE_DIVISOR)*e+l.MATH.BOUNCE_THRESHOLD_3;case"elastic":{const i=2*Math.PI/l.MATH.ELASTIC_DIVISOR;return e===0?0:e===1?1:Math.pow(2,l.MATH.ELASTIC_POWER*e)*Math.sin((e*l.MATH.ELASTIC_MULTIPLIER-l.MATH.ELASTIC_OFFSET)*i)+1}default:return e}}pauseAnimation(e){for(const t of this.animations)if(t.id===e){t.paused=!0;break}}resumeAnimation(e){for(const t of this.animations)if(t.id===e){t.paused=!1;break}}stopAnimation(e){for(const t of this.animations)if(t.id===e){t.cancelled=!0;break}}stopAllAnimations(){for(const e of this.animations)e.cancelled=!0;this.animations.clear()}fadeAnimation(e,t,i=500,r={}){return this.animate(e,{opacity:t},i,r.easing||"ease-out",r)}slideAnimation(e,t,i,r=500,s={}){const a=`translate(${t}, ${i})`;return this.animate(e,{transform:a},r,s.easing||"ease-out",s)}scaleAnimation(e,t,i=500,r={}){const s=e.getAttribute("transform")||"",a=`scale(${t})`;let n=a;return s&&!s.includes("scale")&&(n=`${s} ${a}`),this.animate(e,{transform:n},i,r.easing||"ease-out",r)}rotateAnimation(e,t,i=500,r={}){const s=e.getAttribute("transform")||"",a=`rotate(${t})`;let n=a;return s&&!s.includes("rotate")&&(n=`${s} ${a}`),this.animate(e,{transform:n},i,r.easing||"ease-out",r)}get type(){return"svg"}getElement(){return this.svg}render(e){if(e){this.performanceMonitor.startFrame();try{if(this.clear(),e.backgroundColor){const t=this.createRect(0,0,this.options.width,this.options.height,{fill:e.backgroundColor,className:"scene-background"});t&&this.mainGroup.appendChild(t)}e.render&&typeof e.render=="function"?e.render(this):e.objects&&Array.isArray(e.objects)&&e.objects.forEach(t=>this.renderObject(t)),this.accessibilityManager&&e.description&&this.accessibilityManager.updateDescription(e.description)}catch(t){this.errorHandler("Failed to render scene",t)}finally{this.performanceMonitor.endFrame()}}}renderObject(e){if(!(!e||e.visible===!1))try{const t=this.createGroup({className:"scene-object",id:e.id});if(!t)return;const i=[];if((e.x||e.y)&&i.push(`translate(${e.x||0}, ${e.y||0})`),e.rotation){const s=e.rotation*l.MATH.DEGREES_PER_PI/Math.PI;i.push(`rotate(${s})`)}if(e.scale&&e.scale!==1){const s=typeof e.scale=="object"?e.scale.x:e.scale,a=typeof e.scale=="object"?e.scale.y:e.scale;i.push(`scale(${s}, ${a})`)}i.length>0&&t.setAttribute("transform",i.join(" ")),e.alpha!==void 0&&t.setAttribute("opacity",Math.max(0,Math.min(1,e.alpha))),e.blendMode&&(t.style.mixBlendMode=e.blendMode);let r;e.render&&typeof e.render=="function"?e.render(this,t):e.type&&(r=this.renderByType(e)),r&&t.appendChild(r),this.mainGroup.appendChild(t)}catch(t){this.errorHandler(`Failed to render object: ${e.type||"unknown"}`,t)}}renderByType(e){const t={fill:e.fill||e.color,stroke:e.stroke||e.borderColor,strokeWidth:e.strokeWidth||e.borderWidth,className:e.className,interactive:e.interactive,id:e.id,label:e.label,ariaLabel:e.ariaLabel,description:e.description,onClick:e.onClick,themeColor:e.themeColor,themeAttribute:e.themeAttribute};try{switch(e.type){case"rect":case"rectangle":return this.createRect(0,0,e.width||l.UI.DEFAULT_OBJECT_SIZE,e.height||l.UI.DEFAULT_OBJECT_SIZE,{...t,borderRadius:e.borderRadius});case"circle":return this.createCircle(0,0,e.radius||l.UI.DEFAULT_RADIUS,t);case"ellipse":return this.createSVGElement("ellipse",{cx:0,cy:0,rx:e.radiusX||e.radius||l.UI.DEFAULT_RADIUS,ry:e.radiusY||e.radius||l.UI.DEFAULT_RADIUS,fill:t.fill||"transparent",stroke:t.stroke||"none","stroke-width":t.strokeWidth||l.ACCESSIBILITY.MIN_STROKE_WIDTH,class:`ellipse-element ${t.className||""}`});case"text":return this.createText(0,0,e.text||"",{fill:t.fill,fontSize:e.fontSize,fontFamily:e.fontFamily,fontWeight:e.fontWeight,fontStyle:e.fontStyle,textAnchor:e.textAnchor||e.align,dominantBaseline:e.dominantBaseline||e.baseline,accessible:e.accessible,className:t.className,id:t.id,label:t.label,ariaLabel:t.ariaLabel,description:t.description});case"line":return this.createLine(e.x1||0,e.y1||0,e.x2||l.UI.DEFAULT_OBJECT_SIZE,e.y2||l.UI.DEFAULT_OBJECT_SIZE,{stroke:t.stroke,strokeWidth:t.strokeWidth,linecap:e.linecap,linejoin:e.linejoin,dashArray:e.dashArray,dashOffset:e.dashOffset,className:t.className});case"path":if(e.pathData||e.d)return this.createPath(e.pathData||e.d,{...t,linecap:e.linecap,linejoin:e.linejoin,dashArray:e.dashArray,fillRule:e.fillRule});break;case"polygon":if(e.points){const i=Array.isArray(e.points)?e.points.map(r=>`${r.x},${r.y}`).join(" "):e.points;return this.createSVGElement("polygon",{points:i,fill:t.fill||"transparent",stroke:t.stroke||"none","stroke-width":t.strokeWidth||l.ACCESSIBILITY.MIN_STROKE_WIDTH,class:`polygon-element ${t.className||""}`})}break;case"polyline":if(e.points){const i=Array.isArray(e.points)?e.points.map(r=>`${r.x},${r.y}`).join(" "):e.points;return this.createSVGElement("polyline",{points:i,fill:"none",stroke:t.stroke||this.currentTheme.foreground,"stroke-width":t.strokeWidth||l.ACCESSIBILITY.MIN_STROKE_WIDTH,class:`polyline-element ${t.className||""}`})}break;case"image":if(e.href||e.src)return this.createSVGElement("image",{x:0,y:0,width:e.width||l.UI.DEFAULT_OBJECT_SIZE,height:e.height||l.UI.DEFAULT_OBJECT_SIZE,href:e.href||e.src,preserveAspectRatio:e.preserveAspectRatio||"xMidYMid meet",class:`image-element ${t.className||""}`});break;default:return d.warn(`Unknown object type: ${e.type}`),this.createRect(l.MATH.PLACEHOLDER_OFFSET,l.MATH.PLACEHOLDER_OFFSET,l.MATH.PLACEHOLDER_SIZE,l.MATH.PLACEHOLDER_SIZE,{fill:"#ff6b6b",stroke:"#e55555",strokeWidth:1,className:"unknown-object-placeholder"})}}catch(i){return this.errorHandler(`Failed to render object type: ${e.type}`,i),null}return null}resize(e,t){if(!e||!t||e<=0||t<=0){this.errorHandler("Invalid resize dimensions",new Error("Width and height must be positive"));return}try{this.options.width=e,this.options.height=t,this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`),this.svg.dispatchEvent(new CustomEvent("svgResize",{detail:{width:e,height:t}})),this.performanceMonitor.reset(),this.elementCount=0}catch(i){this.errorHandler("Failed to resize SVG",i)}}addToLayer(e,t){if(!t)return this.errorHandler("Invalid element provided to layer",new Error("Element is required")),null;try{return this.getLayer(e).appendChild(t),t}catch(i){return this.errorHandler("Failed to add element to layer",i),null}}clear(e=null){try{if(e){const t=this.getLayer(e);t.innerHTML=""}else this.mainGroup.innerHTML="",this.layers.clear(),this.elementCount=0,this.accessibilityManager&&this.accessibilityManager.elements.clear();this.performanceMonitor.recordDOMOperation()}catch(t){this.errorHandler("Failed to clear SVG content",t)}}setViewBox(e,t,i,r){try{this.svg.setAttribute("viewBox",`${e} ${t} ${i} ${r}`)}catch(s){this.errorHandler("Failed to set viewBox",s)}}exportSVG(e={}){try{let t=new XMLSerializer().serializeToString(this.svg);return e.optimize&&(t=t.replace(/>\s+</g,"><"),t=t.replace(/<!--[\s\S]*?-->/g,"")),e.standalone&&(t=`<?xml version="1.0" encoding="UTF-8"?>
${t}`),t}catch(t){return this.errorHandler("Failed to export SVG",t),""}}toDataURL(e={}){try{const t=this.exportSVG(e);return`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(t)))}`}catch(t){return this.errorHandler("Failed to create data URL",t),""}}getPerformanceMetrics(){return{...this.performanceMonitor.getMetrics(),elementCount:this.elementCount,activeAnimations:this.animations.size,gradientCacheSize:this.gradientCache.size,patternCacheSize:this.patternCache.size,layerCount:this.layers.size,svgSize:{width:this.options.width,height:this.options.height}}}clearCaches(){try{this.gradientCache.clear(),this.patternCache.clear()}catch(e){this.errorHandler("Failed to clear caches",e)}}getElementById(e){try{return this.svg.querySelector(`#${CSS.escape(e)}`)}catch(t){return this.errorHandler("Failed to find element by ID",t),null}}getElementsByClassName(e){try{return this.svg.querySelectorAll(`.${CSS.escape(e)}`)}catch(t){return this.errorHandler("Failed to find elements by class",t),[]}}getBoundingBox(e=null){try{const t=e||this.svg;return t.getBBox?t.getBBox():t.getBoundingClientRect?t.getBoundingClientRect():{x:0,y:0,width:0,height:0}}catch(t){return this.errorHandler("Failed to get bounding box",t),{x:0,y:0,width:0,height:0}}}destroy(){try{this.stopAllAnimations(),this.clearCaches(),this.resizeObserver?this.resizeObserver.disconnect():window.removeEventListener("resize",this.boundHandleResize),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.accessibilityManager&&(this.accessibilityManager.elements.clear(),this.accessibilityManager=null),this.svg&&this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svg=null,this.defs=null,this.mainGroup=null,this.container=null,this.layers.clear(),document.dispatchEvent(new CustomEvent("svgRendererDestroyed",{detail:{rendererId:this.id}}))}catch(e){this.errorHandler("Error during cleanup",e)}}}typeof window<"u"&&(window.SVGRenderer=de);const E={DEFAULT_WIDTH:800,DEFAULT_HEIGHT:600,MATRIX_SIZE:16,DEPTH_PROJECTION:-2,VERTICES_PER_QUAD:4,TRIANGLE_VERTEX_COUNT:3,FLOATS_PER_VERTEX:8,BYTES_PER_FLOAT:4,DEFAULT_OBJECT_SIZE:50,HEX_SHORT_LENGTH:3,HEX_LONG_LENGTH:6,HEX_RADIX:16,COLOR_COMPONENT_MAX:255,HEX_SLICE_START:2,HEX_SLICE_MID:4,HEX_SLICE_END:6,DEFAULT_COLOR:[1,1,1]};class Ie{constructor(e,t={}){this.container=e,this.options={width:t.width||E.DEFAULT_WIDTH,height:t.height||E.DEFAULT_HEIGHT,pixelRatio:t.pixelRatio||window.devicePixelRatio||1,alpha:t.alpha!==!1,antialias:t.antialias!==!1,powerPreference:t.powerPreference||"default",...t},this.canvas=null,this.gl=null,this.programs=new Map,this.buffers=new Map,this.textures=new Map,this.activeProgram=null,this.projectionMatrix=new Float32Array(E.MATRIX_SIZE),this.modelMatrix=new Float32Array(E.MATRIX_SIZE),this.viewMatrix=new Float32Array(E.MATRIX_SIZE),this.batchBuffer=[],this.maxBatchSize=1e3,this.initialize()}initialize(){try{if(this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.display="block",this.canvas.width=this.options.width*this.options.pixelRatio,this.canvas.height=this.options.height*this.options.pixelRatio,this.gl=this.canvas.getContext("webgl",{alpha:this.options.alpha,antialias:this.options.antialias,powerPreference:this.options.powerPreference})||this.canvas.getContext("experimental-webgl"),!this.gl)throw new Error("WebGL not supported");this.setupWebGL(),this.createShaders(),this.createBuffers(),this.setupMatrices(),this.canvas.setAttribute("role","img"),this.canvas.setAttribute("aria-label","WebGL simulation graphics"),this.container.appendChild(this.canvas),d.info("WebGLRenderer: Initialized successfully")}catch(e){throw d.error("WebGLRenderer: Failed to initialize:",e),e}}setupWebGL(){const{gl:e}=this;e.viewport(0,0,this.canvas.width,this.canvas.height),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,0)}createShaders(){const i=this.createShaderProgram(`
            attribute vec2 a_position;
            attribute vec2 a_texCoord;
            attribute vec4 a_color;
            
            uniform mat4 u_projection;
            uniform mat4 u_model;
            
            varying vec2 v_texCoord;
            varying vec4 v_color;
            
            void main() {
                gl_Position = u_projection * u_model * vec4(a_position, 0.0, 1.0);
                v_texCoord = a_texCoord;
                v_color = a_color;
            }
        `,`
            precision mediump float;
            
            varying vec2 v_texCoord;
            varying vec4 v_color;
            
            uniform sampler2D u_texture;
            uniform bool u_useTexture;
            
            void main() {
                if (u_useTexture) {
                    gl_FragColor = texture2D(u_texture, v_texCoord) * v_color;
                } else {
                    gl_FragColor = v_color;
                }
            }
        `);this.programs.set("basic",i),i.locations={attributes:{position:this.gl.getAttribLocation(i,"a_position"),texCoord:this.gl.getAttribLocation(i,"a_texCoord"),color:this.gl.getAttribLocation(i,"a_color")},uniforms:{projection:this.gl.getUniformLocation(i,"u_projection"),model:this.gl.getUniformLocation(i,"u_model"),texture:this.gl.getUniformLocation(i,"u_texture"),useTexture:this.gl.getUniformLocation(i,"u_useTexture")}},this.useProgram("basic")}createShaderProgram(e,t){const{gl:i}=this,r=this.createShader(i.VERTEX_SHADER,e),s=this.createShader(i.FRAGMENT_SHADER,t),a=i.createProgram();if(i.attachShader(a,r),i.attachShader(a,s),i.linkProgram(a),!i.getProgramParameter(a,i.LINK_STATUS)){const n=i.getProgramInfoLog(a);throw i.deleteProgram(a),new Error(`Failed to link shader program: ${n}`)}return a}createShader(e,t){const{gl:i}=this,r=i.createShader(e);if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const s=i.getShaderInfoLog(r);throw i.deleteShader(r),new Error(`Failed to compile shader: ${s}`)}return r}createBuffers(){const{gl:e}=this;this.buffers.set("vertex",e.createBuffer()),this.buffers.set("index",e.createBuffer()),this.buffers.set("batch",e.createBuffer())}setupMatrices(){this.setOrthographicProjection(0,this.options.width,this.options.height,0,-1,1),this.setIdentityMatrix(this.modelMatrix),this.setIdentityMatrix(this.viewMatrix)}setOrthographicProjection(e,t,i,r,s,a){const n=this.projectionMatrix;n[0]=2/(t-e),n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/(r-i),n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=E.DEPTH_PROJECTION/(a-s),n[11]=0,n[12]=-(t+e)/(t-e),n[13]=-(r+i)/(r-i),n[14]=-(a+s)/(a-s),n[15]=1}setIdentityMatrix(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}useProgram(e){const t=this.programs.get(e);t&&t!==this.activeProgram&&(this.gl.useProgram(t),this.activeProgram=t,this.gl.uniformMatrix4fv(t.locations.uniforms.projection,!1,this.projectionMatrix),this.gl.uniformMatrix4fv(t.locations.uniforms.model,!1,this.modelMatrix))}get type(){return"webgl"}getElement(){return this.canvas}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.batchBuffer=[]}render(e){this.clear(),e&&e.render&&e.render(this),this.flushBatch()}renderObject(e){!e||e.visible===!1||this.addToBatch(e)}addToBatch(e){const t={type:e.type||"rect",x:e.x||0,y:e.y||0,width:e.width||E.DEFAULT_OBJECT_SIZE,height:e.height||E.DEFAULT_OBJECT_SIZE,color:this.parseColor(e.fill||"#ffffff"),alpha:e.alpha!==void 0?e.alpha:1,rotation:e.rotation||0,scale:e.scale||1};this.batchBuffer.push(t),this.batchBuffer.length>=this.maxBatchSize&&this.flushBatch()}flushBatch(){if(this.batchBuffer.length===0)return;const{gl:e}=this,{activeProgram:t}=this;if(!t)return;const i=[],r=[];let s=0;this.batchBuffer.forEach((n,o)=>{const{x:h,y:u,width:m,height:T,color:f,alpha:S}=n,C=h,R=u,O=h+m,x=u+T;i.push(C,R,0,0,f[0],f[1],f[2],S,O,R,1,0,f[0],f[1],f[2],S,O,x,1,1,f[0],f[1],f[2],S,C,x,0,1,f[0],f[1],f[2],S);const M=s;r.push(M,M+1,M+2,M,M+2,M+E.TRIANGLE_VERTEX_COUNT),s+=E.VERTICES_PER_QUAD}),e.bindBuffer(e.ARRAY_BUFFER,this.buffers.get("batch")),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffers.get("index")),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),e.DYNAMIC_DRAW);const a=E.FLOATS_PER_VERTEX*E.BYTES_PER_FLOAT;e.enableVertexAttribArray(t.locations.attributes.position),e.vertexAttribPointer(t.locations.attributes.position,2,e.FLOAT,!1,a,0),e.enableVertexAttribArray(t.locations.attributes.texCoord),e.vertexAttribPointer(t.locations.attributes.texCoord,2,e.FLOAT,!1,a,E.HEX_SLICE_START*E.BYTES_PER_FLOAT),e.enableVertexAttribArray(t.locations.attributes.color),e.vertexAttribPointer(t.locations.attributes.color,E.VERTICES_PER_QUAD,e.FLOAT,!1,a,E.VERTICES_PER_QUAD*E.BYTES_PER_FLOAT),e.uniform1i(t.locations.uniforms.useTexture,!1),e.drawElements(e.TRIANGLES,r.length,e.UNSIGNED_SHORT,0),this.batchBuffer=[]}parseColor(e){if(typeof e=="string"&&e.startsWith("#")){const t=e.slice(1);if(t.length===E.HEX_SHORT_LENGTH)return[parseInt(t[0]+t[0],E.HEX_RADIX)/E.COLOR_COMPONENT_MAX,parseInt(t[1]+t[1],E.HEX_RADIX)/E.COLOR_COMPONENT_MAX,parseInt(t[2]+t[2],E.HEX_RADIX)/E.COLOR_COMPONENT_MAX];if(t.length===E.HEX_LONG_LENGTH)return[parseInt(t.slice(0,E.HEX_SLICE_START),E.HEX_RADIX)/E.COLOR_COMPONENT_MAX,parseInt(t.slice(E.HEX_SLICE_START,E.HEX_SLICE_MID),E.HEX_RADIX)/E.COLOR_COMPONENT_MAX,parseInt(t.slice(E.HEX_SLICE_MID,E.HEX_SLICE_END),E.HEX_RADIX)/E.COLOR_COMPONENT_MAX]}return E.DEFAULT_COLOR}renderByType(e){this.addToBatch(e)}resize(){if(this.container&&this.canvas){const e=this.container.getBoundingClientRect();this.options.width=e.width,this.options.height=e.height,this.canvas.width=this.options.width*this.options.pixelRatio,this.canvas.height=this.options.height*this.options.pixelRatio,this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.setOrthographicProjection(0,this.options.width,this.options.height,0,-1,1),this.activeProgram&&this.gl.uniformMatrix4fv(this.activeProgram.locations.uniforms.projection,!1,this.projectionMatrix)}}createTexture(e){const{gl:t}=this,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),i}getInfo(){const{gl:e}=this;return{vendor:e.getParameter(e.VENDOR),renderer:e.getParameter(e.RENDERER),version:e.getParameter(e.VERSION),shadingLanguageVersion:e.getParameter(e.SHADING_LANGUAGE_VERSION),maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxVertexAttribs:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS)}}destroy(){this.gl&&(this.programs.forEach(e=>this.gl.deleteProgram(e)),this.buffers.forEach(e=>this.gl.deleteBuffer(e)),this.textures.forEach(e=>this.gl.deleteTexture(e))),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),d.info("WebGLRenderer: Destroyed")}}export{D as A,Ee as B,A as C,ge as E,Ae as I,pe as P,Te as S,fe as T,Ie as W,v as a,k as b,le as c,de as d,d as l,w as s,j as u};
//# sourceMappingURL=core-Bu-3NiyB.js.map
